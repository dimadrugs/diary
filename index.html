<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <title>–î–Ω–µ–≤–Ω–∏–∫</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000">
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="shortcut icon" href="icon.png">
  <style>
    :root{--bg:#000;--bg2:#1c1c1e;--bg3:#2c2c2e;--bg4:#3a3a3c;--card:#1c1c1e;--text:#fff;--t2:rgba(255,255,255,.7);--t3:rgba(255,255,255,.4);--t4:rgba(255,255,255,.12);--blue:#0a84ff;--green:#30d158;--orange:#ff9f0a;--red:#ff453a;--purple:#bf5af2;--r:14px;--rs:10px;--navH:50px}
    [data-theme="light"]{--bg:#f2f2f7;--bg2:#fff;--bg3:#e5e5ea;--bg4:#d1d1d6;--card:#fff;--text:#000;--t2:rgba(0,0,0,.6);--t3:rgba(0,0,0,.35);--t4:rgba(0,0,0,.08);--blue:#007aff;--green:#34c759;--orange:#ff9500;--red:#ff3b30;--purple:#af52de}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html{height:-webkit-fill-available}
    body{font-family:-apple-system,'SF Pro Display','Inter',BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:-webkit-fill-available;-webkit-font-smoothing:antialiased;overflow-x:hidden;transition:background .3s,color .3s}
    ::-webkit-scrollbar{width:0;height:0}

    /* LOADER */
    #loader{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .4s}
    #loader.hide{opacity:0;pointer-events:none}
    #loader img{width:72px;height:72px;border-radius:16px;margin-bottom:16px;animation:pulse 1.2s infinite}
    #loader .ldTxt{font-size:15px;color:var(--t3);font-weight:600}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(.92);opacity:.6}}
    .ldDots::after{content:'';animation:dots 1.5s infinite}
    @keyframes dots{0%{content:''}33%{content:'.'}66%{content:'..'}100%{content:'...'}}

    /* LOGIN */
    #loginPage{display:none;min-height:100vh;align-items:center;justify-content:center;padding:24px;background:var(--bg)}
    .loginCard{width:100%;max-width:360px;text-align:center}
    .loginCard .logo{width:64px;height:64px;border-radius:14px;margin:0 auto 16px}
    .loginCard h1{font-size:28px;font-weight:700;margin-bottom:4px}
    .loginCard .sub{color:var(--t3);font-size:15px;margin-bottom:32px}
    .errMsg{background:rgba(255,69,58,.15);color:var(--red);padding:12px;border-radius:var(--rs);margin-bottom:16px;font-size:14px;font-weight:600;display:none}
    .inp{width:100%;padding:16px;font-size:16px;background:var(--bg2);color:var(--text);border:1px solid var(--t4);border-radius:var(--r);font-family:inherit;outline:none;margin-bottom:12px;-webkit-appearance:none;transition:border-color .2s}
    .inp:focus{border-color:var(--blue)}
    textarea.inp{resize:vertical;min-height:80px}
    .btnP{width:100%;padding:16px;border:none;border-radius:var(--r);background:var(--blue);color:#fff;font-size:17px;font-weight:600;font-family:inherit;cursor:pointer;transition:opacity .15s}
    .btnP:active{opacity:.7}
    .btnS{width:100%;padding:16px;border:none;border-radius:var(--r);background:var(--bg2);color:var(--text);font-size:17px;font-weight:600;font-family:inherit;cursor:pointer;border:1px solid var(--t4);transition:opacity .15s}
    .btnS:active{opacity:.7}
    .btnD{width:100%;padding:16px;border:none;border-radius:var(--r);background:var(--red);color:#fff;font-size:17px;font-weight:600;font-family:inherit;cursor:pointer}
    .divLine{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--t3);font-size:13px}
    .divLine::before,.divLine::after{content:'';flex:1;height:1px;background:var(--t4)}

    /* APP */
    #appPage{display:none}

    /* TOP */
    .top{padding:8px 20px 10px;padding-top:calc(8px + env(safe-area-inset-top));position:sticky;top:0;z-index:50;background:var(--bg);transition:background .3s}
    .topRow{display:flex;justify-content:space-between;align-items:center}
    .topLeft{display:flex;align-items:center;gap:8px}
    .topLeft img{width:28px;height:28px;border-radius:6px}
    .topTitle{font-size:22px;font-weight:700;letter-spacing:-.3px}
    .topRight{display:flex;gap:8px;align-items:center}
    .pillBadge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700}
    .pillBadge.up{background:rgba(48,209,88,.15);color:var(--green)}
    .pillBadge.lo{background:rgba(255,69,58,.15);color:var(--red)}
    .circBtn{width:34px;height:34px;border-radius:50%;background:var(--bg2);border:none;color:var(--text);font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .1s}
    .circBtn:active{transform:scale(.9)}
    .topDate{font-size:12px;color:var(--t3);margin-top:2px;font-weight:500}

    /* POPUP MENU */
    .popMenuBg{position:fixed;inset:0;z-index:300;display:none}
    .popMenuBg.open{display:block}
    .popMenu{position:absolute;top:0;right:0;background:var(--bg2);border:1px solid var(--t4);border-radius:16px;padding:6px;min-width:200px;box-shadow:0 12px 40px rgba(0,0,0,.5);transform:scale(.3);opacity:0;transform-origin:top right;transition:transform .25s cubic-bezier(.34,1.56,.64,1),opacity .2s;pointer-events:none}
    .popMenu.open{transform:scale(1);opacity:1;pointer-events:all}
    [data-theme="light"] .popMenu{box-shadow:0 12px 40px rgba(0,0,0,.15)}
    .pmItem{display:flex;align-items:center;gap:10px;padding:12px 14px;font-size:15px;font-weight:600;color:var(--text);cursor:pointer;border:none;background:none;width:100%;text-align:left;font-family:inherit;border-radius:10px;transition:background .12s}
    .pmItem:active{background:var(--bg3)}
    .pmItem .pmI{font-size:18px;width:24px;text-align:center}
    .pmItem.red{color:var(--red)}
    .pmSep{height:1px;background:var(--t4);margin:4px 8px}
    .pmInfo{padding:10px 14px;font-size:12px;color:var(--t3)}

    /* WEEK STRIP */
    .weekBar{padding:6px 20px 12px}
    .weekRow{display:flex;align-items:center;gap:3px}
    .wArrow{width:30px;height:48px;flex-shrink:0;background:var(--bg2);border:none;border-radius:var(--rs);color:var(--t2);font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .1s}
    .wArrow:active{transform:scale(.9)}
    .dayChip{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 0 8px;border-radius:12px;cursor:pointer;transition:all .2s;position:relative;background:transparent;border:none;color:var(--text);font-family:inherit;min-width:0}
    .dayChip .dcD{font-size:10px;font-weight:700;color:var(--t3);text-transform:uppercase}
    .dayChip .dcN{font-size:17px;font-weight:700}
    .dayChip:active{transform:scale(.94)}
    .dayChip.sel{background:var(--blue);color:#fff}
    .dayChip.sel .dcD{color:rgba(255,255,255,.7)}
    .dayChip.today:not(.sel)::after{content:'';position:absolute;bottom:3px;width:4px;height:4px;border-radius:50%;background:var(--blue)}
    .dayChip .dcDot{position:absolute;top:2px;right:2px;width:5px;height:5px;border-radius:50%;background:var(--orange)}
    .weekLabel{text-align:center;padding:3px 0 0;font-size:11px;color:var(--t3);font-weight:600}
    .weekLabel span.up{color:var(--green)}
    .weekLabel span.lo{color:var(--red)}

    /* CONTENT */
    .content{padding:0 20px}
    .mobileContent{padding-bottom:calc(var(--navH) + env(safe-area-inset-bottom) + 12px)}
    .pg{display:none}
    .pg.on{display:block;animation:fadeUp .25s ease}
    @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    /* LESSONS */
    .lList{display:flex;flex-direction:column;gap:6px}
    .lCard{background:var(--card);border-radius:var(--r);padding:12px 14px;display:flex;gap:10px;border:1px solid var(--t4);cursor:pointer;transition:transform .12s;position:relative}
    .lCard:active{transform:scale(.98)}
    .lCard.empty{opacity:.3;cursor:default}
    .lCard.empty:active{transform:none}
    .lCard.changed{border-left:3px solid var(--orange)}
    .pairN{width:40px;height:48px;background:rgba(10,132,255,.1);border-radius:var(--rs);display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0}
    [data-theme="light"] .pairN{background:rgba(0,122,255,.08)}
    .pairN .pn{font-size:18px;font-weight:800;color:var(--blue)}
    .pairN .pt{font-size:8px;color:var(--t3);font-weight:600;margin-top:1px}
    .lBody{flex:1;min-width:0}
    .lName{font-size:15px;font-weight:700;margin-bottom:2px}
    .lMeta{display:flex;gap:8px;font-size:12px;color:var(--t2);flex-wrap:wrap}
    .lEmpty{color:var(--t3);font-size:13px}
    .lActions{position:absolute;top:8px;right:8px;display:flex;gap:3px}
    .miniBtn{padding:3px 7px;border-radius:6px;border:none;font-size:11px;font-weight:700;font-family:inherit;cursor:pointer;transition:opacity .15s}
    .miniBtn:active{opacity:.6}
    .miniBtn.bl{background:rgba(10,132,255,.15);color:var(--blue)}
    .miniBtn.gr{background:rgba(48,209,88,.15);color:var(--green)}
    .miniBtn.rd{background:rgba(255,69,58,.15);color:var(--red)}
    .miniBtn.og{background:rgba(255,159,10,.15);color:var(--orange)}

    .hwInline{margin-top:6px;padding:8px 10px;background:rgba(10,132,255,.06);border-radius:var(--rs);border-left:3px solid var(--blue)}
    [data-theme="light"] .hwInline{background:rgba(0,122,255,.04)}
    .hwInline.done{opacity:.4}
    .hwInline .hwHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}
    .hwInline .hwTag{font-size:9px;font-weight:700;text-transform:uppercase;color:var(--blue);letter-spacing:.3px}
    .hwInline .hwTxt{font-size:13px;line-height:1.4}
    .hwInline.done .hwTxt{text-decoration:line-through}
    .hwInline .hwBtns{display:flex;gap:3px}
    .hwInline .hwPhotos{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}
    .hwInline .hwPhotos img{width:48px;height:48px;object-fit:cover;border-radius:6px;cursor:pointer;border:1px solid var(--t4)}

    .pgHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;gap:8px;flex-wrap:wrap}
    .pgHead h2{font-size:20px;font-weight:700}
    .emptyBox{text-align:center;padding:50px 20px;color:var(--t3)}
    .emptyBox .eIcon{font-size:44px;margin-bottom:8px;opacity:.5}
    .emptyBox .eTxt{font-size:14px}

    /* EVENTS */
    .evCard{background:var(--card);border-radius:var(--r);padding:14px;border:1px solid var(--t4);border-left:3px solid var(--orange);margin-bottom:8px}
    .evCard.blue{border-left-color:var(--blue)}
    .evCard .evT{font-size:14px;font-weight:700;margin-bottom:3px}
    .evCard .evD{font-size:12px;color:var(--t3);margin-bottom:4px}
    .evCard .evDesc{font-size:13px;line-height:1.4;color:var(--t2)}

    /* GRADES */
    .gradeTabs{display:flex;gap:3px;margin-bottom:14px;background:var(--bg2);border-radius:var(--rs);padding:3px}
    .gradeTab{flex:1;padding:9px;border:none;border-radius:7px;background:transparent;color:var(--t3);font-size:13px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .2s;text-align:center}
    .gradeTab.on{background:var(--blue);color:#fff}
    .gradeContent{display:none}
    .gradeContent.on{display:block;animation:fadeUp .2s ease}
    .futurePlaceholder{text-align:center;padding:50px 20px}
    .futurePlaceholder .fpIcon{font-size:48px;margin-bottom:10px}
    .futurePlaceholder h3{font-size:18px;font-weight:700;margin-bottom:6px}
    .futurePlaceholder p{font-size:13px;color:var(--t3);line-height:1.5;max-width:260px;margin:0 auto}

    /* HW CARDS */
    .hwCard{background:var(--card);border-radius:var(--r);padding:14px;border:1px solid var(--t4);border-left:3px solid var(--blue);margin-bottom:8px}
    .hwCard .hwSubj{font-size:14px;font-weight:700;color:var(--blue);margin-bottom:3px}
    .hwCard .hwDue{font-size:11px;color:var(--t3);margin-bottom:8px}
    .hwCard .hwTask{font-size:13px;line-height:1.5;padding:8px;background:var(--bg2);border-radius:var(--rs);margin-bottom:8px}
    .hwCard .hwActs{display:flex;gap:6px}
    .hwCard .hwPhotos{display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap}
    .hwCard .hwPhotos img{width:64px;height:64px;object-fit:cover;border-radius:6px;cursor:pointer;border:1px solid var(--t4)}

    /* SUBJ/CHG/SET */
    .sjRow{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--card);border-radius:var(--r);border:1px solid var(--t4);margin-bottom:6px}
    .sjRow .sjIcon{width:36px;height:36px;border-radius:var(--rs);background:rgba(10,132,255,.1);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
    .sjRow .sjInfo{flex:1;min-width:0}
    .sjRow .sjN{font-weight:700;font-size:14px}
    .sjRow .sjM{font-size:12px;color:var(--t2)}
    .chgCard{background:var(--card);border-radius:var(--r);padding:14px;border:1px solid var(--t4);border-left:3px solid var(--orange);margin-bottom:8px}
    .chgCard .chHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:4px}
    .chgCard .chDate{font-weight:700;color:var(--orange);font-size:14px}
    .chgLesson{display:flex;gap:6px;align-items:center;padding:6px;background:var(--bg2);border-radius:var(--rs);margin-bottom:3px}
    .chgLesson .clN{width:22px;height:22px;border-radius:5px;background:rgba(255,159,10,.15);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:11px;color:var(--orange);flex-shrink:0}
    .setRow{display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--card);border-radius:var(--r);border:1px solid var(--t4);margin-bottom:6px;gap:10px;flex-wrap:wrap}
    .setRow h4{font-size:14px;font-weight:700}
    .setRow p{font-size:12px;color:var(--t3)}

    /* BOTTOM NAV (mobile only) */
    .bnav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--navH) + env(safe-area-inset-bottom));padding-bottom:env(safe-area-inset-bottom);background:var(--bg2);border-top:1px solid var(--t4);display:flex;z-index:100}
    [data-theme="light"] .bnav{background:rgba(255,255,255,.94);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
    .bnavBtn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;border:none;background:none;color:var(--t3);font-size:10px;font-weight:600;font-family:inherit;cursor:pointer;padding:0;position:relative;transition:color .15s}
    .bnavBtn .bi{font-size:22px;transition:transform .12s}
    .bnavBtn:active .bi{transform:scale(.85)}
    .bnavBtn.on{color:var(--blue)}

    /* SHEETS */
    .sheet{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:none;align-items:flex-end;justify-content:center}
    [data-theme="light"] .sheet{background:rgba(0,0,0,.3)}
    .sheet.open{display:flex}
    .sheetBox{background:var(--bg2);width:100%;max-width:500px;border-radius:20px 20px 0 0;padding:0 20px calc(20px + env(safe-area-inset-bottom));max-height:90vh;overflow-y:auto;animation:shUp .3s cubic-bezier(.32,.72,0,1)}
    @keyframes shUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .shHandle{width:36px;height:4px;background:var(--t4);border-radius:2px;margin:10px auto 14px}
    .sheetBox h3{font-size:18px;font-weight:700;margin-bottom:14px}
    .shBtns{display:flex;gap:6px;margin-top:16px;padding-bottom:6px}
    .shBtns .btnP,.shBtns .btnS,.shBtns .btnD{flex:1;padding:13px;font-size:15px}

    .csTrig{display:flex;align-items:center;gap:8px;padding:12px 14px;background:var(--bg3);border:1px solid var(--t4);border-radius:var(--r);cursor:pointer;min-height:48px;transition:border-color .2s}
    .csTrig.open{border-color:var(--blue);border-radius:var(--r) var(--r) 0 0}
    .csTrig .csI{width:28px;height:28px;border-radius:7px;background:rgba(10,132,255,.1);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
    .csTrig .csTxt{flex:1}
    .csTrig .csN{font-weight:700;font-size:13px}
    .csTrig .csM{font-size:11px;color:var(--t3)}
    .csTrig .csPh{color:var(--t3);font-size:13px}
    .csTrig .csArr{color:var(--t3);font-size:9px;transition:transform .2s}
    .csTrig.open .csArr{transform:rotate(180deg)}
    .csDd{position:absolute;top:100%;left:0;right:0;background:var(--bg2);border:1px solid var(--blue);border-top:1px solid var(--t4);border-radius:0 0 var(--r) var(--r);max-height:180px;overflow-y:auto;z-index:50;display:none;box-shadow:0 12px 40px rgba(0,0,0,.3)}
    .csDd.open{display:block}
    .csOpt{display:flex;align-items:center;gap:8px;padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--t4);transition:background .1s}
    .csOpt:last-child{border:none}
    .csOpt:active{background:var(--bg3)}
    .csOpt.on{background:rgba(10,132,255,.08)}
    .csOpt .coI{width:24px;height:24px;border-radius:6px;background:rgba(10,132,255,.1);display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0}
    .csOpt .coN{font-weight:700;font-size:13px}
    .csOpt .coM{font-size:10px;color:var(--t3)}
    .csOpt.emp .coI{background:rgba(255,69,58,.1)}
    .csWrap{position:relative;width:100%}
    .cpBlk{background:var(--bg3);border-radius:var(--rs);padding:10px;margin-bottom:6px}
    .cpBlk .cpHead{display:flex;align-items:center;gap:6px;margin-bottom:6px}
    .cpBlk .cpN{width:22px;height:22px;border-radius:5px;background:rgba(10,132,255,.1);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:11px;color:var(--blue)}

    .photoUploadArea{margin-top:6px}
    .photoUploadBtn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:var(--bg3);border:1px dashed var(--t4);border-radius:var(--rs);color:var(--t2);font-size:13px;font-weight:600;cursor:pointer}
    .photoPreview{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
    .photoPreview .ppItem{position:relative;width:60px;height:60px}
    .photoPreview .ppItem img{width:100%;height:100%;object-fit:cover;border-radius:6px;border:1px solid var(--t4)}
    .photoPreview .ppRm{position:absolute;top:-3px;right:-3px;width:18px;height:18px;border-radius:50%;background:var(--red);color:#fff;border:none;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;cursor:pointer}

    .imgViewer{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:600;display:none;align-items:center;justify-content:center;cursor:pointer}
    .imgViewer.open{display:flex}
    .imgViewer img{max-width:95%;max-height:90vh;border-radius:8px;object-fit:contain}

    .admH{display:none !important}

    /* === DESKTOP LAYOUT === */
    @media(min-width:900px){
      .bnav{display:none!important}
      .mobileContent{padding-bottom:20px!important}
      .top .topRow{max-width:1100px;margin:0 auto}
      .weekBar{display:none!important}
      #appPage .content{max-width:1100px;padding:0 24px}

      .deskLayout{display:flex;gap:20px;align-items:flex-start}
      .deskMain{flex:1;min-width:0}
      .deskSide{width:300px;flex-shrink:0;position:sticky;top:calc(70px + env(safe-area-inset-top))}

      .deskNav{display:flex;flex-direction:column;gap:4px;margin-bottom:16px;background:var(--card);border-radius:var(--r);padding:6px;border:1px solid var(--t4)}
      .deskNavBtn{display:flex;align-items:center;gap:8px;padding:10px 12px;border:none;background:none;border-radius:var(--rs);font-size:14px;font-weight:600;color:var(--t2);cursor:pointer;font-family:inherit;width:100%;text-align:left;transition:background .15s}
      .deskNavBtn:hover{background:var(--bg3)}
      .deskNavBtn.on{background:var(--blue);color:#fff}
      .deskNavBtn .dnI{font-size:18px;width:24px;text-align:center}

      .miniCal{background:var(--card);border-radius:var(--r);padding:14px;border:1px solid var(--t4);margin-bottom:16px}
      .miniCal .mcHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
      .miniCal .mcTitle{font-size:15px;font-weight:700}
      .miniCal .mcArrows{display:flex;gap:4px}
      .miniCal .mcArrow{width:28px;height:28px;border-radius:50%;background:var(--bg3);border:none;color:var(--text);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
      .miniCal .mcGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center}
      .miniCal .mcDayH{font-size:10px;font-weight:700;color:var(--t3);padding:4px 0;text-transform:uppercase}
      .miniCal .mcDay{font-size:12px;padding:6px 2px;border-radius:6px;cursor:pointer;font-weight:600;color:var(--t2);transition:background .15s}
      .miniCal .mcDay:hover{background:var(--bg3)}
      .miniCal .mcDay.today{background:var(--blue);color:#fff}
      .miniCal .mcDay.sel{background:rgba(10,132,255,.2);color:var(--blue)}
      .miniCal .mcDay.other{opacity:.25}

      .deskWeekHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
      .deskWeekHeader h2{font-size:20px;font-weight:700}
      .deskWeekHeader .dwBadge{font-size:12px;font-weight:700;padding:4px 10px;border-radius:16px}
      .deskWeekHeader .dwBadge.up{background:rgba(48,209,88,.15);color:var(--green)}
      .deskWeekHeader .dwBadge.lo{background:rgba(255,69,58,.15);color:var(--red)}

      .deskWeekGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
      .deskDayCol{background:var(--card);border-radius:var(--r);border:1px solid var(--t4);overflow:hidden}
      .deskDayCol.today{border-color:var(--blue)}
      .deskDayCol.has-ch{border-color:var(--orange)}
      .ddcHead{padding:10px 12px;background:var(--bg3);border-bottom:1px solid var(--t4);display:flex;justify-content:space-between;align-items:center}
      .ddcHead .ddcDay{font-size:13px;font-weight:700}
      .ddcHead .ddcDate{font-size:11px;color:var(--t3)}
      .ddcHead .ddcBadge{font-size:9px;padding:2px 6px;border-radius:8px;font-weight:700}
      .ddcBody{padding:6px}
      .ddcLesson{padding:6px 8px;border-radius:8px;margin-bottom:4px;cursor:pointer;transition:background .12s}
      .ddcLesson:hover{background:var(--bg3)}
      .ddcLesson.empty{opacity:.25}
      .ddcLesson.changed{border-left:2px solid var(--orange);padding-left:6px}
      .ddcLesson .ddcPN{font-size:10px;font-weight:800;color:var(--blue);margin-bottom:1px}
      .ddcLesson .ddcLN{font-size:12px;font-weight:700}
      .ddcLesson .ddcLM{font-size:10px;color:var(--t3)}
      .ddcLesson .ddcEmpty{font-size:11px;color:var(--t3)}
    }

    @media(max-width:899px){
      .deskLayout,.deskSide,.deskNav,.miniCal,.deskWeekHeader,.deskWeekGrid{display:none!important}
    }

    @media(max-width:380px){
      .topTitle{font-size:20px}
      .dayChip .dcN{font-size:15px}
    }
  </style>
</head>
<body>

<!-- LOADER -->
<div id="loader">
  <img src="icon.png" alt="Loading">
  <div class="ldTxt">–ó–∞–≥—Ä—É–∑–∫–∞<span class="ldDots"></span></div>
</div>

<!-- LOGIN -->
<div id="loginPage">
  <div class="loginCard">
    <img src="icon.png" class="logo" alt="Logo">
    <h1>–î–Ω–µ–≤–Ω–∏–∫</h1>
    <p class="sub">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</p>
    <div class="errMsg" id="errMsg"></div>
    <input class="inp" type="email" id="iEmail" placeholder="Email" autocomplete="email">
    <input class="inp" type="password" id="iPass" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
    <button class="btnP" onclick="doLogin()">–í–æ–π—Ç–∏</button>
    <div class="divLine">–∏–ª–∏</div>
    <button class="btnS" onclick="guestIn()">–ì–æ—Å—Ç–µ–≤–æ–π –≤—Ö–æ–¥</button>
  </div>
</div>

<!-- APP -->
<div id="appPage">
  <div class="top">
    <div class="topRow">
      <div class="topLeft"><img src="icon.png" alt=""><div class="topTitle">–î–Ω–µ–≤–Ω–∏–∫</div></div>
      <div class="topRight">
        <span class="pillBadge" id="topBadge"></span>
        <button class="circBtn" id="menuAnchor" onclick="togPopMenu()">‚ò∞</button>
      </div>
    </div>
    <div class="topDate" id="topDate"></div>
  </div>

  <!-- POPUP MENU -->
  <div class="popMenuBg" id="popMenuBg" onclick="closePopMenu()"></div>
  <div class="popMenu" id="popMenu">
    <div class="pmInfo" id="pmInfo"></div>
    <button class="pmItem" onclick="goPage('pgGrades');closePopMenu()"><span class="pmI">üìä</span>–û—Ü–µ–Ω–∫–∏</button>
    <button class="pmItem" onclick="goPage('pgChat');closePopMenu()"><span class="pmI">üí¨</span>–ß–∞—Ç</button>
    <div class="pmSep"></div>
    <button class="pmItem admH" onclick="goPage('pgChg');closePopMenu()"><span class="pmI">üîÑ</span>–ó–∞–º–µ–Ω—ã</button>
    <button class="pmItem admH" onclick="goPage('pgSubj');closePopMenu()"><span class="pmI">üìñ</span>–ü—Ä–µ–¥–º–µ—Ç—ã</button>
    <button class="pmItem" onclick="goPage('pgSet');closePopMenu()"><span class="pmI">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <div class="pmSep"></div>
    <button class="pmItem red" onclick="doLogout()"><span class="pmI">üö™</span>–í—ã–π—Ç–∏</button>
  </div>

  <!-- MOBILE WEEK STRIP -->
  <div class="weekBar" id="weekBar">
    <div class="weekRow" id="weekRow"></div>
    <div class="weekLabel" id="weekLabel"></div>
  </div>

  <div class="content mobileContent">
    <!-- DESKTOP LAYOUT -->
    <div class="deskLayout" id="deskLayout">
      <div class="deskMain">
        <div class="deskWeekHeader" id="deskWeekHeader"></div>
        <div class="deskWeekGrid" id="deskWeekGrid"></div>
        <!-- other pages render here on desktop too -->
        <div id="deskPgArea"></div>
      </div>
      <div class="deskSide">
        <div class="deskNav" id="deskNav">
          <button class="deskNavBtn on" data-dpg="sched"><span class="dnI">üìÖ</span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
          <button class="deskNavBtn" data-dpg="pgEvents"><span class="dnI">üìå</span>–°–æ–±—ã—Ç–∏—è</button>
          <button class="deskNavBtn" data-dpg="pgGrades"><span class="dnI">üìä</span>–û—Ü–µ–Ω–∫–∏</button>
          <button class="deskNavBtn" data-dpg="pgChat"><span class="dnI">üí¨</span>–ß–∞—Ç</button>
          <button class="deskNavBtn admH" data-dpg="pgHw"><span class="dnI">üìù</span>–î–ó</button>
          <button class="deskNavBtn admH" data-dpg="pgChg"><span class="dnI">üîÑ</span>–ó–∞–º–µ–Ω—ã</button>
          <button class="deskNavBtn admH" data-dpg="pgSubj"><span class="dnI">üìñ</span>–ü—Ä–µ–¥–º–µ—Ç—ã</button>
          <button class="deskNavBtn" data-dpg="pgSet"><span class="dnI">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
        <div class="miniCal" id="miniCal"></div>
      </div>
    </div>

    <!-- MOBILE PAGES -->
    <div class="pg on" id="pgSched"><div class="lList" id="lList"></div></div>
    <div class="pg" id="pgEvents"><div class="pgHead"><h2>–°–æ–±—ã—Ç–∏—è</h2></div><div id="eventsList"></div></div>
    <div class="pg" id="pgGrades">
      <div class="pgHead"><h2>–û—Ü–µ–Ω–∫–∏</h2></div>
      <div class="gradeTabs"><button class="gradeTab on" onclick="switchGT(0)">–ñ—É—Ä–Ω–∞–ª</button><button class="gradeTab" onclick="switchGT(1)">–ó–∞—á—ë—Ç–∫–∞</button></div>
      <div class="gradeContent on" id="gradeJ"><div class="futurePlaceholder"><div class="fpIcon">üìä</div><h3>–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫</h3><p>–û—Ü–µ–Ω–∫–∏ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º –ø–æ—è–≤—è—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏</p></div></div>
      <div class="gradeContent" id="gradeR"><div class="futurePlaceholder"><div class="fpIcon">üìã</div><h3>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –∑–∞—á—ë—Ç–∫–∞</h3><p>–ó–∞—á—ë—Ç—ã, —ç–∫–∑–∞–º–µ–Ω—ã –∏ –∫—É—Ä—Å–æ–≤—ã–µ ‚Äî —Å–∫–æ—Ä–æ –∑–¥–µ—Å—å</p></div></div>
    </div>
    <div class="pg" id="pgHw"><div class="pgHead"><h2>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2><button class="btnP admH" onclick="openNewHw()" style="padding:8px 14px;font-size:13px;width:auto">+ –î–æ–±–∞–≤–∏—Ç—å</button></div><div id="hwList"></div></div>
    <div class="pg" id="pgChat"><div class="futurePlaceholder"><div class="fpIcon">üí¨</div><h3>–ß–∞—Ç –≥—Ä—É–ø–ø—ã</h3><p>–û–±—â–µ–Ω–∏–µ —Å –æ–¥–Ω–æ–≥—Ä—É–ø–ø–Ω–∏–∫–∞–º–∏ –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º–∏. –°–∫–æ—Ä–æ!</p></div></div>
    <div class="pg admH" id="pgChg"><div class="pgHead"><h2>–ó–∞–º–µ–Ω—ã</h2><button class="btnP" onclick="openChgM()" style="padding:8px 14px;font-size:13px;width:auto">+ –î–æ–±–∞–≤–∏—Ç—å</button></div><div id="chgList"></div></div>
    <div class="pg admH" id="pgSubj"><div class="pgHead"><h2>–ü—Ä–µ–¥–º–µ—Ç—ã</h2><button class="btnP" onclick="openSjM()" style="padding:8px 14px;font-size:13px;width:auto">+ –î–æ–±–∞–≤–∏—Ç—å</button></div><div id="sjList"></div></div>
    <div class="pg" id="pgSet">
      <h2 style="margin-bottom:14px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <div class="setRow"><div><h4>–¢–µ–º–∞</h4><p>–°–≤–µ—Ç–ª–∞—è / —Ç—ë–º–Ω–∞—è</p></div><button class="btnS" onclick="togTheme()" style="width:auto;padding:8px 14px;font-size:13px">–°–º–µ–Ω–∏—Ç—å</button></div>
      <div class="setRow admH"><div><h4>–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª—å</h4></div><input type="date" class="inp" id="cfgWS" style="width:auto;margin:0;padding:8px"></div>
      <div class="setRow admH"><div><h4>–í—Ä–µ–º—è –ø–∞—Ä</h4></div><button class="btnS" onclick="openTimesM()" style="width:auto;padding:8px 14px;font-size:13px">–ò–∑–º–µ–Ω–∏—Ç—å</button></div>
      <div class="setRow admH"><div><h4>–û—á–∏—Å—Ç–∏—Ç—å</h4></div><button class="btnD" onclick="clearAll()" style="width:auto;padding:8px 14px;font-size:13px">–û—á–∏—Å—Ç–∏—Ç—å</button></div>
    </div>
  </div>

  <!-- MOBILE BOTTOM NAV -->
  <nav class="bnav">
    <button class="bnavBtn on" data-pg="pgSched"><span class="bi">üìÖ</span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
    <button class="bnavBtn" data-pg="pgEvents"><span class="bi">üìå</span>–°–æ–±—ã—Ç–∏—è</button>
    <button class="bnavBtn" data-pg="pgGrades"><span class="bi">üìä</span>–û—Ü–µ–Ω–∫–∏</button>
  </nav>
</div>

<div class="imgViewer" id="imgViewer" onclick="this.classList.remove('open')"><img id="imgViewerSrc"></div>

<!-- SHEETS -->
<div class="sheet" id="shLesson"><div class="sheetBox"><div class="shHandle"></div><h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—É</h3><input type="hidden" id="elD"><input type="hidden" id="elP"><input type="hidden" id="elW"><div style="margin-bottom:10px"><label style="display:block;font-size:12px;font-weight:600;color:var(--t2);margin-bottom:4px">–ü—Ä–µ–¥–º–µ—Ç</label><div id="elSel"></div></div><div class="shBtns"><button class="btnS" onclick="closeS('shLesson')">–û—Ç–º–µ–Ω–∞</button><button class="btnD" onclick="rmLesson()">–£–±—Ä–∞—Ç—å</button><button class="btnP" onclick="svLesson()">–û–∫</button></div></div></div>

<div class="sheet" id="shHwI"><div class="sheetBox"><div class="shHandle"></div><h3>–î–æ–º–∞—à–∫–∞</h3><input type="hidden" id="hiD"><input type="hidden" id="hiP"><div style="margin-bottom:10px"><label style="display:block;font-size:12px;font-weight:600;color:var(--t2);margin-bottom:4px">–ü—Ä–µ–¥–º–µ—Ç</label><input class="inp" id="hiS" readonly style="opacity:.5;margin:0"></div><div style="margin-bottom:10px"><label style="display:block;font-size:12px;font-weight:600;color:var(--t2);margin-bottom:4px">–ó–∞–¥–∞–Ω–∏–µ</label><textarea class="inp" id="hiT" placeholder="–ß—Ç–æ –∑–∞–¥–∞–ª–∏..." style="margin:0"></textarea></div><div><label style="display:block;font-size:12px;font-weight:600;color:var(--t2);margin-bottom:4px">–§–æ—Ç–æ</label><div class="photoUploadArea"><label class="photoUploadBtn"><input type="file" accept="image/*" multiple hidden onchange="addPh(this,'hiPh')">üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</label><div class="photoPreview" id="hiPh"></div></div></div><div class="shBtns"><button class="btnS" onclick="closeS('shHwI')">–û—Ç–º–µ–Ω–∞</button><button class="btnP" onclick="svHwI()">–û–∫</button></div></div></div>

<div class="sheet" id="shNewHw"><div class="sheetBox"><div class="shHandle"></div><h3>–ù–æ–≤–æ–µ –î–ó</h3><div style="margin-bottom:10px"><label style="display:block;font-size:12px;font-weight:600;color:var(--t2);margin-bottom:4px">–ü—Ä–µ–¥–º–µ—Ç</label><div id="nhSel"></div></div><div style="margin-bottom:10px"><label style="display:block;font-size:12px;font-weight:600;color:var(--t2);margin-bottom:4px">–ó–∞–¥–∞–Ω–∏–µ</label><textarea class="inp" id="nhT" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." style="margin:0"></textarea></div><div style="margin-bottom:10px"><label style="display:block;font-size:12px;font-weight:600;color:var(--t2);margin-bottom:4px">–§–æ—Ç–æ</label><div class="photoUploadArea"><label class="photoUploadBtn"><input type="file" accept="image/*" multiple hidden onchange="addPh(this,'nhPh')">üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</label><div class="photoPreview" id="nhPh"></div></div></div><div><label style="display:block;font-size:12px;font-weight:600;color:var(--t2);margin-bottom:4px">–ë–ª–∏–∂–∞–π—à–∞—è –ø–∞—Ä–∞</label><div id="nhNext" style="padding:12px;background:var(--bg3);border-radius:var(--rs);font-size:13px;color:var(--t3)">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</div></div><div class="shBtns"><button class="btnS" onclick="closeS('shNewHw')">–û—Ç–º–µ–Ω–∞</button><button class="btnP" onclick="svNewHw()">–û–∫</button></div></div></div>

<div class="sheet" id="shSubj"><div class="sheetBox"><div class="shHandle"></div><h3 id="sjTitle">–î–æ–±–∞–≤–∏—Ç—å</h3><input type="hidden" id="sjId"><input class="inp" id="sjN" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><input class="inp" id="sjR" placeholder="–ê—É–¥–∏—Ç–æ—Ä–∏—è"><input class="inp" id="sjTch" placeholder="–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å"><div class="shBtns"><button class="btnS" onclick="closeS('shSubj')">–û—Ç–º–µ–Ω–∞</button><button class="btnP" onclick="svSubj()">–û–∫</button></div></div></div>

<div class="sheet" id="shChg"><div class="sheetBox"><div class="shHandle"></div><h3>–ó–∞–º–µ–Ω–∞</h3><input type="hidden" id="ceId"><input class="inp" type="date" id="ceDate" style="margin-bottom:6px"><p style="font-size:12px;color:var(--t3);margin-bottom:10px">–ó–∞–º–µ–Ω–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É</p><div id="cePairs"></div><div class="shBtns"><button class="btnS" onclick="closeS('shChg')">–û—Ç–º–µ–Ω–∞</button><button class="btnD" id="ceDel" onclick="rmChg()" style="display:none">–£–¥–∞–ª–∏—Ç—å</button><button class="btnP" onclick="svChg()">–û–∫</button></div></div></div>

<div class="sheet" id="shTimes"><div class="sheetBox"><div class="shHandle"></div><h3>–í—Ä–µ–º—è –ø–∞—Ä</h3><div id="timesF"></div><div class="shBtns"><button class="btnS" onclick="closeS('shTimes')">–û—Ç–º–µ–Ω–∞</button><button class="btnP" onclick="svTimes()">–û–∫</button></div></div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
const isDesk=()=>window.innerWidth>=900;
function initTh(){setTh(localStorage.getItem('th')||(matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'))}
function setTh(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('th',t);document.querySelector('meta[name="theme-color"]').content=t==='dark'?'#000':'#f2f2f7'}
function togTheme(){setTh(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark')}
initTh();

firebase.initializeApp({apiKey:"AIzaSyBCy0hz_PHMGUX2M52Wnwb0C9nEnBBfeq8",authDomain:"my-diary-e223c.firebaseapp.com",databaseURL:"https://my-diary-e223c-default-rtdb.firebaseio.com",projectId:"my-diary-e223c",storageBucket:"my-diary-e223c.firebasestorage.app",messagingSenderId:"903986378920",appId:"1:903986378920:web:b6ebc6691f6d767f78aa9d"});
const au=firebase.auth(),db=firebase.database();
au.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

const ADM=["zFKU6TAgIuhZetCOuWpHvDDw6Oj2"];
const DK=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'],DL=['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
let cU=null,isA=false,isG=false;
let sc={upper:{},lower:{}},hw=[],ch=[],nh=[],sj=[];
let cf={weekStartDate:null,pairTimes:[{start:'08:30',end:'10:00'},{start:'10:10',end:'11:40'},{start:'12:10',end:'13:40'},{start:'13:50',end:'15:20'},{start:'15:30',end:'17:00'}]};
let vM=gMon(new Date()),sD=tIdx(),csS={},uPh={hiPh:[],nhPh:[]},calMonth=new Date();

function gMon(d){const r=new Date(d);r.setHours(12,0,0,0);const w=r.getDay();r.setDate(r.getDate()-w+(w===0?-6:1));return r}
function fk(d){const r=new Date(d);return`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,'0')}-${String(r.getDate()).padStart(2,'0')}`}
function pk(s){const[y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d,12)}
function fShort(d){return new Date(d).toLocaleDateString('ru-RU',{day:'numeric',month:'short'})}
function fFull(d){return new Date(d).toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'})}
function tIdx(){const w=new Date().getDay();return w===0?5:(w-1)}
function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML}
function gwt(m){if(!cf.weekStartDate){const s=new Date(m.getFullYear(),0,1);return Math.ceil(((m-s)/864e5+s.getDay()+1)/7)%2===1?'upper':'lower'}const sd=gMon(pk(cf.weekStartDate));return Math.floor(Math.round((m-sd)/864e5)/7)%2===0?'upper':'lower'}
function lesFor(dk){const d=pk(dk),dow=d.getDay();if(dow===0)return{};const di=dow-1;if(di>5)return{};const c=ch.find(x=>x.date===dk);if(c)return c.lessons||{};return(sc[gwt(gMon(d))]||{})[DK[di]]||{}}
function findNx(subj){const td=new Date();td.setHours(0,0,0,0);for(let o=1;o<=60;o++){const d=new Date(td);d.setDate(d.getDate()+o);const dow=d.getDay();if(dow===0||dow>6)continue;const dk=fk(d),ls=lesFor(dk);for(let p=1;p<=5;p++){const l=ls[p];if(l&&l.name&&l.name.toLowerCase().trim()===subj.toLowerCase().trim())return{date:dk,pair:p}}}return null}
function recalc(){if(!isA)return;nh.forEach(h=>{if(h.done||!h.subject)return;const n=findNx(h.subject);if(n&&(n.date!==h.targetDate||n.pair!==h.targetPair))db.ref(`newHomework/${h.id}`).update({targetDate:n.date,targetPair:n.pair})})}

/* AUTH */
let authReady=false;
au.onAuthStateChanged(u=>{authReady=true;if(u){cU=u;isA=ADM.includes(u.uid);isG=false;boot()}else if(localStorage.getItem('gs')){isG=true;boot()}else{hideLoader();document.getElementById('loginPage').style.display='flex'}});
setTimeout(()=>{if(!authReady){hideLoader();document.getElementById('loginPage').style.display='flex'}},4000);

function hideLoader(){const l=document.getElementById('loader');l.classList.add('hide');setTimeout(()=>l.style.display='none',500)}
function doLogin(){const e=document.getElementById('iEmail').value.trim(),p=document.getElementById('iPass').value;if(!e||!p){shErr('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');return}au.signInWithEmailAndPassword(e,p).catch(()=>shErr('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'))}
function shErr(m){const e=document.getElementById('errMsg');e.textContent=m;e.style.display='block'}
function guestIn(){isG=true;isA=false;cU=null;localStorage.setItem('gs','1');boot()}
function doLogout(){localStorage.removeItem('gs');closePopMenu();au.signOut().then(()=>{isG=false;isA=false;cU=null;document.getElementById('appPage').style.display='none';document.getElementById('loginPage').style.display='flex'})}

function boot(){
  document.getElementById('loginPage').style.display='none';
  document.getElementById('appPage').style.display='block';
  document.getElementById('pmInfo').innerHTML=(isG?'–ì–æ—Å—Ç—å':esc(cU?.email||''))+(isA?' <span style="background:var(--blue);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:800;margin-left:4px">–ê–¥–º–∏–Ω</span>':'');
  if(isA)document.querySelectorAll('.admH').forEach(e=>e.classList.remove('admH'));
  setupNav();loadData();sD=tIdx();vM=gMon(new Date());updAll();
  setTimeout(hideLoader,300);
}

/* POPUP MENU */
function togPopMenu(){
  const bg=document.getElementById('popMenuBg'),pm=document.getElementById('popMenu'),anc=document.getElementById('menuAnchor');
  const isOpen=pm.classList.contains('open');
  if(isOpen){closePopMenu();return}
  const r=anc.getBoundingClientRect();
  pm.style.top=(r.bottom+6)+'px';
  pm.style.right=(window.innerWidth-r.right)+'px';
  bg.classList.add('open');pm.classList.add('open');
}
function closePopMenu(){document.getElementById('popMenuBg').classList.remove('open');document.getElementById('popMenu').classList.remove('open')}

/* NAV */
function setupNav(){
  document.querySelectorAll('.bnavBtn').forEach(b=>b.addEventListener('click',()=>{goPage(b.dataset.pg);document.querySelectorAll('.bnavBtn').forEach(x=>x.classList.remove('on'));b.classList.add('on')}));
  document.querySelectorAll('.deskNavBtn').forEach(b=>b.addEventListener('click',()=>{
    document.querySelectorAll('.deskNavBtn').forEach(x=>x.classList.remove('on'));b.classList.add('on');
    const p=b.dataset.dpg;
    if(p==='sched'){showDeskSched();hideMobilePages()}else{hideDeskSched();goPage(p)}
  }));
}

function goPage(id){
  document.querySelectorAll('.pg').forEach(x=>x.classList.remove('on'));
  document.getElementById(id).classList.add('on');
  const isSch=id==='pgSched';
  document.getElementById('weekBar').style.display=isSch?'':'none';
  document.querySelectorAll('.bnavBtn').forEach(b=>b.classList.toggle('on',b.dataset.pg===id));
  if(isDesk()){if(isSch){showDeskSched()}else{hideDeskSched()}}
}

function showDeskSched(){document.getElementById('deskWeekHeader').style.display='';document.getElementById('deskWeekGrid').style.display='';rDeskWeek()}
function hideDeskSched(){document.getElementById('deskWeekHeader').style.display='none';document.getElementById('deskWeekGrid').style.display='none'}
function hideMobilePages(){document.querySelectorAll('.pg').forEach(x=>x.classList.remove('on'))}

function switchGT(i){document.querySelectorAll('.gradeTab').forEach((t,idx)=>t.classList.toggle('on',idx===i));document.querySelectorAll('.gradeContent').forEach((c,idx)=>c.classList.toggle('on',idx===i))}

/* DATA */
function loadData(){
  db.ref('settings').on('value',s=>{if(s.val()){cf={...cf,...s.val()};const w=document.getElementById('cfgWS');if(cf.weekStartDate&&w)w.value=cf.weekStartDate}updAll()});
  db.ref('schedule').on('value',s=>{sc=s.val()||{upper:{},lower:{}};render();rDeskWeek();recalc()});
  db.ref('homework').on('value',s=>{const d=s.val();hw=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];render();rDeskWeek()});
  db.ref('subjects').on('value',s=>{const d=s.val();sj=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];rSubj();render();rDeskWeek()});
  db.ref('newHomework').on('value',s=>{const d=s.val();nh=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];rHwPg();render();rEvents();rDeskWeek()});
  db.ref('changes').on('value',s=>{const d=s.val();ch=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];cleanOld();render();rStrip();rChg();rEvents();rDeskWeek();recalc()});
  const w=document.getElementById('cfgWS');if(w)w.addEventListener('change',e=>{if(isA)db.ref('settings/weekStartDate').set(e.target.value)});
}
function cleanOld(){if(!isA)return;const tk=fk(new Date());ch.forEach(c=>{if(c.date<tk)db.ref(`changes/${c.id}`).remove()})}
function updAll(){updTop();rStrip();render();rEvents();if(isDesk()){rDeskWeek();rMiniCal()}}

function updTop(){const t=new Date(),wt=gwt(gMon(t));document.getElementById('topDate').textContent=fFull(t);const b=document.getElementById('topBadge');b.textContent=wt==='upper'?'‚ñ≤ –í–µ—Ä—Ö–Ω—è—è':'‚ñº –ù–∏–∂–Ω—è—è';b.className='pillBadge '+(wt==='upper'?'up':'lo')}
function prevW(){vM.setDate(vM.getDate()-7);sD=0;updAll()}
function nextW(){vM.setDate(vM.getDate()+7);sD=0;updAll()}

function rStrip(){
  const wr=document.getElementById('weekRow'),wl=document.getElementById('weekLabel'),tk=fk(new Date());
  const e=new Date(vM);e.setDate(e.getDate()+5);const wt=gwt(vM);
  let h=`<button class="wArrow" onclick="prevW()">‚Äπ</button>`;
  for(let i=0;i<6;i++){const d=new Date(vM);d.setDate(d.getDate()+i);const dk=fk(d),isT=dk===tk,hasCh=ch.some(x=>x.date===dk);h+=`<button class="dayChip${i===sD?' sel':''}${isT?' today':''}" onclick="pickD(${i})">${hasCh?'<span class="dcDot"></span>':''}<span class="dcD">${DK[i]}</span><span class="dcN">${d.getDate()}</span></button>`}
  h+=`<button class="wArrow" onclick="nextW()">‚Ä∫</button>`;wr.innerHTML=h;
  wl.innerHTML=`${fShort(vM)} ‚Äî ${fShort(e)} ¬∑ <span class="${wt==='upper'?'up':'lo'}">${wt==='upper'?'‚ñ≤ –í–µ—Ä—Ö–Ω—è—è':'‚ñº –ù–∏–∂–Ω—è—è'}</span>`;
}
function pickD(i){sD=i;rStrip();render()}

/* EVENTS ‚Äî only changes and real events, NO homework */
function rEvents(){
  const c=document.getElementById('eventsList'),tk=fk(new Date());
  let items=[];
  ch.filter(x=>x.date>=tk).forEach(x=>{items.push({date:x.date,icon:'üîÑ',title:'–ó–∞–º–µ–Ω–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è',desc:fFull(pk(x.date)),color:'var(--orange)'})});
  items.sort((a,b)=>a.date.localeCompare(b.date));
  if(!items.length){c.innerHTML='<div class="emptyBox"><div class="eIcon">üìå</div><div class="eTxt">–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π</div></div>';return}
  c.innerHTML=items.map(ev=>`<div class="evCard"><div class="evT">${ev.icon} ${esc(ev.title)}</div><div class="evD">üìÖ ${esc(ev.desc)}</div></div>`).join('');
}

/* RENDER */
function render(){
  const w=document.getElementById('lList');
  const d=new Date(vM);d.setDate(d.getDate()+sD);
  const dk=fk(d),wt=gwt(vM),dayK=DK[sD];
  const cx=ch.find(x=>x.date===dk),hasCh=!!cx;
  const les=hasCh?(cx.lessons||{}):(sc[wt]?.[dayK]||{});
  let h='';
  for(let p=1;p<=5;p++){const l=les[p],has=l&&l.name,tm=cf.pairTimes[p-1];const iho=hw.filter(x=>x.date===dk&&x.pair===p);const ihn=nh.filter(x=>x.targetDate===dk&&x.targetPair===p);
  h+=`<div class="lCard${has?'':' empty'}${hasCh&&has?' changed':''}" ${isA?`onclick="openLM('${dayK}',${p},'${wt}')"`:''}>
    <div class="pairN"><span class="pn">${p}</span><span class="pt">${tm?.start||''}</span></div>
    <div class="lBody">${has?`<div class="lName">${esc(l.name)}</div><div class="lMeta">${l.room?`<span>üìç ${esc(l.room)}</span>`:''}${l.teacher?`<span>üë§ ${esc(l.teacher)}</span>`:''}</div>${rIHw(iho,'–î–æ–º–∞—à–∫–∞','hw')}${rIHw(ihn,'–î–ó','nh')}`:`<div class="lEmpty">${isA?'+ –î–æ–±–∞–≤–∏—Ç—å':'‚Äî'}</div>`}</div>
    ${has&&isA?`<div class="lActions"><button class="miniBtn bl" onclick="event.stopPropagation();openHwI('${dk}',${p},'${esc(l.name)}')">+–î–ó</button></div>`:''}
  </div>`}
  w.innerHTML=h;
}

function rIHw(list,lbl,tp){if(!list.length)return'';return list.map(h=>{let ph='';if(h.photos&&h.photos.length)ph='<div class="hwPhotos">'+h.photos.map(p=>`<img src="${p}" onclick="event.stopPropagation();viewImg('${p}')">`).join('')+'</div>';return`<div class="hwInline${h.done?' done':''}"><div class="hwHead"><span class="hwTag">${lbl}</span><div class="hwBtns"><button class="miniBtn ${h.done?'og':'gr'}" onclick="event.stopPropagation();${tp==='hw'?`tHw('${h.id}')`:`tNH('${h.id}')`}">${h.done?'‚Ü©':'‚úì'}</button>${isA?`<button class="miniBtn rd" onclick="event.stopPropagation();${tp==='hw'?`dHw('${h.id}')`:`dNH('${h.id}')`}">‚úï</button>`:''}</div></div><div class="hwTxt">${esc(h.task)}</div>${ph}</div>`}).join('')}

/* DESKTOP WEEK */
function rDeskWeek(){
  if(!isDesk())return;
  const wt=gwt(vM),tk=fk(new Date());
  const e=new Date(vM);e.setDate(e.getDate()+5);
  document.getElementById('deskWeekHeader').innerHTML=`<div style="display:flex;align-items:center;gap:10px"><button class="circBtn" onclick="prevW()">‚Äπ</button><h2>${fShort(vM)} ‚Äî ${fShort(e)}</h2><button class="circBtn" onclick="nextW()">‚Ä∫</button></div><span class="dwBadge ${wt==='upper'?'up':'lo'}">${wt==='upper'?'‚ñ≤ –í–µ—Ä—Ö–Ω—è—è':'‚ñº –ù–∏–∂–Ω—è—è'}</span>`;
  let h='';
  for(let i=0;i<6;i++){
    const d=new Date(vM);d.setDate(d.getDate()+i);
    const dk=fk(d),dayK=DK[i],isT=dk===tk;
    const cx=ch.find(x=>x.date===dk),hasCh=!!cx;
    const les=hasCh?(cx.lessons||{}):(sc[wt]?.[dayK]||{});
    h+=`<div class="deskDayCol${isT?' today':''}${hasCh?' has-ch':''}">
      <div class="ddcHead"><span class="ddcDay">${DL[i]}</span><span class="ddcDate">${d.getDate()}</span>${hasCh?'<span class="ddcBadge" style="background:rgba(255,159,10,.15);color:var(--orange)">‚ö°</span>':''}</div>
      <div class="ddcBody">`;
    for(let p=1;p<=5;p++){const l=les[p],has=l&&l.name;
      h+=`<div class="ddcLesson${has?'':' empty'}${hasCh&&has?' changed':''}" ${isA?`onclick="openLM('${dayK}',${p},'${wt}')"`:''}>
        <div class="ddcPN">${p} –ø–∞—Ä–∞ ¬∑ ${cf.pairTimes[p-1]?.start||''}</div>
        ${has?`<div class="ddcLN">${esc(l.name)}</div><div class="ddcLM">${l.room?'üìç'+esc(l.room):''}${l.teacher?' ¬∑ '+esc(l.teacher):''}</div>`:`<div class="ddcEmpty">‚Äî</div>`}
      </div>`}
    h+=`</div></div>`;
  }
  document.getElementById('deskWeekGrid').innerHTML=h;
  rMiniCal();
}

/* MINI CALENDAR */
function rMiniCal(){
  if(!isDesk())return;
  const c=document.getElementById('miniCal');
  const y=calMonth.getFullYear(),m=calMonth.getMonth();
  const mn=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
  const first=new Date(y,m,1),startDay=(first.getDay()+6)%7;
  const daysInMonth=new Date(y,m+1,0).getDate();
  const tk=fk(new Date()),selDk=fk(new Date(vM.getTime()+sD*864e5));
  let h=`<div class="mcHead"><span class="mcTitle">${mn[m]} ${y}</span><div class="mcArrows"><button class="mcArrow" onclick="calMonth.setMonth(calMonth.getMonth()-1);rMiniCal()">‚Äπ</button><button class="mcArrow" onclick="calMonth.setMonth(calMonth.getMonth()+1);rMiniCal()">‚Ä∫</button></div></div><div class="mcGrid">`;
  ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].forEach(d=>h+=`<div class="mcDayH">${d}</div>`);
  for(let i=0;i<startDay;i++){const pd=new Date(y,m,0-startDay+i+1);h+=`<div class="mcDay other">${pd.getDate()}</div>`}
  for(let d=1;d<=daysInMonth;d++){const dk=fk(new Date(y,m,d)),cls=dk===tk?' today':dk===selDk?' sel':'';h+=`<div class="mcDay${cls}" onclick="calDayClick('${dk}')">${d}</div>`}
  const rem=(startDay+daysInMonth)%7;if(rem>0)for(let i=1;i<=7-rem;i++)h+=`<div class="mcDay other">${i}</div>`;
  h+=`</div>`;c.innerHTML=h;
}

function calDayClick(dk){const d=pk(dk);vM=gMon(d);sD=(d.getDay()+6)%7;if(sD>5)sD=0;updAll()}

function viewImg(src){document.getElementById('imgViewerSrc').src=src;document.getElementById('imgViewer').classList.add('open')}
function rHwPg(){const c=document.getElementById('hwList'),tk=fk(new Date());const p=nh.filter(h=>h.targetDate&&h.targetDate>=tk&&!h.done).sort((a,b)=>a.targetDate.localeCompare(b.targetDate));if(!p.length){c.innerHTML='<div class="emptyBox"><div class="eIcon">üìö</div><div class="eTxt">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π</div></div>';return}c.innerHTML=p.map(h=>{let ph='';if(h.photos&&h.photos.length)ph='<div class="hwPhotos">'+h.photos.map(p=>`<img src="${p}" onclick="viewImg('${p}')">`).join('')+'</div>';return`<div class="hwCard"><div class="hwSubj">üìñ ${esc(h.subject)}</div><div class="hwDue">üìÖ ${fFull(pk(h.targetDate))}</div><div class="hwTask">${esc(h.task)}</div>${ph}<div class="hwActs"><button class="btnP" style="padding:6px 12px;font-size:12px;width:auto" onclick="tNH('${h.id}')">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>${isA?`<button class="btnD" style="padding:6px 12px;font-size:12px;width:auto" onclick="dNH('${h.id}')">–£–¥–∞–ª–∏—Ç—å</button>`:''}</div></div>`}).join('')}
function rSubj(){const c=document.getElementById('sjList');if(!sj.length){c.innerHTML='<div class="emptyBox"><div class="eIcon">üìñ</div><div class="eTxt">–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã</div></div>';return}c.innerHTML=sj.sort((a,b)=>a.name.localeCompare(b.name)).map(s=>`<div class="sjRow"><div class="sjIcon">üìñ</div><div class="sjInfo"><div class="sjN">${esc(s.name)}</div><div class="sjM">${s.room?'üìç '+esc(s.room):''}${s.teacher?' ¬∑ üë§ '+esc(s.teacher):''}</div></div><div style="display:flex;gap:3px"><button class="miniBtn bl" onclick="editSj('${s.id}')">‚úèÔ∏è</button><button class="miniBtn rd" onclick="rmSj('${s.id}')">‚úï</button></div></div>`).join('')}
function rChg(){const c=document.getElementById('chgList'),tk=fk(new Date());const f=ch.filter(x=>x.date>=tk).sort((a,b)=>a.date.localeCompare(b.date));if(!f.length){c.innerHTML='<div class="emptyBox"><div class="eIcon">üîÑ</div><div class="eTxt">–ù–µ—Ç –∑–∞–º–µ–Ω</div></div>';return}c.innerHTML=f.map(x=>{let ls='';if(x.lessons){for(let p=1;p<=5;p++){const l=x.lessons[p];if(l&&l.name)ls+=`<div class="chgLesson"><span class="clN">${p}</span><div><div style="font-weight:700;font-size:13px">${esc(l.name)}</div><div style="font-size:11px;color:var(--t3)">${l.room?'üìç '+esc(l.room):''}${l.teacher?' ¬∑ '+esc(l.teacher):''}</div></div></div>`}}if(!ls)ls='<div style="padding:6px;color:var(--t3);font-size:12px">–í—Å–µ –ø–∞—Ä—ã —Å–Ω—è—Ç—ã</div>';return`<div class="chgCard"><div class="chHead"><span class="chDate">üìÖ ${fFull(pk(x.date))}</span><div style="display:flex;gap:3px"><button class="miniBtn bl" onclick="editChg('${x.id}')">‚úèÔ∏è</button><button class="miniBtn rd" onclick="rmChgId('${x.id}')">‚úï</button></div></div>${ls}</div>`}).join('')}

/* PHOTOS */
function addPh(inp,cid){Array.from(inp.files).forEach(f=>{if(f.size>5*1024*1024){alert('–ú–∞–∫—Å 5MB');return}const r=new FileReader();r.onload=e=>{if(!uPh[cid])uPh[cid]=[];uPh[cid].push(e.target.result);rPhPrev(cid)};r.readAsDataURL(f)});inp.value=''}
function rPhPrev(cid){const c=document.getElementById(cid);if(!uPh[cid])uPh[cid]=[];c.innerHTML=uPh[cid].map((p,i)=>`<div class="ppItem"><img src="${p}"><button class="ppRm" onclick="rmPh('${cid}',${i})">‚úï</button></div>`).join('')}
function rmPh(cid,i){uPh[cid].splice(i,1);rPhPrev(cid)}

/* CUSTOM SELECT */
function bCS(cid,sid,cb){const c=document.getElementById(cid),sr=[...sj].sort((a,b)=>a.name.localeCompare(b.name)),sel=sr.find(s=>s.id===sid);csS[cid]={selectedId:sid||'',onChange:cb};let trig;if(sel)trig=`<span class="csI">üìñ</span><div class="csTxt"><div class="csN">${esc(sel.name)}</div><div class="csM">${sel.room?'üìç'+esc(sel.room):''}${sel.teacher?' ¬∑ '+esc(sel.teacher):''}</div></div>`;else trig=`<span class="csPh">‚Äî –ù–µ—Ç ‚Äî</span>`;const opts=sr.map(s=>`<div class="csOpt${s.id===sid?' on':''}" data-sid="${s.id}"><span class="coI">üìñ</span><div><div class="coN">${esc(s.name)}</div><div class="coM">${s.room?'üìç'+esc(s.room):''}${s.teacher?' ¬∑ '+esc(s.teacher):''}</div></div></div>`).join('');c.innerHTML=`<div class="csWrap"><div class="csTrig" data-cid="${cid}">${trig}<span class="csArr">‚ñº</span></div><div class="csDd" id="${cid}-dd"><div class="csOpt emp" data-sid=""><span class="coI">‚úï</span><div><div class="coN" style="color:var(--t3)">‚Äî –ù–µ—Ç ‚Äî</div></div></div>${opts}</div></div>`;c.querySelector('.csTrig').addEventListener('click',e=>{e.stopPropagation();const dd=document.getElementById(cid+'-dd'),tr=c.querySelector('.csTrig'),wo=dd.classList.contains('open');closeCS();if(!wo){dd.classList.add('open');tr.classList.add('open')}});c.querySelectorAll('.csOpt').forEach(o=>{o.addEventListener('click',e=>{e.stopPropagation();const id=o.dataset.sid,sub=id?sj.find(s=>s.id===id):null;csS[cid].selectedId=id;const tr=c.querySelector('.csTrig');if(sub)tr.innerHTML=`<span class="csI">üìñ</span><div class="csTxt"><div class="csN">${esc(sub.name)}</div><div class="csM">${sub.room?'üìç'+esc(sub.room):''}${sub.teacher?' ¬∑ '+esc(sub.teacher):''}</div></div><span class="csArr">‚ñº</span>`;else tr.innerHTML=`<span class="csPh">‚Äî –ù–µ—Ç ‚Äî</span><span class="csArr">‚ñº</span>`;c.querySelectorAll('.csOpt').forEach(x=>x.classList.remove('on'));o.classList.add('on');closeCS();if(csS[cid].onChange)csS[cid].onChange(id,sub)})})}
function closeCS(){document.querySelectorAll('.csDd.open').forEach(d=>d.classList.remove('open'));document.querySelectorAll('.csTrig.open').forEach(t=>t.classList.remove('open'))}
function gcs(id){return csS[id]?.selectedId||''}
document.addEventListener('click',()=>closeCS());

function openLM(d,p,w){if(!isA)return;document.getElementById('elD').value=d;document.getElementById('elP').value=p;document.getElementById('elW').value=w;const l=sc[w]?.[d]?.[p]||{};let sid='';if(l.name){const s=sj.find(x=>x.name===l.name);if(s)sid=s.id}bCS('elSel',sid,null);openS('shLesson')}
function svLesson(){if(!isA)return;const d=document.getElementById('elD').value,p=document.getElementById('elP').value,w=document.getElementById('elW').value,sid=gcs('elSel'),sub=sj.find(s=>s.id===sid);if(sub)db.ref(`schedule/${w}/${d}/${p}`).set({name:sub.name,room:sub.room||'',teacher:sub.teacher||''});else db.ref(`schedule/${w}/${d}/${p}`).remove();closeS('shLesson')}
function rmLesson(){if(!isA)return;db.ref(`schedule/${document.getElementById('elW').value}/${document.getElementById('elD').value}/${document.getElementById('elP').value}`).remove();closeS('shLesson')}
function openHwI(dk,p,s){if(!isA)return;document.getElementById('hiD').value=dk;document.getElementById('hiP').value=p;document.getElementById('hiS').value=s;document.getElementById('hiT').value='';uPh.hiPh=[];rPhPrev('hiPh');openS('shHwI')}
function svHwI(){if(!isA)return;const t=document.getElementById('hiT').value.trim();if(!t){alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ');return}const data={date:document.getElementById('hiD').value,pair:parseInt(document.getElementById('hiP').value),subject:document.getElementById('hiS').value,task:t,done:false,created:new Date().toISOString()};if(uPh.hiPh.length)data.photos=uPh.hiPh;db.ref('homework').push(data);closeS('shHwI')}
function tHw(id){const h=hw.find(x=>x.id===id);if(h)db.ref(`homework/${id}/done`).set(!h.done)}
function dHw(id){if(!isA)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`homework/${id}`).remove()}
function openNewHw(){if(!isA)return;bCS('nhSel','',(_,sub)=>{const info=document.getElementById('nhNext');if(sub&&sub.name){const n=findNx(sub.name);if(n)info.innerHTML=`<span style="color:var(--blue);font-weight:700">üìÖ ${fFull(pk(n.date))}</span>, –ø–∞—Ä–∞ ${n.pair}`;else info.innerHTML='<span style="color:var(--red)">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</span>'}else info.textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç'});document.getElementById('nhT').value='';document.getElementById('nhNext').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç';uPh.nhPh=[];rPhPrev('nhPh');openS('shNewHw')}
function svNewHw(){if(!isA)return;const sid=gcs('nhSel'),sub=sj.find(s=>s.id===sid);if(!sub){alert('–ü—Ä–µ–¥–º–µ—Ç');return}const t=document.getElementById('nhT').value.trim();if(!t){alert('–ó–∞–¥–∞–Ω–∏–µ');return}const n=findNx(sub.name);if(!n){alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ');return}const data={subject:sub.name,task:t,targetDate:n.date,targetPair:n.pair,done:false,created:new Date().toISOString()};if(uPh.nhPh.length)data.photos=uPh.nhPh;db.ref('newHomework').push(data);closeS('shNewHw')}
function tNH(id){const h=nh.find(x=>x.id===id);if(h)db.ref(`newHomework/${id}/done`).set(!h.done)}
function dNH(id){if(!isA)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`newHomework/${id}`).remove()}
function openSjM(eid){document.getElementById('sjId').value=eid||'';document.getElementById('sjN').value='';document.getElementById('sjR').value='';document.getElementById('sjTch').value='';document.getElementById('sjTitle').textContent=eid?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å':'–î–æ–±–∞–≤–∏—Ç—å';if(eid){const s=sj.find(x=>x.id===eid);if(s){document.getElementById('sjN').value=s.name||'';document.getElementById('sjR').value=s.room||'';document.getElementById('sjTch').value=s.teacher||''}}openS('shSubj')}
function editSj(id){openSjM(id)}
function svSubj(){const id=document.getElementById('sjId').value,n=document.getElementById('sjN').value.trim(),r=document.getElementById('sjR').value.trim(),t=document.getElementById('sjTch').value.trim();if(!n){alert('–ù–∞–∑–≤–∞–Ω–∏–µ');return}if(id)db.ref(`subjects/${id}`).set({name:n,room:r,teacher:t});else db.ref('subjects').push({name:n,room:r,teacher:t});closeS('shSubj')}
function rmSj(id){if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`subjects/${id}`).remove()}
function openChgM(eid){if(!isA)return;document.getElementById('ceId').value=eid||'';document.getElementById('ceDel').style.display=eid?'':'none';document.getElementById('ceDate').value='';let h='';for(let i=1;i<=5;i++)h+=`<div class="cpBlk"><div class="cpHead"><span class="cpN">${i}</span><span style="font-size:13px;font-weight:600;color:var(--t2)">–ø–∞—Ä–∞</span></div><div id="cs-c${i}"></div></div>`;document.getElementById('cePairs').innerHTML=h;for(let i=1;i<=5;i++)bCS(`cs-c${i}`,'',null);if(eid){const c=ch.find(x=>x.id===eid);if(c){document.getElementById('ceDate').value=c.date;if(c.lessons){for(let i=1;i<=5;i++){const l=c.lessons[i];if(l&&l.name){const s=sj.find(x=>x.name===l.name);if(s)bCS(`cs-c${i}`,s.id,null)}}}}}openS('shChg')}
function editChg(id){openChgM(id)}
function svChg(){if(!isA)return;const eid=document.getElementById('ceId').value,date=document.getElementById('ceDate').value;if(!date){alert('–î–∞—Ç–∞');return}const les={};let any=false;for(let i=1;i<=5;i++){const sid=gcs(`cs-c${i}`),sub=sj.find(s=>s.id===sid);if(sub){les[i]={name:sub.name,room:sub.room||'',teacher:sub.teacher||''};any=true}}if(eid)db.ref(`changes/${eid}`).set({date,lessons:any?les:null});else db.ref('changes').push({date,lessons:any?les:null});closeS('shChg')}
function rmChg(){const id=document.getElementById('ceId').value;if(id){rmChgId(id);closeS('shChg')}}
function rmChgId(id){if(!isA)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`changes/${id}`).remove()}
function openTimesM(){if(!isA)return;document.getElementById('timesF').innerHTML=cf.pairTimes.map((t,i)=>`<div style="display:flex;gap:6px;align-items:center;margin-bottom:8px"><span style="min-width:46px;font-weight:700;font-size:13px">${i+1} –ø–∞—Ä–∞</span><input type="time" class="inp" id="ts${i}" value="${t.start}" style="flex:1;margin:0;padding:10px"><span style="color:var(--t3)">‚Äî</span><input type="time" class="inp" id="te${i}" value="${t.end}" style="flex:1;margin:0;padding:10px"></div>`).join('');openS('shTimes')}
function svTimes(){if(!isA)return;const t=[];for(let i=0;i<5;i++)t.push({start:document.getElementById(`ts${i}`).value,end:document.getElementById(`te${i}`).value});db.ref('settings/pairTimes').set(t);closeS('shTimes')}
function clearAll(){if(!isA)return;if(confirm('–£–¥–∞–ª–∏—Ç—å –í–°–Å?')){db.ref('schedule').remove();db.ref('homework').remove();db.ref('newHomework').remove();db.ref('changes').remove();db.ref('subjects').remove()}}

function openS(id){document.getElementById(id).classList.add('open')}
function closeS(id){document.getElementById(id).classList.remove('open')}
document.querySelectorAll('.sheet').forEach(s=>{s.addEventListener('click',e=>{if(e.target===s)s.classList.remove('open')})});
document.getElementById('iPass').addEventListener('keypress',e=>{if(e.key==='Enter')doLogin()});
document.getElementById('iEmail').addEventListener('keypress',e=>{if(e.key==='Enter')document.getElementById('iPass').focus()});

let tx=0;
document.addEventListener('touchstart',e=>{tx=e.touches[0].clientX},{passive:true});
document.addEventListener('touchend',e=>{if(!document.getElementById('pgSched').classList.contains('on'))return;const dx=e.changedTouches[0].clientX-tx;if(Math.abs(dx)>70){if(dx<0&&sD<5){sD++;rStrip();render()}else if(dx>0&&sD>0){sD--;rStrip();render()}}});
window.addEventListener('resize',()=>{if(isDesk()){rDeskWeek();rMiniCal()}});
</script>
</body>
</html>
