<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–î–Ω–µ–≤–Ω–∏–∫</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–î–Ω–µ–≤–Ω–∏–∫">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#6366f1">
  <link rel="icon" type="image/png" sizes="32x32" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg-primary:#0a0a0f;--bg-secondary:#12121a;--bg-card:rgba(255,255,255,0.02);--bg-card-hover:rgba(255,255,255,0.05);--bg-input:rgba(255,255,255,0.05);--border-color:rgba(255,255,255,0.05);--border-light:rgba(255,255,255,0.1);--text-primary:#fff;--text-secondary:rgba(255,255,255,0.7);--text-muted:rgba(255,255,255,0.4);--accent:#6366f1}
    [data-theme="light"]{--bg-primary:#f5f5f7;--bg-secondary:#fff;--bg-card:rgba(0,0,0,0.03);--bg-card-hover:rgba(0,0,0,0.06);--bg-input:rgba(0,0,0,0.05);--border-color:rgba(0,0,0,0.08);--border-light:rgba(0,0,0,0.12);--text-primary:#1a1a1a;--text-secondary:rgba(0,0,0,0.7);--text-muted:rgba(0,0,0,0.4)}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html{height:-webkit-fill-available}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);min-height:100vh;min-height:-webkit-fill-available;color:var(--text-primary);-webkit-font-smoothing:antialiased;transition:background .3s,color .3s}
    .safe-area-top{position:fixed;top:0;left:0;right:0;height:env(safe-area-inset-top);background:var(--bg-secondary);z-index:101}
    .container{max-width:1000px;margin:0 auto;padding:20px;padding-left:calc(20px + env(safe-area-inset-left));padding-right:calc(20px + env(safe-area-inset-right));padding-bottom:calc(20px + env(safe-area-inset-bottom))}
    header{background:var(--bg-secondary);border-bottom:1px solid var(--border-color);padding:15px 20px;padding-top:calc(15px + env(safe-area-inset-top));padding-left:calc(20px + env(safe-area-inset-left));padding-right:calc(20px + env(safe-area-inset-right));position:sticky;top:0;z-index:100}
    .header-content{max-width:1000px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .header-left{display:flex;align-items:center;gap:15px}
    .logo{font-size:1.5em;font-weight:700;background:linear-gradient(135deg,#6366f1,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .header-date{font-size:.9em;color:var(--text-secondary);font-weight:500}
    .header-right{display:flex;align-items:center;gap:10px}
    .header-week{padding:6px 14px;border-radius:20px;font-size:.8em;font-weight:600}
    .header-week.upper{background:linear-gradient(135deg,#10b981,#34d399);color:#000}
    .header-week.lower{background:linear-gradient(135deg,#f43f5e,#fb7185);color:#fff}
    .theme-toggle{width:40px;height:40px;border-radius:10px;background:var(--bg-card);border:1px solid var(--border-color);color:var(--text-primary);font-size:1.2em;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .theme-toggle:hover{background:var(--bg-card-hover)}
    .user-info{display:flex;align-items:center;gap:8px;font-size:.85em;color:var(--text-secondary)}
    .admin-badge{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000;padding:4px 10px;border-radius:15px;font-size:.75em;font-weight:600}
    .btn{padding:10px 20px;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:.9em;transition:all .2s;font-family:inherit}
    .btn-primary{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff}
    .btn-secondary{background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border-color)}
    .btn-danger{background:linear-gradient(135deg,#ef4444,#f87171);color:#fff}
    .btn-success{background:linear-gradient(135deg,#10b981,#34d399);color:#000}
    .btn-warning{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000}
    .btn:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(0,0,0,.2)}
    .btn:active{transform:scale(.98)}
    .btn-sm{padding:6px 12px;font-size:.8em}
    .btn-xs{padding:4px 8px;font-size:.75em}
    .btn-icon{width:44px;height:44px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:12px;font-size:1.2em;background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border-color);cursor:pointer;transition:all .2s}
    .btn-icon:hover{background:var(--bg-card-hover)}
    .week-navigator{display:flex;align-items:center;justify-content:center;gap:20px;padding:16px 20px;background:var(--bg-card);border-radius:16px;margin-bottom:20px;border:1px solid var(--border-color)}
    .week-dates{text-align:center;min-width:180px}
    .week-dates-range{font-size:1.2em;font-weight:700;color:var(--text-primary);margin-bottom:4px}
    .week-dates-type{font-size:.85em;font-weight:600}
    .week-dates-type.upper{color:#34d399}
    .week-dates-type.lower{color:#fb7185}
    .nav{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
    .nav-btn{padding:12px 20px;border:none;background:var(--bg-card);color:var(--text-secondary);border-radius:12px;cursor:pointer;font-size:.9em;font-weight:500;transition:all .2s;font-family:inherit;border:1px solid var(--border-color)}
    .nav-btn:hover{background:var(--bg-card-hover);color:var(--text-primary)}
    .nav-btn.active{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;border-color:transparent}
    .section{display:none}.section.active{display:block;animation:fadeIn .3s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
    .days-grid{display:flex;flex-direction:column;gap:16px}
    .day-block{background:var(--bg-card);border-radius:16px;overflow:hidden;border:1px solid var(--border-color)}
    .day-block.today{border-color:rgba(99,102,241,.4);box-shadow:0 0 30px rgba(99,102,241,.1)}
    .day-block.has-changes{border-color:rgba(245,158,11,.4)}
    .day-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:var(--bg-card-hover);border-bottom:1px solid var(--border-color)}
    .day-title{font-size:1em;font-weight:600;display:flex;align-items:center;gap:8px;color:var(--text-primary)}
    .day-title .date{font-weight:400;color:var(--text-muted);font-size:.9em}
    .day-badges{display:flex;gap:6px}
    .today-label{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;padding:4px 10px;border-radius:12px;font-size:.7em;font-weight:600}
    .changes-label{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000;padding:4px 10px;border-radius:12px;font-size:.7em;font-weight:600}
    .day-content{padding:10px}
    .lessons-list{display:flex;flex-direction:column;gap:6px}
    .lesson-row{display:flex;align-items:flex-start;gap:10px;padding:10px;background:var(--bg-card);border-radius:10px;transition:all .2s;cursor:pointer}
    .lesson-row:hover{background:var(--bg-card-hover)}
    .lesson-row.empty{opacity:.5}
    .lesson-row.changed{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3)}
    .lesson-number{width:44px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:6px;background:rgba(99,102,241,.15);border-radius:8px;flex-shrink:0}
    .lesson-num{font-size:1.2em;font-weight:700;color:var(--accent)}
    .lesson-time{font-size:.6em;color:var(--text-muted);margin-top:2px}
    .lesson-info{flex:1;min-width:0}
    .lesson-name-row{display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap}
    .lesson-name{font-weight:600;font-size:.95em;color:var(--text-primary)}
    .lesson-details{display:flex;gap:12px;font-size:.8em;color:var(--text-muted);margin-bottom:6px;flex-wrap:wrap}
    .lesson-room{color:var(--accent)}
    .lesson-empty-text{color:var(--text-muted);font-style:italic;font-size:.9em}
    .lesson-homework{margin-top:8px;padding:10px;background:rgba(99,102,241,.1);border-radius:8px;border-left:3px solid var(--accent)}
    .lesson-homework-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
    .lesson-homework-title{font-size:.7em;color:var(--accent);font-weight:600;text-transform:uppercase}
    .lesson-homework-text{font-size:.85em;line-height:1.4;color:var(--text-primary)}
    .lesson-homework.done{opacity:.5;border-left-color:#10b981}
    .lesson-homework.done .lesson-homework-text{text-decoration:line-through}
    .add-hw-btn{padding:4px 8px;background:rgba(99,102,241,.2);border:none;color:var(--accent);border-radius:6px;cursor:pointer;font-size:.75em;font-weight:600}
    .wrap-card{background:var(--bg-card);border-radius:16px;padding:20px;border:1px solid var(--border-color)}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}
    .section-title{font-size:1.1em;font-weight:600;color:var(--text-primary)}
    .no-items{text-align:center;padding:40px 20px;color:var(--text-muted)}

    .change-card{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);border-radius:12px;padding:14px;margin-bottom:10px}
    .change-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:10px}
    .change-date{font-weight:600;font-size:1em;color:#fbbf24}
    .change-lesson-row{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(0,0,0,.15);border-radius:8px;margin-bottom:6px}
    [data-theme="light"] .change-lesson-row{background:rgba(0,0,0,.05)}
    .change-pair-num{width:28px;height:28px;background:rgba(245,158,11,.3);border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fbbf24;font-size:.9em;flex-shrink:0}
    .change-lesson-info{flex:1}
    .change-lesson-name{font-weight:600;font-size:.95em;color:var(--text-primary)}
    .change-lesson-details{font-size:.8em;color:var(--text-muted);display:flex;gap:10px;flex-wrap:wrap}

    .setting-row{display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--bg-card-hover);border-radius:12px;margin-bottom:10px;flex-wrap:wrap;gap:12px}
    .setting-info h4{margin-bottom:4px;font-size:.95em;color:var(--text-primary)}
    .setting-info p{font-size:.8em;color:var(--text-muted)}
    .setting-input{padding:10px 14px;border:1px solid var(--border-light);background:var(--bg-input);border-radius:10px;color:var(--text-primary);font-family:inherit}

    .modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:1000;align-items:flex-start;justify-content:center;padding:20px;padding-top:calc(40px + env(safe-area-inset-top));overflow-y:auto}
    [data-theme="light"] .modal-overlay{background:rgba(0,0,0,.5)}
    .modal-overlay.active{display:flex}
    .modal{background:var(--bg-secondary);border-radius:20px;padding:24px;width:100%;max-width:500px;border:1px solid var(--border-color);animation:modalIn .3s ease;margin:auto}
    @keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(-20px)}to{opacity:1;transform:scale(1) translateY(0)}}
    .modal h3{margin-bottom:20px;font-size:1.15em;color:var(--text-primary)}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;color:var(--text-secondary);font-size:.85em;font-weight:500}
    .form-group input,.form-group textarea{width:100%;padding:12px 14px;border:1px solid var(--border-light);background:var(--bg-input);border-radius:10px;color:var(--text-primary);font-size:1em;font-family:inherit;-webkit-appearance:none}
    .form-group textarea{resize:vertical;min-height:80px}
    .form-group input:focus,.form-group textarea:focus{outline:none;border-color:var(--accent)}
    .modal-buttons{display:flex;gap:10px;margin-top:20px}
    .modal-buttons .btn{flex:1}

    .login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;padding-top:calc(20px + env(safe-area-inset-top));background:var(--bg-primary)}
    .login-container{width:100%;max-width:380px;padding:32px;background:var(--bg-card);border-radius:20px;border:1px solid var(--border-color)}
    .login-logo{text-align:center;font-size:4em;margin-bottom:10px}
    .login-container h2{text-align:center;margin-bottom:8px;font-size:1.6em;color:var(--text-primary)}
    .login-subtitle{text-align:center;color:var(--text-muted);margin-bottom:28px}
    .login-error{background:rgba(244,63,94,.1);border:1px solid rgba(244,63,94,.3);color:#fb7185;padding:12px;border-radius:10px;text-align:center;margin-bottom:20px;font-size:.9em}
    .login-container .btn{width:100%;padding:14px;margin-top:10px}
    .divider{display:flex;align-items:center;gap:15px;margin:24px 0;color:var(--text-muted);font-size:.85em}
    .divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border-color)}

    .install-prompt{position:fixed;bottom:calc(20px + env(safe-area-inset-bottom));left:20px;right:20px;background:var(--bg-secondary);border:1px solid rgba(99,102,241,.3);border-radius:16px;padding:16px;display:none;align-items:center;gap:12px;z-index:999;box-shadow:0 10px 40px rgba(0,0,0,.3)}
    .install-prompt.show{display:flex;animation:slideUp .3s ease}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .install-prompt-icon{font-size:2em}
    .install-prompt-text{flex:1}
    .install-prompt-text h4{font-size:.95em;margin-bottom:2px;color:var(--text-primary)}
    .install-prompt-text p{font-size:.8em;color:var(--text-muted)}
    .install-prompt-close{background:none;border:none;color:var(--text-muted);font-size:1.5em;cursor:pointer;padding:5px}

    /* Custom dropdown */
    .custom-select{position:relative;width:100%}
    .custom-select-trigger{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--bg-input);border:1px solid var(--border-light);border-radius:10px;cursor:pointer;transition:border-color .2s;min-height:48px}
    .custom-select-trigger:hover{border-color:var(--accent)}
    .custom-select-trigger.open{border-color:var(--accent);border-radius:10px 10px 0 0}
    .custom-select-trigger .cs-icon{width:32px;height:32px;background:rgba(99,102,241,.15);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.9em;flex-shrink:0}
    .custom-select-trigger .cs-text{flex:1;min-width:0}
    .custom-select-trigger .cs-name{font-weight:600;font-size:.9em;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .custom-select-trigger .cs-meta{font-size:.75em;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .custom-select-trigger .cs-placeholder{color:var(--text-muted);font-size:.9em}
    .custom-select-trigger .cs-arrow{color:var(--text-muted);font-size:.7em;flex-shrink:0;transition:transform .2s}
    .custom-select-trigger.open .cs-arrow{transform:rotate(180deg)}
    .custom-select-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--bg-secondary);border:1px solid var(--accent);border-top:none;border-radius:0 0 10px 10px;max-height:240px;overflow-y:auto;z-index:50;display:none}
    .custom-select-dropdown.open{display:block}
    .custom-select-option{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;transition:background .15s}
    .custom-select-option:hover{background:var(--bg-card-hover)}
    .custom-select-option.selected{background:rgba(99,102,241,.15)}
    .custom-select-option .cso-icon{width:28px;height:28px;background:rgba(99,102,241,.1);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.8em;flex-shrink:0}
    .custom-select-option .cso-text{flex:1;min-width:0}
    .custom-select-option .cso-name{font-weight:600;font-size:.85em;color:var(--text-primary)}
    .custom-select-option .cso-meta{font-size:.72em;color:var(--text-muted)}
    .custom-select-option.empty-opt{color:var(--text-muted);font-style:italic;font-size:.85em}
    .custom-select-option.empty-opt:hover{background:rgba(239,68,68,.1)}
    .custom-select-option.empty-opt .cso-icon{background:rgba(239,68,68,.15)}

    /* Subject cards */
    .subject-card{display:flex;align-items:center;gap:12px;padding:14px;background:var(--bg-card-hover);border:1px solid var(--border-color);border-radius:12px;margin-bottom:8px}
    .subject-icon{width:42px;height:42px;background:rgba(99,102,241,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.3em;flex-shrink:0}
    .subject-info{flex:1;min-width:0}
    .subject-name{font-weight:600;font-size:.95em;color:var(--text-primary)}
    .subject-meta{font-size:.8em;color:var(--text-muted);display:flex;gap:10px;flex-wrap:wrap;margin-top:2px}
    .subject-actions{display:flex;gap:6px}

    /* HW tab */
    .hw-card{background:var(--bg-card-hover);border:1px solid var(--border-color);border-radius:14px;padding:16px;margin-bottom:12px;position:relative;overflow:hidden}
    .hw-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--accent)}
    .hw-card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:10px;flex-wrap:wrap}
    .hw-card-subject{font-weight:700;font-size:1.05em;color:var(--accent);display:flex;align-items:center;gap:8px}
    .hw-card-subject-icon{width:32px;height:32px;background:rgba(99,102,241,.15);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.9em}
    .hw-card-due{display:flex;align-items:center;gap:6px;font-size:.78em;color:var(--text-muted);background:var(--bg-card);padding:4px 10px;border-radius:20px;border:1px solid var(--border-color);white-space:nowrap}
    .hw-card-task{font-size:.92em;line-height:1.6;color:var(--text-primary);padding:12px;background:var(--bg-card);border-radius:10px;margin-bottom:12px;border:1px solid var(--border-color)}
    .hw-card-actions{display:flex;gap:8px}
    .hw-badge{background:#ef4444;color:#fff;border-radius:50%;min-width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;font-size:.7em;font-weight:700;margin-left:6px;padding:0 4px}

    .change-pair-row{background:var(--bg-card);border-radius:10px;padding:12px;margin-bottom:8px}
    .change-pair-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .change-pair-num-badge{width:26px;height:26px;background:rgba(245,158,11,.3);border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fbbf24;font-size:.85em}

    @media(max-width:500px){
      .header-content{gap:10px}.header-left{gap:10px}.logo{font-size:1.2em}.header-date{font-size:.8em}
      .user-info span:not(.admin-badge){display:none}.week-navigator{padding:14px;gap:15px}
      .week-dates-range{font-size:1em}.btn-icon{width:40px;height:40px}
      .setting-row{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="safe-area-top"></div>

  <div id="login-screen" class="login-screen">
    <div class="login-container">
      <div class="login-logo">üìö</div>
      <h2>–î–Ω–µ–≤–Ω–∏–∫</h2>
      <p class="login-subtitle">–¢–µ—Ö–Ω–∏–∫—É–º</p>
      <div class="login-error" id="login-error" style="display:none;"></div>
      <div class="form-group"><label>Email</label><input type="email" id="login-email" placeholder="admin@example.com" autocomplete="email"></div>
      <div class="form-group"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
      <button class="btn btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
      <div class="divider">–∏–ª–∏</div>
      <button class="btn btn-secondary" onclick="enterAsGuest()">–í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å</button>
    </div>
  </div>

  <div id="app" style="display:none;">
    <header>
      <div class="header-content">
        <div class="header-left">
          <div class="logo">üìö –î–Ω–µ–≤–Ω–∏–∫</div>
          <div class="header-date" id="header-date"></div>
        </div>
        <div class="header-right">
          <div class="header-week" id="header-week"></div>
          <button class="theme-toggle" onclick="toggleTheme()"><span id="theme-icon">üåô</span></button>
          <div class="user-info"><span id="user-email"></span><span class="admin-badge" id="admin-badge" style="display:none;">–ê–¥–º–∏–Ω</span></div>
          <button class="btn btn-secondary btn-sm" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="week-navigator">
        <button class="btn-icon" onclick="prevWeek()">‚Üê</button>
        <div class="week-dates"><div class="week-dates-range" id="week-range"></div><div class="week-dates-type" id="week-type"></div></div>
        <button class="btn-icon" onclick="nextWeek()">‚Üí</button>
      </div>
      <div class="nav" id="main-nav">
        <button class="nav-btn active" data-section="home">üè† –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
        <button class="nav-btn" data-section="homework-tab" id="homework-nav">üìã –î–ó</button>
        <button class="nav-btn admin-only" data-section="changes" id="changes-nav">üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <button class="nav-btn admin-only" data-section="subjects" id="subjects-nav">üìñ –ü—Ä–µ–¥–º–µ—Ç—ã</button>
        <button class="nav-btn admin-only" data-section="settings" id="settings-nav">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
      <div class="section active" id="home"><div class="days-grid" id="days-grid"></div></div>
      <div class="section" id="homework-tab"><div class="wrap-card">
        <div class="section-header"><h2 class="section-title">üìã –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2><button class="btn btn-primary admin-only" onclick="openNewHwModal()" id="add-hw-btn">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
        <div id="homework-tab-list"></div>
      </div></div>
      <div class="section" id="changes"><div class="wrap-card">
        <div class="section-header"><h2 class="section-title">üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h2><button class="btn btn-warning" onclick="openChangeModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
        <div id="changes-list"></div>
      </div></div>
      <div class="section" id="subjects"><div class="wrap-card">
        <div class="section-header"><h2 class="section-title">üìñ –ü—Ä–µ–¥–º–µ—Ç—ã</h2><button class="btn btn-primary" onclick="openSubjectModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
        <div id="subjects-list"></div>
      </div></div>
      <div class="section" id="settings"><div class="wrap-card">
        <h2 class="section-title" style="margin-bottom:20px;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div class="setting-row"><div class="setting-info"><h4>–¢–µ–º–∞</h4><p>–°–≤–µ—Ç–ª–∞—è / —Ç—ë–º–Ω–∞—è</p></div><button class="btn btn-secondary" onclick="toggleTheme()">–°–º–µ–Ω–∏—Ç—å</button></div>
        <div class="setting-row"><div class="setting-info"><h4>–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª—å</h4><p>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤–µ—Ä—Ö–Ω–µ–π</p></div><input type="date" class="setting-input" id="week-start-date"></div>
        <div class="setting-row"><div class="setting-info"><h4>–í—Ä–µ–º—è –ø–∞—Ä</h4><p>–ù–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü</p></div><button class="btn btn-secondary" onclick="openTimesModal()">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button></div>
        <div class="setting-row"><div class="setting-info"><h4>–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</h4><p>–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</p></div><button class="btn btn-danger" onclick="clearAllData()">–û—á–∏—Å—Ç–∏—Ç—å</button></div>
      </div></div>
    </div>
  </div>

  <div class="install-prompt" id="install-prompt">
    <div class="install-prompt-icon">üì≤</div>
    <div class="install-prompt-text"><h4>–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω</h4><p>–£—Å—Ç–∞–Ω–æ–≤–∏ –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p></div>
    <button class="btn btn-primary btn-sm" onclick="installApp()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <button class="install-prompt-close" onclick="hideInstallPrompt()">√ó</button>
  </div>

  <!-- Lesson modal -->
  <div class="modal-overlay" id="lesson-modal"><div class="modal">
    <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—É</h3>
    <input type="hidden" id="edit-day"><input type="hidden" id="edit-pair"><input type="hidden" id="edit-week">
    <div class="form-group"><label>–ü—Ä–µ–¥–º–µ—Ç</label><div id="lesson-select-container"></div></div>
    <div class="modal-buttons">
      <button class="btn btn-secondary" onclick="closeModal('lesson-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-danger" onclick="deleteLesson()">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <button class="btn btn-primary" onclick="saveLesson()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div></div>

  <!-- Old HW modal -->
  <div class="modal-overlay" id="homework-modal"><div class="modal">
    <h3>üìù –î–æ–º–∞—à–∫–∞ –Ω–∞ —ç—Ç—É –ø–∞—Ä—É</h3>
    <input type="hidden" id="hw-date"><input type="hidden" id="hw-pair">
    <div class="form-group"><label>–ü—Ä–µ–¥–º–µ—Ç</label><input type="text" id="hw-subject" readonly style="opacity:.7;"></div>
    <div class="form-group"><label>–ó–∞–¥–∞–Ω–∏–µ</label><textarea id="hw-task" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å..."></textarea></div>
    <div class="modal-buttons"><button class="btn btn-secondary" onclick="closeModal('homework-modal')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="saveHomework()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
  </div></div>

  <!-- New HW modal -->
  <div class="modal-overlay" id="new-hw-modal"><div class="modal">
    <h3 style="display:flex;align-items:center;gap:10px;">
      <span style="width:40px;height:40px;background:rgba(99,102,241,.15);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2em;">üìã</span>
      –ù–æ–≤–æ–µ –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ
    </h3>
    <div class="form-group"><label>üìñ –ü—Ä–µ–¥–º–µ—Ç</label><div id="new-hw-select-container"></div></div>
    <div class="form-group"><label>üìù –ó–∞–¥–∞–Ω–∏–µ</label><textarea id="new-hw-task" placeholder="–û–ø–∏—à–∏—Ç–µ —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å..." style="min-height:100px;"></textarea></div>
    <div class="form-group">
      <label>üìÖ –°–ª–µ–¥—É—é—â–∞—è –ø–∞—Ä–∞</label>
      <div id="new-hw-next-info" style="padding:12px;background:var(--bg-card);border:1px solid var(--border-color);border-radius:10px;font-size:.9em;color:var(--text-muted);min-height:44px;display:flex;align-items:center;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...</div>
    </div>
    <div class="modal-buttons"><button class="btn btn-secondary" onclick="closeModal('new-hw-modal')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="saveNewHw()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
  </div></div>

  <!-- Subject modal -->
  <div class="modal-overlay" id="subject-modal"><div class="modal">
    <h3 id="subject-modal-title">üìñ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</h3>
    <input type="hidden" id="subject-edit-id">
    <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="subject-name" placeholder="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"></div>
    <div class="form-group"><label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label><input type="text" id="subject-room" placeholder="–ö–∞–±. 301"></div>
    <div class="form-group"><label>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</label><input type="text" id="subject-teacher" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò."></div>
    <div class="modal-buttons"><button class="btn btn-secondary" onclick="closeModal('subject-modal')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="saveSubject()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
  </div></div>

  <!-- Change modal -->
  <div class="modal-overlay" id="change-modal"><div class="modal">
    <h3>üìù –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞ –¥–∞—Ç—É</h3>
    <input type="hidden" id="change-edit-id">
    <div class="form-group"><label>üìÖ –î–∞—Ç–∞</label><input type="date" id="change-date"></div>
    <p style="color:var(--text-muted);font-size:.8em;margin-bottom:12px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã. –ü—É—Å—Ç–æ–µ = –Ω–µ—Ç –ø–∞—Ä—ã –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å.</p>
    <div id="change-pairs-container"></div>
    <div class="modal-buttons">
      <button class="btn btn-secondary" onclick="closeModal('change-modal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-danger" id="delete-change-btn" onclick="deleteChange()" style="display:none;">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn btn-primary" onclick="saveChange()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div></div>

  <!-- Times modal -->
  <div class="modal-overlay" id="times-modal"><div class="modal">
    <h3>üïê –í—Ä–µ–º—è –ø–∞—Ä</h3>
    <div id="times-form"></div>
    <div class="modal-buttons"><button class="btn btn-secondary" onclick="closeModal('times-modal')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-primary" onclick="savePairTimes()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
  </div></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    // ===== THEME =====
    function initTheme(){const s=localStorage.getItem('theme');setTheme(s||(window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'))}
    function setTheme(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t);const i=document.getElementById('theme-icon');if(i)i.textContent=t==='dark'?'‚òÄÔ∏è':'üåô';const s=document.querySelector('.safe-area-top');if(s)s.style.background=t==='dark'?'#12121a':'#fff'}
    function toggleTheme(){setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark')}
    initTheme();

    // ===== FIREBASE =====
    firebase.initializeApp({apiKey:"AIzaSyBCy0hz_PHMGUX2M52Wnwb0C9nEnBBfeq8",authDomain:"my-diary-e223c.firebaseapp.com",databaseURL:"https://my-diary-e223c-default-rtdb.firebaseio.com",projectId:"my-diary-e223c",storageBucket:"my-diary-e223c.firebasestorage.app",messagingSenderId:"903986378920",appId:"1:903986378920:web:b6ebc6691f6d767f78aa9d"});
    const auth=firebase.auth(),db=firebase.database();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    const ADMIN_UIDS=["zFKU6TAgIuhZetCOuWpHvDDw6Oj2"];
    const DAYS_SHORT=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
    const DAYS_FULL=['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];

    let currentUser=null,isAdmin=false,isGuest=false;
    let schedule={upper:{},lower:{}},homeworkList=[],changesList=[],newHwList=[],subjectsList=[];
    let settings={weekStartDate:null,pairTimes:[{start:'08:30',end:'10:00'},{start:'10:10',end:'11:40'},{start:'12:10',end:'13:40'},{start:'13:50',end:'15:20'},{start:'15:30',end:'17:00'}]};
    let viewWeekStart=getMonday(new Date());
    let deferredPrompt=null;
    // Track custom selects state
    let activeCustomSelects={};

    // ===== PWA =====
    window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;setTimeout(()=>{if(!localStorage.getItem('installPromptDismissed'))document.getElementById('install-prompt').classList.add('show')},3000)});
    function installApp(){if(deferredPrompt){deferredPrompt.prompt();deferredPrompt.userChoice.then(()=>{deferredPrompt=null;hideInstallPrompt()})}}
    function hideInstallPrompt(){document.getElementById('install-prompt').classList.remove('show');localStorage.setItem('installPromptDismissed','true')}

    // ===== UTILS =====
    function getMonday(d){const r=new Date(d);r.setHours(12,0,0,0);const w=r.getDay();r.setDate(r.getDate()-w+(w===0?-6:1));return r}
    function formatDateKey(d){const r=new Date(d);return`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,'0')}-${String(r.getDate()).padStart(2,'0')}`}
    function parseDateKey(s){const[y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d,12,0,0)}
    function formatDateShort(d){const r=new Date(d);return String(r.getDate()).padStart(2,'0')+'.'+String(r.getMonth()+1).padStart(2,'0')}
    function formatDateFull(d){return new Date(d).toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'})}
    function formatHeaderDate(d){return new Date(d).toLocaleDateString('ru-RU',{day:'numeric',month:'long',weekday:'long'})}
    function escapeHtml(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML}
    function getWeekType(mon){
      if(!settings.weekStartDate){const s=new Date(mon.getFullYear(),0,1);const w=Math.ceil(((mon-s)/86400000+s.getDay()+1)/7);return w%2===1?'upper':'lower'}
      const sd=getMonday(parseDateKey(settings.weekStartDate));const diff=Math.round((mon-sd)/(24*60*60*1000));return Math.floor(diff/7)%2===0?'upper':'lower'
    }

    // ===== CUSTOM SELECT =====
    function createCustomSelect(containerId, selectedId, onChangeCb) {
      const container = document.getElementById(containerId);
      const sorted = [...subjectsList].sort((a,b)=>a.name.localeCompare(b.name));
      const sel = sorted.find(s=>s.id===selectedId);

      let triggerContent;
      if (sel) {
        triggerContent = `<span class="cs-icon">üìñ</span><div class="cs-text"><div class="cs-name">${escapeHtml(sel.name)}</div><div class="cs-meta">${sel.room?'üìç '+escapeHtml(sel.room):''}${sel.teacher?' ¬∑ üë§ '+escapeHtml(sel.teacher):''}</div></div>`;
      } else {
        triggerContent = `<span class="cs-placeholder">‚Äî –Ω–µ—Ç –ø–∞—Ä—ã ‚Äî</span>`;
      }

      container.innerHTML = `
        <div class="custom-select" data-container="${containerId}">
          <div class="custom-select-trigger" onclick="toggleCustomSelect('${containerId}')">
            ${triggerContent}
            <span class="cs-arrow">‚ñº</span>
          </div>
          <div class="custom-select-dropdown" id="${containerId}-dropdown">
            <div class="custom-select-option empty-opt" onclick="selectCustomOption('${containerId}','',null)">
              <span class="cso-icon">‚úï</span>
              <span>‚Äî –ù–µ—Ç –ø–∞—Ä—ã ‚Äî</span>
            </div>
            ${sorted.map(s=>`
              <div class="custom-select-option ${s.id===selectedId?'selected':''}" onclick="selectCustomOption('${containerId}','${s.id}',${JSON.stringify(s).replace(/"/g,'&quot;')})">
                <span class="cso-icon">üìñ</span>
                <div class="cso-text">
                  <div class="cso-name">${escapeHtml(s.name)}</div>
                  <div class="cso-meta">${s.room?'üìç '+escapeHtml(s.room):''}${s.teacher?' ¬∑ üë§ '+escapeHtml(s.teacher):''}</div>
                </div>
              </div>`).join('')}
          </div>
        </div>`;

      activeCustomSelects[containerId] = { selectedId: selectedId || '', onChange: onChangeCb };
    }

    function toggleCustomSelect(containerId) {
      const dropdown = document.getElementById(containerId + '-dropdown');
      const trigger = dropdown.previousElementSibling;
      const isOpen = dropdown.classList.contains('open');
      // Close all others
      document.querySelectorAll('.custom-select-dropdown.open').forEach(d=>{d.classList.remove('open');d.previousElementSibling.classList.remove('open')});
      if (!isOpen) {
        dropdown.classList.add('open');
        trigger.classList.add('open');
      }
    }

    function selectCustomOption(containerId, subjId, subjData) {
      activeCustomSelects[containerId].selectedId = subjId;
      const dropdown = document.getElementById(containerId + '-dropdown');
      const trigger = dropdown.previousElementSibling;
      dropdown.classList.remove('open');
      trigger.classList.remove('open');

      // Update trigger display
      if (subjId && subjData) {
        trigger.innerHTML = `<span class="cs-icon">üìñ</span><div class="cs-text"><div class="cs-name">${escapeHtml(subjData.name)}</div><div class="cs-meta">${subjData.room?'üìç '+escapeHtml(subjData.room):''}${subjData.teacher?' ¬∑ üë§ '+escapeHtml(subjData.teacher):''}</div></div><span class="cs-arrow">‚ñº</span>`;
      } else {
        trigger.innerHTML = `<span class="cs-placeholder">‚Äî –Ω–µ—Ç –ø–∞—Ä—ã ‚Äî</span><span class="cs-arrow">‚ñº</span>`;
      }

      // Update selected highlight
      dropdown.querySelectorAll('.custom-select-option').forEach(o=>o.classList.remove('selected'));
      if (!subjId) {
        dropdown.querySelector('.empty-opt')?.classList.add('selected');
      }

      if (activeCustomSelects[containerId].onChange) {
        activeCustomSelects[containerId].onChange(subjId, subjData);
      }
    }

    function getCustomSelectValue(containerId) {
      return activeCustomSelects[containerId]?.selectedId || '';
    }

    // Close dropdowns on outside click
    document.addEventListener('click', e => {
      if (!e.target.closest('.custom-select')) {
        document.querySelectorAll('.custom-select-dropdown.open').forEach(d=>{d.classList.remove('open');d.previousElementSibling.classList.remove('open')});
      }
    });

    // ===== AUTH =====
    auth.onAuthStateChanged(u=>{if(u){currentUser=u;isAdmin=ADMIN_UIDS.includes(u.uid);isGuest=false;showApp()}else if(localStorage.getItem('guestSession')){isGuest=true;showApp()}});
    function login(){const e=document.getElementById('login-email').value.trim(),p=document.getElementById('login-password').value;if(!e||!p){showLoginError('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');return}auth.signInWithEmailAndPassword(e,p).catch(()=>showLoginError('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å'))}
    function showLoginError(m){const e=document.getElementById('login-error');e.textContent=m;e.style.display='block'}
    function enterAsGuest(){isGuest=true;isAdmin=false;currentUser=null;localStorage.setItem('guestSession','true');showApp()}
    function logout(){localStorage.removeItem('guestSession');auth.signOut().then(()=>{isGuest=false;isAdmin=false;currentUser=null;document.getElementById('app').style.display='none';document.getElementById('login-screen').style.display='flex'})}

    function showApp(){
      document.getElementById('login-screen').style.display='none';
      document.getElementById('app').style.display='block';
      document.getElementById('admin-badge').style.display=isAdmin?'inline':'none';
      document.getElementById('user-email').textContent=isGuest?'–ì–æ—Å—Ç—å':(currentUser?.email?.split('@')[0]||'');
      document.querySelectorAll('.admin-only').forEach(el=>el.style.display=isAdmin?'':'none');
      document.getElementById('main-nav').classList.remove('hidden');
      init();
    }

    function init(){setupNavigation();loadData();viewWeekStart=getMonday(new Date());updateHeaderInfo()}

    function setupNavigation(){
      document.querySelectorAll('.nav-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
          document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.section).classList.add('active');
        });
      });
    }

    // ===== DATA =====
    function loadData(){
      db.ref('settings').on('value',s=>{if(s.val()){settings={...settings,...s.val()};if(settings.weekStartDate)document.getElementById('week-start-date').value=settings.weekStartDate}updateAll();updateHeaderInfo()});
      db.ref('schedule').on('value',s=>{schedule=s.val()||{upper:{},lower:{}};renderDays()});
      db.ref('homework').on('value',s=>{const d=s.val();homeworkList=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];renderDays()});
      db.ref('subjects').on('value',s=>{const d=s.val();subjectsList=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];renderSubjects();renderDays()});
      db.ref('newHomework').on('value',s=>{const d=s.val();newHwList=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];renderHomeworkTab();renderDays();updateHwBadge()});
      db.ref('changes').on('value',s=>{const d=s.val();changesList=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];cleanupPastChanges();renderDays();renderChanges()});
      document.getElementById('week-start-date').addEventListener('change',e=>{if(isAdmin)db.ref('settings/weekStartDate').set(e.target.value)});
    }

    // Remove past changes (they just disappear, don't affect permanent schedule)
    function cleanupPastChanges(){
      if(!isAdmin)return;
      const todayKey=formatDateKey(new Date());
      changesList.forEach(ch=>{
        if(ch.date<todayKey){
          db.ref(`changes/${ch.id}`).remove();
        }
      });
    }

    function updateHeaderInfo(){
      const today=new Date();const wt=getWeekType(getMonday(today));
      document.getElementById('header-date').textContent=formatHeaderDate(today);
      const we=document.getElementById('header-week');
      we.textContent=wt==='upper'?'‚òÄÔ∏è –í–µ—Ä—Ö–Ω—è—è':'üåô –ù–∏–∂–Ω—è—è';we.className='header-week '+wt;
    }
    function updateWeekNavigator(){
      const we=new Date(viewWeekStart);we.setDate(we.getDate()+5);const wt=getWeekType(viewWeekStart);
      document.getElementById('week-range').textContent=`${formatDateShort(viewWeekStart)} ‚Äî ${formatDateShort(we)}`;
      const te=document.getElementById('week-type');te.textContent=wt==='upper'?'‚òÄÔ∏è –í–µ—Ä—Ö–Ω—è—è –Ω–µ–¥–µ–ª—è':'üåô –ù–∏–∂–Ω—è—è –Ω–µ–¥–µ–ª—è';te.className='week-dates-type '+wt;
    }
    function prevWeek(){viewWeekStart.setDate(viewWeekStart.getDate()-7);updateAll()}
    function nextWeek(){viewWeekStart.setDate(viewWeekStart.getDate()+7);updateAll()}
    function updateAll(){updateWeekNavigator();renderDays()}

    // ===== FIND NEXT LESSON =====
    function findNextLessonDate(subjectName){
      const today=new Date();today.setHours(0,0,0,0);
      for(let off=1;off<=60;off++){
        const cd=new Date(today);cd.setDate(cd.getDate()+off);
        const dow=cd.getDay();if(dow===0)continue;
        const di=dow-1;if(di>5)continue;
        const dateKey=formatDateKey(cd);const dayKey=DAYS_SHORT[di];const wt=getWeekType(getMonday(cd));
        // Check changes first (only future ones)
        const dayChange=changesList.find(c=>c.date===dateKey);
        let lessons;
        if(dayChange)lessons=dayChange.lessons||{};
        else lessons=(schedule[wt]||{})[dayKey]||{};
        for(let p=1;p<=5;p++){
          const l=lessons[p];
          if(l&&l.name&&l.name.toLowerCase().trim()===subjectName.toLowerCase().trim())return{date:dateKey,pair:p};
        }
      }
      return null;
    }

    // ===== SUBJECTS =====
    function renderSubjects(){
      const c=document.getElementById('subjects-list');
      if(subjectsList.length===0){c.innerHTML='<div class="no-items">üìñ –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏</div>';return}
      c.innerHTML=subjectsList.sort((a,b)=>a.name.localeCompare(b.name)).map(s=>`
        <div class="subject-card">
          <div class="subject-icon">üìñ</div>
          <div class="subject-info">
            <div class="subject-name">${escapeHtml(s.name)}</div>
            <div class="subject-meta">${s.room?`<span>üìç ${escapeHtml(s.room)}</span>`:''}${s.teacher?`<span>üë§ ${escapeHtml(s.teacher)}</span>`:''}</div>
          </div>
          <div class="subject-actions">
            <button class="btn btn-xs btn-secondary" onclick="editSubject('${s.id}')">‚úèÔ∏è</button>
            <button class="btn btn-xs btn-danger" onclick="deleteSubject('${s.id}')">‚úï</button>
          </div>
        </div>`).join('');
    }
    function openSubjectModal(editId=null){
      document.getElementById('subject-edit-id').value=editId||'';
      document.getElementById('subject-name').value='';
      document.getElementById('subject-room').value='';
      document.getElementById('subject-teacher').value='';
      document.getElementById('subject-modal-title').textContent=editId?'üìñ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç':'üìñ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç';
      if(editId){const s=subjectsList.find(x=>x.id===editId);if(s){document.getElementById('subject-name').value=s.name||'';document.getElementById('subject-room').value=s.room||'';document.getElementById('subject-teacher').value=s.teacher||''}}
      openModal('subject-modal');
    }
    function editSubject(id){openSubjectModal(id)}
    function saveSubject(){
      const id=document.getElementById('subject-edit-id').value;
      const name=document.getElementById('subject-name').value.trim();
      const room=document.getElementById('subject-room').value.trim();
      const teacher=document.getElementById('subject-teacher').value.trim();
      if(!name){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return}
      if(id)db.ref(`subjects/${id}`).set({name,room,teacher});
      else db.ref('subjects').push({name,room,teacher});
      closeModal('subject-modal');
    }
    function deleteSubject(id){if(confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç?'))db.ref(`subjects/${id}`).remove()}
    function getSubjectById(id){return subjectsList.find(s=>s.id===id)||null}

    // ===== HOMEWORK TAB =====
    function renderHomeworkTab(){
      const c=document.getElementById('homework-tab-list');
      const todayKey=formatDateKey(new Date());
      const pending=newHwList.filter(hw=>hw.targetDate&&hw.targetDate>=todayKey&&!hw.done).sort((a,b)=>a.targetDate.localeCompare(b.targetDate));
      if(pending.length===0){c.innerHTML='<div class="no-items">üìö –ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π</div>';return}
      c.innerHTML=pending.map(hw=>`
        <div class="hw-card">
          <div class="hw-card-top">
            <div class="hw-card-subject"><span class="hw-card-subject-icon">üìñ</span>${escapeHtml(hw.subject)}</div>
            <div class="hw-card-due">üìÖ ${formatDateFull(parseDateKey(hw.targetDate))}</div>
          </div>
          <div class="hw-card-task">${escapeHtml(hw.task)}</div>
          <div class="hw-card-actions">
            <button class="btn btn-xs btn-success" onclick="toggleNewHw('${hw.id}')">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>
            ${isAdmin?`<button class="btn btn-xs btn-danger" onclick="deleteNewHw('${hw.id}')">‚úï –£–¥–∞–ª–∏—Ç—å</button>`:''}
          </div>
        </div>`).join('');
    }
    function updateHwBadge(){
      const todayKey=formatDateKey(new Date());
      const count=newHwList.filter(hw=>hw.targetDate&&hw.targetDate>=todayKey&&!hw.done).length;
      document.getElementById('homework-nav').innerHTML=count>0?`üìã –î–ó <span class="hw-badge">${count}</span>`:'üìã –î–ó';
    }
    function openNewHwModal(){
      if(!isAdmin)return;
      // Build custom select for subject
      createCustomSelect('new-hw-select-container', '', (subjId, subjData) => {
        if(subjData && subjData.name) {
          const next=findNextLessonDate(subjData.name);
          if(next)document.getElementById('new-hw-next-info').innerHTML=`<span style="color:var(--accent);font-weight:600;">üìÖ ${formatDateFull(parseDateKey(next.date))}</span><span style="margin-left:8px;color:var(--text-muted)">(–ø–∞—Ä–∞ ${next.pair})</span>`;
          else document.getElementById('new-hw-next-info').innerHTML='<span style="color:#fb7185">‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–ª–∏–∂–∞–π—à–∏–µ 2 –º–µ—Å—è—Ü–∞</span>';
        } else {
          document.getElementById('new-hw-next-info').innerHTML='<span style="color:var(--text-muted)">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...</span>';
        }
      });
      document.getElementById('new-hw-task').value='';
      document.getElementById('new-hw-next-info').innerHTML='<span style="color:var(--text-muted)">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...</span>';
      openModal('new-hw-modal');
    }
    function saveNewHw(){
      if(!isAdmin)return;
      const subjId=getCustomSelectValue('new-hw-select-container');
      const subj=getSubjectById(subjId);
      if(!subj){alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç');return}
      const task=document.getElementById('new-hw-task').value.trim();
      if(!task){alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ');return}
      const next=findNextLessonDate(subj.name);
      if(!next){alert('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å–ª–µ–¥—É—é—â–∞—è –ø–∞—Ä–∞');return}
      db.ref('newHomework').push({subject:subj.name,task,targetDate:next.date,targetPair:next.pair,done:false,created:new Date().toISOString()});
      closeModal('new-hw-modal');
    }
    function toggleNewHw(id){const hw=newHwList.find(h=>h.id===id);if(hw)db.ref(`newHomework/${id}/done`).set(!hw.done)}
    function deleteNewHw(id){if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`newHomework/${id}`).remove()}

    // ===== RENDER DAYS =====
    function renderDays(){
      const grid=document.getElementById('days-grid');
      const weekType=getWeekType(viewWeekStart);
      const weekData=schedule[weekType]||{};
      const todayKey=formatDateKey(new Date());
      let html='';
      for(let i=0;i<6;i++){
        const dayDate=new Date(viewWeekStart);dayDate.setDate(dayDate.getDate()+i);
        const dayKey=DAYS_SHORT[i];const dateKey=formatDateKey(dayDate);
        const isToday=dateKey===todayKey;
        // Changes only apply to their specific date
        const dayChange=changesList.find(c=>c.date===dateKey);
        const hasChanges=!!dayChange;
        const dayLessons=hasChanges?(dayChange.lessons||{}):(weekData[dayKey]||{});
        html+=`<div class="day-block ${isToday?'today':''} ${hasChanges?'has-changes':''}">
          <div class="day-header">
            <div class="day-title">${DAYS_FULL[i]} <span class="date">${formatDateShort(dayDate)}</span></div>
            <div class="day-badges">${hasChanges?'<span class="changes-label">‚ö° –ó–∞–º–µ–Ω–∞</span>':''}${isToday?'<span class="today-label">–°–µ–≥–æ–¥–Ω—è</span>':''}</div>
          </div>
          <div class="day-content"><div class="lessons-list">${renderLessons(dayKey,dayLessons,weekType,dateKey,hasChanges)}</div></div>
        </div>`;
      }
      grid.innerHTML=html;
    }

    function renderLessons(dayKey,lessons,weekType,dateKey,hasChanges){
      let html='';
      for(let pair=1;pair<=5;pair++){
        const lesson=lessons[pair];const hasLesson=lesson&&lesson.name;const time=settings.pairTimes[pair-1];
        const hwOld=homeworkList.filter(hw=>hw.date===dateKey&&hw.pair===pair);
        const hwNew=newHwList.filter(hw=>hw.targetDate===dateKey&&hw.targetPair===pair);
        html+=`<div class="lesson-row ${hasLesson?'':'empty'} ${hasChanges&&hasLesson?'changed':''}" onclick="${isAdmin&&!hasChanges?`openLessonModal('${dayKey}',${pair},'${weekType}')`:''}">
          <div class="lesson-number"><div class="lesson-num">${pair}</div><div class="lesson-time">${time?.start||''}</div></div>
          <div class="lesson-info">${hasLesson?`
            <div class="lesson-name-row"><span class="lesson-name">${escapeHtml(lesson.name)}</span>
            ${isAdmin?`<button class="add-hw-btn" onclick="event.stopPropagation();openHomeworkModal('${dateKey}',${pair},'${escapeHtml(lesson.name)}')">+ –î–ó</button>`:''}</div>
            <div class="lesson-details">${lesson.room?`<span class="lesson-room">üìç ${escapeHtml(lesson.room)}</span>`:''}${lesson.teacher?`<span>üë§ ${escapeHtml(lesson.teacher)}</span>`:''}</div>
            ${renderHwBlock(hwOld,'üìù –î–æ–º–∞—à–∫–∞','hw')}${renderHwBlock(hwNew,'üìã –î–ó','newhw')}
          `:`<span class="lesson-empty-text">${isAdmin&&!hasChanges?'–î–æ–±–∞–≤–∏—Ç—å':'‚Äî'}</span>`}</div>
        </div>`;
      }
      return html;
    }

    function renderHwBlock(list,title,type){
      if(!list||!list.length)return'';
      return list.map(hw=>`
        <div class="lesson-homework ${hw.done?'done':''}" onclick="event.stopPropagation();">
          <div class="lesson-homework-header"><span class="lesson-homework-title">${title}</span>
            <div><button class="btn btn-xs ${hw.done?'btn-secondary':'btn-success'}" onclick="${type==='hw'?`toggleHW('${hw.id}')`:`toggleNewHw('${hw.id}')`}">${hw.done?'‚Ü©':'‚úì'}</button>
            ${isAdmin?`<button class="btn btn-xs btn-danger" onclick="${type==='hw'?`deleteHW('${hw.id}')`:`deleteNewHw('${hw.id}')`}">‚úï</button>`:''}</div>
          </div><div class="lesson-homework-text">${escapeHtml(hw.task)}</div>
        </div>`).join('');
    }

    // ===== CHANGES =====
    function renderChanges(){
      const list=document.getElementById('changes-list');
      const todayKey=formatDateKey(new Date());
      const future=changesList.filter(c=>c.date>=todayKey).sort((a,b)=>a.date.localeCompare(b.date));
      if(future.length===0){list.innerHTML='<div class="no-items">–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>';return}
      list.innerHTML=future.map(ch=>`
        <div class="change-card">
          <div class="change-header"><span class="change-date">${formatDateFull(parseDateKey(ch.date))}</span>
            <div><button class="btn btn-sm btn-secondary" onclick="editChange('${ch.id}')">‚úèÔ∏è</button><button class="btn btn-sm btn-danger" onclick="deleteChangeById('${ch.id}')">‚úï</button></div>
          </div>
          <div>${renderChangeLessons(ch.lessons)}</div>
        </div>`).join('');
    }
    function renderChangeLessons(lessons){
      if(!lessons)return'<div style="color:var(--text-muted);padding:10px;">–ü–∞—Ä –Ω–µ—Ç (–≤—ã—Ö–æ–¥–Ω–æ–π)</div>';
      let html='';
      for(let p=1;p<=5;p++){const l=lessons[p];if(l&&l.name){
        html+=`<div class="change-lesson-row"><div class="change-pair-num">${p}</div><div class="change-lesson-info"><div class="change-lesson-name">${escapeHtml(l.name)}</div><div class="change-lesson-details">${l.room?`<span>üìç ${escapeHtml(l.room)}</span>`:''}${l.teacher?`<span>üë§ ${escapeHtml(l.teacher)}</span>`:''}</div></div></div>`;
      }}
      return html||'<div style="color:var(--text-muted);padding:10px;">–ü–∞—Ä –Ω–µ—Ç (–≤—ã—Ö–æ–¥–Ω–æ–π)</div>';
    }

    function openChangeModal(editId=null){
      if(!isAdmin)return;
      document.getElementById('change-edit-id').value=editId||'';
      document.getElementById('delete-change-btn').style.display=editId?'block':'none';
      document.getElementById('change-date').value='';

      let pairsHtml='';
      for(let i=1;i<=5;i++){
        pairsHtml+=`<div class="change-pair-row">
          <div class="change-pair-header"><span class="change-pair-num-badge">${i}</span><span style="font-weight:500;font-size:.9em;color:var(--text-secondary);">–ø–∞—Ä–∞</span></div>
          <div id="change-select-${i}"></div>
        </div>`;
      }
      document.getElementById('change-pairs-container').innerHTML=pairsHtml;

      // Initialize selects
      for(let i=1;i<=5;i++){
        createCustomSelect(`change-select-${i}`, '', null);
      }

      if(editId){
        const ch=changesList.find(c=>c.id===editId);
        if(ch){
          document.getElementById('change-date').value=ch.date;
          if(ch.lessons){
            for(let i=1;i<=5;i++){
              const l=ch.lessons[i];
              if(l&&l.name){
                const subj=subjectsList.find(s=>s.name===l.name);
                if(subj) createCustomSelect(`change-select-${i}`, subj.id, null);
              }
            }
          }
        }
      }
      openModal('change-modal');
    }
    function editChange(id){openChangeModal(id)}

    function saveChange(){
      if(!isAdmin)return;
      const editId=document.getElementById('change-edit-id').value;
      const date=document.getElementById('change-date').value;
      if(!date){alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');return}
      const lessons={};let hasAny=false;
      for(let i=1;i<=5;i++){
        const subjId=getCustomSelectValue(`change-select-${i}`);
        if(subjId){const subj=getSubjectById(subjId);if(subj){lessons[i]={name:subj.name,room:subj.room||'',teacher:subj.teacher||''};hasAny=true}}
      }
      const data={date,lessons:hasAny?lessons:null};
      if(editId)db.ref(`changes/${editId}`).set(data);
      else db.ref('changes').push(data);
      closeModal('change-modal');
    }
    function deleteChange(){const id=document.getElementById('change-edit-id').value;if(id){deleteChangeById(id);closeModal('change-modal')}}
    function deleteChangeById(id){if(!isAdmin)return;if(confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ?'))db.ref(`changes/${id}`).remove()}

    // ===== MODALS =====
    function openModal(id){document.getElementById(id).classList.add('active')}
    function closeModal(id){document.getElementById(id).classList.remove('active')}

    function openLessonModal(day,pair,week){
      if(!isAdmin)return;
      document.getElementById('edit-day').value=day;
      document.getElementById('edit-pair').value=pair;
      document.getElementById('edit-week').value=week;
      const lesson=schedule[week]?.[day]?.[pair]||{};
      let currentSubjId='';
      if(lesson.name){const subj=subjectsList.find(s=>s.name===lesson.name);if(subj)currentSubjId=subj.id}
      createCustomSelect('lesson-select-container', currentSubjId, null);
      openModal('lesson-modal');
    }
    function saveLesson(){
      if(!isAdmin)return;
      const day=document.getElementById('edit-day').value,pair=document.getElementById('edit-pair').value,week=document.getElementById('edit-week').value;
      const subjId=getCustomSelectValue('lesson-select-container');
      if(subjId){const subj=getSubjectById(subjId);if(subj)db.ref(`schedule/${week}/${day}/${pair}`).set({name:subj.name,room:subj.room||'',teacher:subj.teacher||''})}
      else db.ref(`schedule/${week}/${day}/${pair}`).remove();
      closeModal('lesson-modal');
    }
    function deleteLesson(){
      if(!isAdmin)return;
      db.ref(`schedule/${document.getElementById('edit-week').value}/${document.getElementById('edit-day').value}/${document.getElementById('edit-pair').value}`).remove();
      closeModal('lesson-modal');
    }

    // Old HW
    function openHomeworkModal(dateKey,pair,subject){
      if(!isAdmin)return;
      document.getElementById('hw-date').value=dateKey;document.getElementById('hw-pair').value=pair;
      document.getElementById('hw-subject').value=subject;document.getElementById('hw-task').value='';
      openModal('homework-modal');
    }
    function saveHomework(){
      if(!isAdmin)return;
      const task=document.getElementById('hw-task').value.trim();
      if(!task){alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ');return}
      db.ref('homework').push({date:document.getElementById('hw-date').value,pair:parseInt(document.getElementById('hw-pair').value),subject:document.getElementById('hw-subject').value,task,done:false,created:new Date().toISOString()});
      closeModal('homework-modal');
    }
    function toggleHW(id){const hw=homeworkList.find(h=>h.id===id);if(hw)db.ref(`homework/${id}/done`).set(!hw.done)}
    function deleteHW(id){if(!isAdmin)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`homework/${id}`).remove()}

    // Times
    function openTimesModal(){
      if(!isAdmin)return;
      document.getElementById('times-form').innerHTML=settings.pairTimes.map((t,i)=>`
        <div class="form-group" style="display:flex;gap:10px;align-items:center;margin-bottom:12px;">
          <span style="min-width:50px;font-weight:500;">${i+1} –ø–∞—Ä–∞</span>
          <input type="time" id="time-start-${i}" value="${t.start}" class="setting-input" style="flex:1;">
          <span style="color:var(--text-muted);">‚Äî</span>
          <input type="time" id="time-end-${i}" value="${t.end}" class="setting-input" style="flex:1;">
        </div>`).join('');
      openModal('times-modal');
    }
    function savePairTimes(){
      if(!isAdmin)return;const times=[];
      for(let i=0;i<5;i++)times.push({start:document.getElementById(`time-start-${i}`).value,end:document.getElementById(`time-end-${i}`).value});
      db.ref('settings/pairTimes').set(times);closeModal('times-modal');
    }

    function clearAllData(){if(!isAdmin)return;if(confirm('–£–¥–∞–ª–∏—Ç—å –í–°–Å?')){db.ref('schedule').remove();db.ref('homework').remove();db.ref('newHomework').remove();db.ref('changes').remove();db.ref('subjects').remove()}}

    document.querySelectorAll('.modal-overlay').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active')})});
    document.getElementById('login-password').addEventListener('keypress',e=>{if(e.key==='Enter')login()});
    document.getElementById('login-email').addEventListener('keypress',e=>{if(e.key==='Enter')document.getElementById('login-password').focus()});
  </script>
</body>
</html>
