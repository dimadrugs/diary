<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ú–æ–π –î–Ω–µ–≤–Ω–∏–∫</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#ffffff">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f5f7;
      --bg-card: #ffffff;
      --bg-elevated: #ffffff;
      --bg-input: #f0f0f2;
      --bg-overlay: rgba(0,0,0,.4);
      --text: #1a1a2e;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;
      --accent: #6c5ce7;
      --accent-light: #a29bfe;
      --accent-bg: rgba(108,92,231,.08);
      --accent-bg2: rgba(108,92,231,.15);
      --green: #00b894;
      --green-bg: rgba(0,184,148,.1);
      --red: #e17055;
      --red-bg: rgba(225,112,85,.1);
      --orange: #fdcb6e;
      --orange-bg: rgba(253,203,110,.15);
      --border: rgba(0,0,0,.06);
      --shadow: 0 2px 16px rgba(0,0,0,.06);
      --shadow-lg: 0 8px 30px rgba(0,0,0,.1);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-xs: 8px;
      --bottom-nav-h: 64px;
    }

    [data-theme="dark"] {
      --bg: #0f0f1a;
      --bg-card: #1a1a2e;
      --bg-elevated: #22223a;
      --bg-input: #2a2a42;
      --bg-overlay: rgba(0,0,0,.7);
      --text: #eeeef0;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --accent: #a29bfe;
      --accent-light: #6c5ce7;
      --accent-bg: rgba(162,155,254,.1);
      --accent-bg2: rgba(162,155,254,.18);
      --border: rgba(255,255,255,.06);
      --shadow: 0 2px 16px rgba(0,0,0,.2);
      --shadow-lg: 0 8px 30px rgba(0,0,0,.3);
    }

    * {
      margin: 0; padding: 0; box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html { height: -webkit-fill-available; }

    body {
      font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      transition: background .3s, color .3s;
    }

    /* ========== SCROLLBAR ========== */
    ::-webkit-scrollbar { width: 0; height: 0; }

    /* ========== LOGIN ========== */
    .login-wrap {
      min-height: 100vh; display: flex;
      align-items: center; justify-content: center;
      padding: 24px;
      background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 50%, #74b9ff 100%);
    }

    .login-box {
      width: 100%; max-width: 380px;
      background: var(--bg-card);
      border-radius: 24px;
      padding: 40px 28px 32px;
      box-shadow: 0 20px 60px rgba(0,0,0,.15);
    }

    .login-icon { text-align: center; font-size: 56px; margin-bottom: 8px; }

    .login-box h1 {
      text-align: center; font-size: 24px; font-weight: 900;
      color: var(--text); margin-bottom: 4px;
    }

    .login-box .sub { text-align: center; color: var(--text-muted); font-size: 14px; margin-bottom: 28px; }

    .login-err {
      background: var(--red-bg); color: var(--red);
      padding: 12px; border-radius: var(--radius-xs);
      text-align: center; margin-bottom: 16px;
      font-size: 14px; font-weight: 600;
      display: none;
    }

    .field { margin-bottom: 16px; }
    .field label { display: block; font-size: 13px; font-weight: 700; color: var(--text-secondary); margin-bottom: 6px; }

    .field input, .field textarea, .field select {
      width: 100%; padding: 14px 16px;
      background: var(--bg-input);
      border: 2px solid transparent;
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 15px; font-family: inherit;
      transition: border-color .2s;
      outline: none;
      -webkit-appearance: none;
    }

    .field input:focus, .field textarea:focus { border-color: var(--accent); }
    .field textarea { resize: vertical; min-height: 90px; line-height: 1.5; }

    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      padding: 14px 24px; border: none;
      border-radius: var(--radius-sm);
      font-size: 15px; font-weight: 700;
      font-family: inherit; cursor: pointer;
      transition: transform .15s, opacity .15s;
      position: relative; overflow: hidden;
    }

    .btn:active { transform: scale(.97); }
    .btn-full { width: 100%; }

    .btn-accent {
      background: var(--accent); color: #fff;
      box-shadow: 0 4px 14px rgba(108,92,231,.35);
    }

    .btn-ghost {
      background: var(--bg-input); color: var(--text);
    }

    .btn-red { background: var(--red); color: #fff; }
    .btn-green { background: var(--green); color: #fff; }
    .btn-sm { padding: 8px 14px; font-size: 13px; border-radius: var(--radius-xs); }
    .btn-xs { padding: 6px 10px; font-size: 12px; border-radius: 6px; }
    .btn-icon-only { width: 44px; height: 44px; padding: 0; border-radius: var(--radius-sm); }

    .sep {
      display: flex; align-items: center; gap: 12px;
      margin: 20px 0; color: var(--text-muted); font-size: 13px;
    }
    .sep::before, .sep::after { content:''; flex:1; height:1px; background: var(--border); }

    /* ========== APP SHELL ========== */
    #app { display: none; padding-bottom: calc(var(--bottom-nav-h) + env(safe-area-inset-bottom) + 8px); }

    /* ---- Top bar ---- */
    .topbar {
      position: sticky; top: 0; z-index: 90;
      background: var(--bg);
      padding: 12px 20px 8px;
      padding-top: calc(12px + env(safe-area-inset-top));
      transition: background .3s;
    }

    .topbar-row {
      display: flex; justify-content: space-between; align-items: center;
    }

    .topbar-left h1 {
      font-size: 26px; font-weight: 900;
      background: linear-gradient(135deg, var(--accent), #74b9ff);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .topbar-left .today-text { font-size: 13px; color: var(--text-muted); font-weight: 600; margin-top: 1px; }

    .topbar-right { display: flex; align-items: center; gap: 8px; }

    .week-badge {
      padding: 5px 12px; border-radius: 20px;
      font-size: 12px; font-weight: 800;
    }
    .week-badge.upper { background: var(--green-bg); color: var(--green); }
    .week-badge.lower { background: var(--red-bg); color: var(--red); }

    .avatar-btn {
      width: 38px; height: 38px;
      border-radius: 50%; border: none;
      background: var(--accent-bg);
      color: var(--accent);
      font-size: 16px; font-weight: 800;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }

    /* ---- Profile dropdown ---- */
    .profile-drop {
      position: absolute; top: calc(100% + 8px); right: 20px;
      background: var(--bg-elevated);
      border-radius: var(--radius);
      padding: 8px;
      min-width: 200px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border);
      display: none; z-index: 200;
    }

    .profile-drop.show { display: block; animation: dropIn .2s ease; }

    @keyframes dropIn {
      from { opacity:0; transform: translateY(-8px) scale(.96); }
      to { opacity:1; transform: translateY(0) scale(1); }
    }

    .profile-drop .pd-item {
      display: flex; align-items: center; gap: 10px;
      padding: 12px; border-radius: var(--radius-xs);
      font-size: 14px; font-weight: 600;
      color: var(--text); cursor: pointer; border: none;
      background: none; width: 100; font-family: inherit;
      transition: background .15s; width: 100%;
      text-align: left;
    }

    .profile-drop .pd-item:hover { background: var(--bg-input); }
    .profile-drop .pd-item.danger { color: var(--red); }
    .profile-drop .pd-email { padding: 12px; font-size: 13px; color: var(--text-muted); border-bottom: 1px solid var(--border); margin-bottom: 4px; }
    .profile-drop .pd-email .admin-tag { background: var(--accent); color:#fff; padding:2px 6px; border-radius:4px; font-size:11px; font-weight:800; margin-left:6px; }

    /* ---- Day tabs ---- */
    .day-tabs-wrap {
      padding: 0 20px; margin-bottom: 12px;
    }

    .day-tabs {
      display: flex; gap: 6px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding: 4px 0;
    }

    .day-tabs::-webkit-scrollbar { display: none; }

    .day-tab {
      flex: 1; min-width: 52px;
      display: flex; flex-direction: column;
      align-items: center; gap: 4px;
      padding: 10px 6px 12px;
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      border: 2px solid transparent;
      cursor: pointer; transition: all .2s;
      position: relative;
      box-shadow: var(--shadow);
    }

    .day-tab .dt-name { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
    .day-tab .dt-num { font-size: 18px; font-weight: 900; color: var(--text); }
    .day-tab:active { transform: scale(.96); }

    .day-tab.active {
      border-color: var(--accent);
      background: var(--accent-bg);
    }

    .day-tab.active .dt-name { color: var(--accent); }
    .day-tab.active .dt-num { color: var(--accent); }

    .day-tab.is-today::after {
      content: ''; position: absolute; bottom: 5px;
      width: 5px; height: 5px; border-radius: 50%;
      background: var(--accent);
    }

    .day-tab .dt-dot-change {
      position: absolute; top: 5px; right: 5px;
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--orange);
    }

    /* ---- Week nav ---- */
    .week-nav {
      display: flex; align-items: center; justify-content: center;
      gap: 16px; padding: 0 20px; margin-bottom: 16px;
    }

    .week-nav-btn {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--bg-card); border: 1px solid var(--border);
      color: var(--text); font-size: 18px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all .15s; box-shadow: var(--shadow);
    }
    .week-nav-btn:active { transform: scale(.92); }

    .week-nav-label { text-align: center; }
    .week-nav-label .wn-range { font-size: 16px; font-weight: 800; color: var(--text); }
    .week-nav-label .wn-type { font-size: 12px; font-weight: 700; margin-top: 2px; }
    .week-nav-label .wn-type.upper { color: var(--green); }
    .week-nav-label .wn-type.lower { color: var(--red); }

    /* ---- Content area ---- */
    .content { padding: 0 20px; }
    .page { display: none; }
    .page.active { display: block; animation: pageIn .3s ease; }

    @keyframes pageIn {
      from { opacity:0; transform: translateY(16px); }
      to { opacity:1; transform: translateY(0); }
    }

    /* ---- Lesson cards ---- */
    .lessons-wrap { display: flex; flex-direction: column; gap: 10px; }

    .lesson-card {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      display: flex; gap: 14px;
      transition: transform .15s;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .lesson-card:active { transform: scale(.985); }

    .lesson-card.is-changed {
      border-left: 4px solid var(--orange);
    }

    .lesson-card.is-empty {
      opacity: .45; background: var(--bg-card);
    }

    .pair-badge {
      width: 48px; min-height: 56px;
      background: var(--accent-bg);
      border-radius: var(--radius-sm);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 2px; flex-shrink: 0;
    }

    .pair-badge .pb-n { font-size: 20px; font-weight: 900; color: var(--accent); }
    .pair-badge .pb-t { font-size: 10px; font-weight: 600; color: var(--text-muted); }

    .lesson-body { flex: 1; min-width: 0; }
    .lesson-body .lb-name { font-size: 16px; font-weight: 800; color: var(--text); margin-bottom: 4px; }

    .lesson-body .lb-meta {
      display: flex; flex-wrap: wrap; gap: 8px;
      font-size: 13px; color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .lesson-body .lb-meta span { display: flex; align-items: center; gap: 4px; }
    .lesson-body .lb-empty { color: var(--text-muted); font-size: 14px; font-style: italic; }

    /* HW inside lesson */
    .inline-hw {
      margin-top: 10px; padding: 12px;
      background: var(--accent-bg);
      border-radius: var(--radius-xs);
      border-left: 3px solid var(--accent);
    }

    .inline-hw.done {
      opacity: .5; border-left-color: var(--green);
    }

    .inline-hw .ihw-top {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 4px;
    }

    .inline-hw .ihw-label { font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--accent); letter-spacing: .5px; }
    .inline-hw .ihw-text { font-size: 14px; line-height: 1.5; color: var(--text); }
    .inline-hw.done .ihw-text { text-decoration: line-through; }
    .inline-hw .ihw-actions { display: flex; gap: 4px; }

    .lesson-actions {
      position: absolute; top: 12px; right: 12px;
      display: flex; gap: 4px;
    }

    /* ---- HW page ---- */
    .hw-list { display: flex; flex-direction: column; gap: 12px; }

    .hw-item {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      border-left: 4px solid var(--accent);
      position: relative;
    }

    .hw-item .hwi-subj {
      font-size: 15px; font-weight: 800; color: var(--accent);
      display: flex; align-items: center; gap: 6px;
      margin-bottom: 6px;
    }

    .hw-item .hwi-due {
      font-size: 12px; color: var(--text-muted); font-weight: 600;
      margin-bottom: 10px;
      display: flex; align-items: center; gap: 4px;
    }

    .hw-item .hwi-task {
      font-size: 14px; line-height: 1.6; color: var(--text);
      padding: 12px; background: var(--bg-input);
      border-radius: var(--radius-xs);
      margin-bottom: 12px;
    }

    .hw-item .hwi-btns { display: flex; gap: 6px; }

    .page-head {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px; gap: 12px; flex-wrap: wrap;
    }

    .page-head h2 { font-size: 22px; font-weight: 900; }
    .empty-state { text-align: center; padding: 48px 20px; color: var(--text-muted); }
    .empty-state .es-icon { font-size: 48px; margin-bottom: 12px; }
    .empty-state .es-text { font-size: 15px; font-weight: 600; }

    /* ---- Subjects ---- */
    .subj-grid { display: flex; flex-direction: column; gap: 8px; }

    .subj-row {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 16px;
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .subj-row .sr-icon {
      width: 42px; height: 42px;
      background: var(--accent-bg);
      border-radius: var(--radius-sm);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; flex-shrink: 0;
    }

    .subj-row .sr-info { flex: 1; min-width: 0; }
    .subj-row .sr-name { font-weight: 800; font-size: 15px; }
    .subj-row .sr-meta { font-size: 13px; color: var(--text-secondary); display: flex; gap: 8px; flex-wrap: wrap; }
    .subj-row .sr-actions { display: flex; gap: 4px; }

    /* ---- Changes ---- */
    .chg-item {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      border-left: 4px solid var(--orange);
      margin-bottom: 12px;
    }

    .chg-item .ci-head {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px; gap: 8px; flex-wrap: wrap;
    }

    .chg-item .ci-date { font-weight: 800; font-size: 15px; color: var(--orange); }
    .chg-item .ci-btns { display: flex; gap: 4px; }

    .chg-lesson {
      display: flex; align-items: center; gap: 10px;
      padding: 10px; background: var(--bg-input);
      border-radius: var(--radius-xs);
      margin-bottom: 6px;
    }

    .chg-lesson .cl-num {
      width: 28px; height: 28px;
      background: var(--orange-bg); border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 900; font-size: 13px; color: #e17055; flex-shrink: 0;
    }

    .chg-lesson .cl-name { font-weight: 700; font-size: 14px; }
    .chg-lesson .cl-meta { font-size: 12px; color: var(--text-muted); }

    /* ---- Settings ---- */
    .settings-list { display: flex; flex-direction: column; gap: 8px; }

    .setting-card {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px;
      background: var(--bg-card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      gap: 12px; flex-wrap: wrap;
      border: 1px solid var(--border);
    }

    .setting-card .sc-info h4 { font-size: 15px; font-weight: 800; margin-bottom: 2px; }
    .setting-card .sc-info p { font-size: 13px; color: var(--text-muted); }

    /* ---- Bottom nav ---- */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: calc(var(--bottom-nav-h) + env(safe-area-inset-bottom));
      padding-bottom: env(safe-area-inset-bottom);
      background: var(--bg-elevated);
      border-top: 1px solid var(--border);
      display: flex;
      z-index: 100;
      box-shadow: 0 -2px 20px rgba(0,0,0,.06);
    }

    [data-theme="dark"] .bottom-nav { box-shadow: 0 -2px 20px rgba(0,0,0,.3); }

    .bnav-item {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 3px;
      border: none; background: none;
      color: var(--text-muted); cursor: pointer;
      font-family: inherit; font-size: 10px; font-weight: 700;
      transition: color .2s;
      position: relative;
      padding: 0;
    }

    .bnav-item .bi-icon { font-size: 22px; line-height: 1; transition: transform .15s; }
    .bnav-item:active .bi-icon { transform: scale(.85); }

    .bnav-item.active { color: var(--accent); }
    .bnav-item.active .bi-icon { transform: scale(1.1); }

    .bnav-item .bi-badge {
      position: absolute; top: 4px; right: calc(50% - 20px);
      min-width: 16px; height: 16px;
      background: var(--red); color: #fff;
      border-radius: 8px; font-size: 10px; font-weight: 800;
      display: flex; align-items: center; justify-content: center;
      padding: 0 4px;
    }

    /* ---- Modal ---- */
    .modal-bg {
      position: fixed; inset: 0;
      background: var(--bg-overlay);
      z-index: 500;
      display: none; align-items: flex-end; justify-content: center;
    }

    .modal-bg.show { display: flex; }

    .modal-sheet {
      background: var(--bg-elevated);
      border-radius: 24px 24px 0 0;
      padding: 8px 24px calc(24px + env(safe-area-inset-bottom));
      width: 100%; max-width: 520px;
      max-height: 92vh; overflow-y: auto;
      animation: sheetUp .3s cubic-bezier(.32,.72,0,1);
    }

    @keyframes sheetUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-handle {
      width: 36px; height: 4px;
      background: var(--text-muted); opacity: .3;
      border-radius: 2px; margin: 8px auto 20px;
    }

    .modal-sheet h3 { font-size: 20px; font-weight: 900; margin-bottom: 20px; }
    .modal-btns { display: flex; gap: 8px; margin-top: 24px; }
    .modal-btns .btn { flex: 1; }

    /* ---- Custom select ---- */
    .csel-trigger {
      display: flex; align-items: center; gap: 10px;
      padding: 14px 16px;
      background: var(--bg-input);
      border: 2px solid transparent;
      border-radius: var(--radius-sm);
      cursor: pointer; transition: border-color .2s;
      min-height: 52px;
    }

    .csel-trigger:hover, .csel-trigger.open { border-color: var(--accent); }

    .csel-trigger .ct-icon {
      width: 32px; height: 32px;
      background: var(--accent-bg);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; flex-shrink: 0;
    }

    .csel-trigger .ct-text { flex: 1; min-width: 0; }
    .csel-trigger .ct-name { font-weight: 700; font-size: 14px; }
    .csel-trigger .ct-meta { font-size: 12px; color: var(--text-muted); }
    .csel-trigger .ct-ph { color: var(--text-muted); font-size: 14px; }
    .csel-trigger .ct-arr { color: var(--text-muted); font-size: 10px; transition: transform .2s; }
    .csel-trigger.open .ct-arr { transform: rotate(180deg); }

    .csel-dd {
      position: absolute; top: 100%; left: 0; right: 0;
      background: var(--bg-elevated);
      border: 2px solid var(--accent);
      border-top: 1px solid var(--border);
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      max-height: 200px; overflow-y: auto;
      z-index: 50; display: none;
      box-shadow: var(--shadow-lg);
    }
    .csel-dd.open { display: block; }

    .csel-opt {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 16px; cursor: pointer;
      transition: background .12s;
      border-bottom: 1px solid var(--border);
    }
    .csel-opt:last-child { border-bottom: none; }
    .csel-opt:hover { background: var(--accent-bg); }
    .csel-opt.sel { background: var(--accent-bg2); }

    .csel-opt .co-icon {
      width: 28px; height: 28px;
      background: var(--accent-bg); border-radius: 7px;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; flex-shrink: 0;
    }
    .csel-opt .co-name { font-weight: 700; font-size: 14px; }
    .csel-opt .co-meta { font-size: 11px; color: var(--text-muted); }
    .csel-opt.empty-opt .co-icon { background: var(--red-bg); color: var(--red); }

    .csel-wrap { position: relative; width: 100%; }

    /* ---- Changes pair editor ---- */
    .cpair-block {
      background: var(--bg-input); border-radius: var(--radius-xs);
      padding: 14px; margin-bottom: 10px;
    }
    .cpair-block .cpb-head {
      display: flex; align-items: center; gap: 8px;
      margin-bottom: 10px;
    }
    .cpair-block .cpb-num {
      width: 26px; height: 26px;
      background: var(--accent-bg); border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 900; font-size: 13px; color: var(--accent);
    }
    .cpair-block .cpb-label { font-weight: 700; font-size: 14px; color: var(--text-secondary); }

    .admin-hide { display: none; }

    /* ---- Responsive ---- */
    @media (max-width: 400px) {
      .topbar-left h1 { font-size: 22px; }
      .day-tab { min-width: 46px; padding: 8px 4px 10px; }
      .day-tab .dt-num { font-size: 16px; }
      .lesson-card { padding: 14px; gap: 10px; }
      .pair-badge { width: 42px; }
      .pair-badge .pb-n { font-size: 18px; }
    }

    @media (min-width: 768px) {
      .content { max-width: 600px; margin: 0 auto; }
      .day-tabs-wrap { max-width: 600px; margin: 0 auto 12px; }
      .week-nav { max-width: 600px; margin: 0 auto 16px; }
      .topbar { max-width: 100%; }
      .topbar > .topbar-row { max-width: 600px; margin: 0 auto; }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="login-wrap">
  <div class="login-box">
    <div class="login-icon">üìö</div>
    <h1>–î–Ω–µ–≤–Ω–∏–∫</h1>
    <p class="sub">–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç</p>
    <div class="login-err" id="login-err"></div>
    <div class="field"><label>Email</label><input type="email" id="l-email" placeholder="your@email.com" autocomplete="email"></div>
    <div class="field"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
    <button class="btn btn-accent btn-full" onclick="doLogin()">–í–æ–π—Ç–∏</button>
    <div class="sep">–∏–ª–∏</div>
    <button class="btn btn-ghost btn-full" onclick="guestLogin()">–í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-row">
      <div class="topbar-left">
        <h1>–î–Ω–µ–≤–Ω–∏–∫</h1>
        <div class="today-text" id="top-today"></div>
      </div>
      <div class="topbar-right">
        <span class="week-badge" id="top-week-badge"></span>
        <button class="avatar-btn" id="avatar-btn" onclick="toggleProfile()"></button>
      </div>
    </div>
    <div class="profile-drop" id="profile-drop">
      <div class="pd-email" id="pd-email"></div>
      <button class="pd-item" onclick="toggleTheme()">üé® –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
      <button class="pd-item danger" onclick="doLogout()">üö™ –í—ã–π—Ç–∏</button>
    </div>
  </div>

  <!-- Week nav -->
  <div class="week-nav">
    <button class="week-nav-btn" onclick="prevWeek()">‚Äπ</button>
    <div class="week-nav-label">
      <div class="wn-range" id="wn-range"></div>
      <div class="wn-type" id="wn-type"></div>
    </div>
    <button class="week-nav-btn" onclick="nextWeek()">‚Ä∫</button>
  </div>

  <!-- Day tabs -->
  <div class="day-tabs-wrap" id="dtw">
    <div class="day-tabs" id="day-tabs"></div>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- Schedule -->
    <div class="page active" id="pg-schedule">
      <div class="lessons-wrap" id="lessons-wrap"></div>
    </div>

    <!-- Homework -->
    <div class="page" id="pg-hw">
      <div class="page-head">
        <h2>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
        <button class="btn btn-accent btn-sm admin-hide" id="add-hw-btn" onclick="openNewHwModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="hw-list" id="hw-list"></div>
    </div>

    <!-- Changes -->
    <div class="page admin-hide" id="pg-changes">
      <div class="page-head">
        <h2>–ó–∞–º–µ–Ω—ã</h2>
        <button class="btn btn-accent btn-sm" onclick="openChgModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div id="chg-list"></div>
    </div>

    <!-- Subjects -->
    <div class="page admin-hide" id="pg-subjects">
      <div class="page-head">
        <h2>–ü—Ä–µ–¥–º–µ—Ç—ã</h2>
        <button class="btn btn-accent btn-sm" onclick="openSubjModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="subj-grid" id="subj-list"></div>
    </div>

    <!-- Settings -->
    <div class="page admin-hide" id="pg-settings">
      <h2 style="margin-bottom:20px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <div class="settings-list">
        <div class="setting-card">
          <div class="sc-info"><h4>–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª—å</h4><p>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤–µ—Ä—Ö–Ω–µ–π</p></div>
          <input type="date" class="field-inline" id="cfg-week-start" style="padding:10px;background:var(--bg-input);border:2px solid var(--border);border-radius:var(--radius-xs);color:var(--text);font-family:inherit;">
        </div>
        <div class="setting-card">
          <div class="sc-info"><h4>–í—Ä–µ–º—è –ø–∞—Ä</h4><p>–ù–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü</p></div>
          <button class="btn btn-ghost btn-sm" onclick="openTimesModal()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div class="setting-card">
          <div class="sc-info"><h4>–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</h4><p>–£–¥–∞–ª–∏—Ç—å –≤—Å—ë</p></div>
          <button class="btn btn-red btn-sm" onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom nav -->
  <nav class="bottom-nav" id="bottom-nav">
    <button class="bnav-item active" data-pg="pg-schedule">
      <span class="bi-icon">üìÖ</span><span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
    </button>
    <button class="bnav-item" data-pg="pg-hw" id="bn-hw">
      <span class="bi-icon">üìù</span><span>–î–ó</span>
    </button>
    <button class="bnav-item admin-hide" data-pg="pg-changes">
      <span class="bi-icon">üîÑ</span><span>–ó–∞–º–µ–Ω—ã</span>
    </button>
    <button class="bnav-item admin-hide" data-pg="pg-subjects">
      <span class="bi-icon">üìñ</span><span>–ü—Ä–µ–¥–º–µ—Ç—ã</span>
    </button>
    <button class="bnav-item admin-hide" data-pg="pg-settings">
      <span class="bi-icon">‚öôÔ∏è</span><span>–ï—â—ë</span>
    </button>
  </nav>
</div>

<!-- MODALS -->
<div class="modal-bg" id="m-lesson">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—É</h3>
    <input type="hidden" id="el-day"><input type="hidden" id="el-pair"><input type="hidden" id="el-week">
    <div class="field"><label>–ü—Ä–µ–¥–º–µ—Ç</label><div id="el-sel-c"></div></div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="closeM('m-lesson')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-red" onclick="delLesson()">–£–±—Ä–∞—Ç—å</button>
      <button class="btn btn-accent" onclick="saveLesson()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="m-hw-inline">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h3>
    <input type="hidden" id="hi-date"><input type="hidden" id="hi-pair">
    <div class="field"><label>–ü—Ä–µ–¥–º–µ—Ç</label><input type="text" id="hi-subj" readonly style="opacity:.6;"></div>
    <div class="field"><label>–ó–∞–¥–∞–Ω–∏–µ</label><textarea id="hi-task" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å..."></textarea></div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="closeM('m-hw-inline')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-accent" onclick="saveInlineHw()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="m-new-hw">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3>–ù–æ–≤–æ–µ –î–ó</h3>
    <div class="field"><label>–ü—Ä–µ–¥–º–µ—Ç</label><div id="nhw-sel"></div></div>
    <div class="field"><label>–ó–∞–¥–∞–Ω–∏–µ</label><textarea id="nhw-task" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ..."></textarea></div>
    <div class="field"><label>–ë–ª–∏–∂–∞–π—à–∞—è –ø–∞—Ä–∞</label>
      <div id="nhw-next" style="padding:14px;background:var(--bg-input);border-radius:var(--radius-xs);font-size:14px;color:var(--text-muted);min-height:48px;display:flex;align-items:center;gap:6px;">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...</div>
    </div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="closeM('m-new-hw')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-accent" onclick="saveNewHw()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="m-subj">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 id="subj-m-title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</h3>
    <input type="hidden" id="se-id">
    <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="se-name" placeholder="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"></div>
    <div class="field"><label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label><input type="text" id="se-room" placeholder="–ö–∞–±. 301"></div>
    <div class="field"><label>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</label><input type="text" id="se-teacher" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò."></div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="closeM('m-subj')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-accent" onclick="saveSubj()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="m-chg">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3>–ó–∞–º–µ–Ω–∞ –Ω–∞ –¥–∞—Ç—É</h3>
    <input type="hidden" id="ce-id">
    <div class="field"><label>–î–∞—Ç–∞</label><input type="date" id="ce-date"></div>
    <p style="color:var(--text-muted);font-size:13px;margin-bottom:16px;">–ó–∞–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É. –ü—É—Å—Ç–æ–µ = –Ω–µ—Ç –ø–∞—Ä—ã.</p>
    <div id="ce-pairs"></div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="closeM('m-chg')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-red" id="ce-del" onclick="delChg()" style="display:none;">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn btn-accent" onclick="saveChg()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="m-times">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3>–í—Ä–µ–º—è –ø–∞—Ä</h3>
    <div id="times-form"></div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="closeM('m-times')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-accent" onclick="saveTimes()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
/* ===== Theme ===== */
function initTheme(){setTheme(localStorage.getItem('th')||(matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'))}
function setTheme(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('th',t);document.querySelector('meta[name="theme-color"]').content=t==='dark'?'#0f0f1a':'#f5f5f7'}
function toggleTheme(){setTheme(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark')}
initTheme();

/* ===== Firebase ===== */
firebase.initializeApp({apiKey:"AIzaSyBCy0hz_PHMGUX2M52Wnwb0C9nEnBBfeq8",authDomain:"my-diary-e223c.firebaseapp.com",databaseURL:"https://my-diary-e223c-default-rtdb.firebaseio.com",projectId:"my-diary-e223c",storageBucket:"my-diary-e223c.firebasestorage.app",messagingSenderId:"903986378920",appId:"1:903986378920:web:b6ebc6691f6d767f78aa9d"});
const auth=firebase.auth(),db=firebase.database();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

/* ===== State ===== */
const ADMINS=["zFKU6TAgIuhZetCOuWpHvDDw6Oj2"];
const DSK=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'],DFL=['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
let curUser=null,isAdmin=false,isGuest=false;
let sched={upper:{},lower:{}},hwData=[],chgData=[],nhwData=[],subjData=[];
let cfg={weekStartDate:null,pairTimes:[{start:'08:30',end:'10:00'},{start:'10:10',end:'11:40'},{start:'12:10',end:'13:40'},{start:'13:50',end:'15:20'},{start:'15:30',end:'17:00'}]};
let vwMon=getMon(new Date()),selDayIdx=todayIdx(),csState={};

/* ===== Helpers ===== */
function getMon(d){const r=new Date(d);r.setHours(12,0,0,0);const w=r.getDay();r.setDate(r.getDate()-w+(w===0?-6:1));return r}
function fdk(d){const r=new Date(d);return`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,'0')}-${String(r.getDate()).padStart(2,'0')}`}
function pdk(s){const[y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d,12)}
function fds(d){return String(new Date(d).getDate()).padStart(2,'0')+'.'+String(new Date(d).getMonth()+1).padStart(2,'0')}
function fdFull(d){return new Date(d).toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'})}
function fdShort(d){return new Date(d).toLocaleDateString('ru-RU',{day:'numeric',month:'short'})}
function todayIdx(){const w=new Date().getDay();return w===0?5:(w-1)}
function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML}

function gwt(mon){
  if(!cfg.weekStartDate){const s=new Date(mon.getFullYear(),0,1);return Math.ceil(((mon-s)/864e5+s.getDay()+1)/7)%2===1?'upper':'lower'}
  const sd=getMon(pdk(cfg.weekStartDate));return Math.floor(Math.round((mon-sd)/864e5)/7)%2===0?'upper':'lower';
}

function lessonsFor(dk){
  const d=pdk(dk),dow=d.getDay();if(dow===0)return{};
  const di=dow-1;if(di>5)return{};
  const ch=chgData.find(c=>c.date===dk);
  if(ch)return ch.lessons||{};
  return(sched[gwt(getMon(d))]||{})[DSK[di]]||{};
}

function findNext(subj){
  const today=new Date();today.setHours(0,0,0,0);
  for(let o=1;o<=60;o++){
    const cd=new Date(today);cd.setDate(cd.getDate()+o);
    const dow=cd.getDay();if(dow===0||dow>6)continue;
    const dk=fdk(cd),les=lessonsFor(dk);
    for(let p=1;p<=5;p++){const l=les[p];if(l&&l.name&&l.name.toLowerCase().trim()===subj.toLowerCase().trim())return{date:dk,pair:p}}
  }
  return null;
}

function recalcHw(){
  if(!isAdmin)return;
  const tk=fdk(new Date());
  nhwData.forEach(h=>{if(h.done||!h.subject)return;const nx=findNext(h.subject);if(nx&&(nx.date!==h.targetDate||nx.pair!==h.targetPair))db.ref(`newHomework/${h.id}`).update({targetDate:nx.date,targetPair:nx.pair})});
}

/* ===== Auth ===== */
auth.onAuthStateChanged(u=>{if(u){curUser=u;isAdmin=ADMINS.includes(u.uid);isGuest=false;boot()}else if(localStorage.getItem('gs')){isGuest=true;boot()}});

function doLogin(){
  const e=document.getElementById('l-email').value.trim(),p=document.getElementById('l-pass').value;
  if(!e||!p){showLErr('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');return}
  auth.signInWithEmailAndPassword(e,p).catch(()=>showLErr('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'));
}
function showLErr(m){const e=document.getElementById('login-err');e.textContent=m;e.style.display='block'}
function guestLogin(){isGuest=true;isAdmin=false;curUser=null;localStorage.setItem('gs','1');boot()}
function doLogout(){localStorage.removeItem('gs');auth.signOut().then(()=>{isGuest=false;isAdmin=false;curUser=null;document.getElementById('app').style.display='none';document.getElementById('login-screen').style.display='flex';document.getElementById('profile-drop').classList.remove('show')})}

function boot(){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='block';
  const letter=(isGuest?'–ì':(curUser?.email?.[0]||'?')).toUpperCase();
  document.getElementById('avatar-btn').textContent=letter;
  const eml=document.getElementById('pd-email');
  eml.innerHTML=(isGuest?'–ì–æ—Å—Ç—å':esc(curUser?.email||''))+(isAdmin?'<span class="admin-tag">–ê–¥–º–∏–Ω</span>':'');
  if(isAdmin)document.querySelectorAll('.admin-hide').forEach(e=>e.classList.remove('admin-hide'));
  setupNav();loadData();
  selDayIdx=todayIdx();
  vwMon=getMon(new Date());
  updateAll();
}

/* ===== Profile ===== */
function toggleProfile(){document.getElementById('profile-drop').classList.toggle('show')}
document.addEventListener('click',e=>{if(!e.target.closest('#avatar-btn')&&!e.target.closest('#profile-drop'))document.getElementById('profile-drop').classList.remove('show')});

/* ===== Navigation ===== */
function setupNav(){
  document.querySelectorAll('.bnav-item').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('.bnav-item').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      document.getElementById(b.dataset.pg).classList.add('active');
      const isDiary=b.dataset.pg==='pg-schedule';
      document.getElementById('dtw').style.display=isDiary?'':'none';
      document.querySelector('.week-nav').style.display=isDiary?'':'none';
    });
  });
}

/* ===== Data ===== */
function loadData(){
  db.ref('settings').on('value',s=>{if(s.val()){cfg={...cfg,...s.val()};if(cfg.weekStartDate)document.getElementById('cfg-week-start').value=cfg.weekStartDate}updateAll()});
  db.ref('schedule').on('value',s=>{sched=s.val()||{upper:{},lower:{}};renderDay();recalcHw()});
  db.ref('homework').on('value',s=>{const d=s.val();hwData=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];renderDay()});
  db.ref('subjects').on('value',s=>{const d=s.val();subjData=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];renderSubjects();renderDay()});
  db.ref('newHomework').on('value',s=>{const d=s.val();nhwData=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];renderHwPage();renderDay();updHwBadge()});
  db.ref('changes').on('value',s=>{const d=s.val();chgData=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];cleanOld();renderDay();renderDayTabs();renderChanges();recalcHw()});
  document.getElementById('cfg-week-start').addEventListener('change',e=>{if(isAdmin)db.ref('settings/weekStartDate').set(e.target.value)});
}

function cleanOld(){if(!isAdmin)return;const tk=fdk(new Date());chgData.forEach(c=>{if(c.date<tk)db.ref(`changes/${c.id}`).remove()})}

/* ===== Update ===== */
function updateAll(){updateTopbar();updateWeekNav();renderDayTabs();renderDay()}

function updateTopbar(){
  const t=new Date(),wt=gwt(getMon(t));
  document.getElementById('top-today').textContent=fdFull(t);
  const wb=document.getElementById('top-week-badge');
  wb.textContent=wt==='upper'?'‚ñ≤ –í–µ—Ä—Ö–Ω—è—è':'‚ñº –ù–∏–∂–Ω—è—è';
  wb.className='week-badge '+wt;
}

function updateWeekNav(){
  const e=new Date(vwMon);e.setDate(e.getDate()+5);
  const wt=gwt(vwMon);
  document.getElementById('wn-range').textContent=`${fdShort(vwMon)} ‚Äî ${fdShort(e)}`;
  const tp=document.getElementById('wn-type');
  tp.textContent=wt==='upper'?'‚ñ≤ –í–µ—Ä—Ö–Ω—è—è –Ω–µ–¥–µ–ª—è':'‚ñº –ù–∏–∂–Ω—è—è –Ω–µ–¥–µ–ª—è';
  tp.className='wn-type '+wt;
}

function prevWeek(){vwMon.setDate(vwMon.getDate()-7);selDayIdx=0;updateAll()}
function nextWeek(){vwMon.setDate(vwMon.getDate()+7);selDayIdx=0;updateAll()}

/* ===== Day tabs ===== */
function renderDayTabs(){
  const c=document.getElementById('day-tabs'),tk=fdk(new Date());
  let h='';
  for(let i=0;i<6;i++){
    const d=new Date(vwMon);d.setDate(d.getDate()+i);
    const dk=fdk(d),isT=dk===tk,hasCh=chgData.some(c=>c.date===dk);
    h+=`<div class="day-tab${i===selDayIdx?' active':''}${isT?' is-today':''}" onclick="pickDay(${i})" data-di="${i}">
      ${hasCh?'<span class="dt-dot-change"></span>':''}
      <span class="dt-name">${DSK[i]}</span>
      <span class="dt-num">${d.getDate()}</span>
    </div>`;
  }
  c.innerHTML=h;
  // scroll active into view
  setTimeout(()=>{const a=c.querySelector('.day-tab.active');if(a)a.scrollIntoView({inline:'center',behavior:'smooth'})},50);
}

function pickDay(i){selDayIdx=i;renderDayTabs();renderDay()}

/* ===== Lessons ===== */
function renderDay(){
  const wrap=document.getElementById('lessons-wrap');
  const d=new Date(vwMon);d.setDate(d.getDate()+selDayIdx);
  const dk=fdk(d),wt=gwt(vwMon),dayKey=DSK[selDayIdx];
  const ch=chgData.find(c=>c.date===dk),hasCh=!!ch;
  const lessons=hasCh?(ch.lessons||{}):(sched[wt]?.[dayKey]||{});
  let h='';
  for(let p=1;p<=5;p++){
    const l=lessons[p],has=l&&l.name,time=cfg.pairTimes[p-1];
    const iho=hwData.filter(x=>x.date===dk&&x.pair===p);
    const ihn=nhwData.filter(x=>x.targetDate===dk&&x.targetPair===p);
    h+=`<div class="lesson-card${has?'':' is-empty'}${hasCh&&has?' is-changed':''}" ${isAdmin&&!hasCh?`onclick="openLessonM('${dayKey}',${p},'${wt}')"`:''}>
      <div class="pair-badge"><span class="pb-n">${p}</span><span class="pb-t">${time?.start||''}</span></div>
      <div class="lesson-body">
        ${has?`
          <div class="lb-name">${esc(l.name)}</div>
          <div class="lb-meta">
            ${l.room?`<span>üìç ${esc(l.room)}</span>`:''}
            ${l.teacher?`<span>üë§ ${esc(l.teacher)}</span>`:''}
          </div>
          ${renderIHw(iho,'–î–æ–º–∞—à–∫–∞','hw')}
          ${renderIHw(ihn,'–î–ó','nh')}
        `:`<div class="lb-empty">${isAdmin&&!hasCh?'+ –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—É':'–ù–µ—Ç –ø–∞—Ä—ã'}</div>`}
      </div>
      ${has&&isAdmin?`<div class="lesson-actions"><button class="btn btn-ghost btn-xs" onclick="event.stopPropagation();openInlineHw('${dk}',${p},'${esc(l.name)}')">+ –î–ó</button></div>`:''}
    </div>`;
  }
  wrap.innerHTML=h;
}

function renderIHw(list,label,type){
  if(!list.length)return'';
  return list.map(h=>`<div class="inline-hw${h.done?' done':''}">
    <div class="ihw-top">
      <span class="ihw-label">${label}</span>
      <div class="ihw-actions">
        <button class="btn ${h.done?'btn-ghost':'btn-green'} btn-xs" onclick="event.stopPropagation();${type==='hw'?`togHw('${h.id}')`:`togNH('${h.id}')`}">${h.done?'‚Ü©':'‚úì'}</button>
        ${isAdmin?`<button class="btn btn-red btn-xs" onclick="event.stopPropagation();${type==='hw'?`rmHw('${h.id}')`:`rmNH('${h.id}')`}">‚úï</button>`:''}
      </div>
    </div>
    <div class="ihw-text">${esc(h.task)}</div>
  </div>`).join('');
}

/* ===== HW page ===== */
function renderHwPage(){
  const c=document.getElementById('hw-list'),tk=fdk(new Date());
  const p=nhwData.filter(h=>h.targetDate&&h.targetDate>=tk&&!h.done).sort((a,b)=>a.targetDate.localeCompare(b.targetDate));
  if(!p.length){c.innerHTML='<div class="empty-state"><div class="es-icon">üìö</div><div class="es-text">–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∑–∞–¥–∞–Ω–∏–π</div></div>';return}
  c.innerHTML=p.map(h=>`<div class="hw-item">
    <div class="hwi-subj">üìñ ${esc(h.subject)}</div>
    <div class="hwi-due">üìÖ ${fdFull(pdk(h.targetDate))}, –ø–∞—Ä–∞ ${h.targetPair||'?'}</div>
    <div class="hwi-task">${esc(h.task)}</div>
    <div class="hwi-btns">
      <button class="btn btn-green btn-sm" onclick="togNH('${h.id}')">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>
      ${isAdmin?`<button class="btn btn-red btn-sm" onclick="rmNH('${h.id}')">–£–¥–∞–ª–∏—Ç—å</button>`:''}
    </div>
  </div>`).join('');
}

function updHwBadge(){
  const tk=fdk(new Date()),n=nhwData.filter(h=>h.targetDate&&h.targetDate>=tk&&!h.done).length;
  const bn=document.getElementById('bn-hw');
  const old=bn.querySelector('.bi-badge');if(old)old.remove();
  if(n>0){const b=document.createElement('span');b.className='bi-badge';b.textContent=n;bn.appendChild(b)}
}

/* ===== Subjects ===== */
function renderSubjects(){
  const c=document.getElementById('subj-list');
  if(!subjData.length){c.innerHTML='<div class="empty-state"><div class="es-icon">üìñ</div><div class="es-text">–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã</div></div>';return}
  c.innerHTML=subjData.sort((a,b)=>a.name.localeCompare(b.name)).map(s=>`<div class="subj-row">
    <div class="sr-icon">üìñ</div>
    <div class="sr-info"><div class="sr-name">${esc(s.name)}</div><div class="sr-meta">${s.room?`<span>üìç ${esc(s.room)}</span>`:''}${s.teacher?`<span>üë§ ${esc(s.teacher)}</span>`:''}</div></div>
    <div class="sr-actions"><button class="btn btn-ghost btn-xs" onclick="editSubj('${s.id}')">‚úèÔ∏è</button><button class="btn btn-red btn-xs" onclick="rmSubj('${s.id}')">‚úï</button></div>
  </div>`).join('');
}

function openSubjModal(eid){
  document.getElementById('se-id').value=eid||'';
  document.getElementById('se-name').value='';document.getElementById('se-room').value='';document.getElementById('se-teacher').value='';
  document.getElementById('subj-m-title').textContent=eid?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å':'–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç';
  if(eid){const s=subjData.find(x=>x.id===eid);if(s){document.getElementById('se-name').value=s.name||'';document.getElementById('se-room').value=s.room||'';document.getElementById('se-teacher').value=s.teacher||''}}
  openM('m-subj');
}

function editSubj(id){openSubjModal(id)}

function saveSubj(){
  const id=document.getElementById('se-id').value,n=document.getElementById('se-name').value.trim(),r=document.getElementById('se-room').value.trim(),t=document.getElementById('se-teacher').value.trim();
  if(!n){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return}
  if(id)db.ref(`subjects/${id}`).set({name:n,room:r,teacher:t});else db.ref('subjects').push({name:n,room:r,teacher:t});
  closeM('m-subj');
}

function rmSubj(id){if(confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç?'))db.ref(`subjects/${id}`).remove()}

/* ===== Changes ===== */
function renderChanges(){
  const c=document.getElementById('chg-list'),tk=fdk(new Date());
  const f=chgData.filter(x=>x.date>=tk).sort((a,b)=>a.date.localeCompare(b.date));
  if(!f.length){c.innerHTML='<div class="empty-state"><div class="es-icon">üîÑ</div><div class="es-text">–ù–µ—Ç –∑–∞–º–µ–Ω</div></div>';return}
  c.innerHTML=f.map(ch=>`<div class="chg-item">
    <div class="ci-head"><span class="ci-date">üìÖ ${fdFull(pdk(ch.date))}</span><div class="ci-btns"><button class="btn btn-ghost btn-xs" onclick="editChg('${ch.id}')">‚úèÔ∏è</button><button class="btn btn-red btn-xs" onclick="rmChgById('${ch.id}')">‚úï</button></div></div>
    ${renderChgLessons(ch.lessons)}
  </div>`).join('');
}

function renderChgLessons(les){
  if(!les)return'<div style="padding:8px;color:var(--text-muted);font-size:13px;">–í—Å–µ –ø–∞—Ä—ã —Å–Ω—è—Ç—ã</div>';
  let h='';for(let p=1;p<=5;p++){const l=les[p];if(l&&l.name)h+=`<div class="chg-lesson"><span class="cl-num">${p}</span><div><div class="cl-name">${esc(l.name)}</div><div class="cl-meta">${l.room?'üìç '+esc(l.room):''}${l.teacher?' ¬∑ üë§ '+esc(l.teacher):''}</div></div></div>`}
  return h||'<div style="padding:8px;color:var(--text-muted);font-size:13px;">–í—Å–µ –ø–∞—Ä—ã —Å–Ω—è—Ç—ã</div>';
}

function openChgModal(eid){
  if(!isAdmin)return;
  document.getElementById('ce-id').value=eid||'';
  document.getElementById('ce-del').style.display=eid?'':'none';
  document.getElementById('ce-date').value='';
  let ph='';for(let i=1;i<=5;i++)ph+=`<div class="cpair-block"><div class="cpb-head"><span class="cpb-num">${i}</span><span class="cpb-label">–ø–∞—Ä–∞</span></div><div id="cs-cp-${i}"></div></div>`;
  document.getElementById('ce-pairs').innerHTML=ph;
  for(let i=1;i<=5;i++)buildCS(`cs-cp-${i}`,'',null);
  if(eid){const ch=chgData.find(c=>c.id===eid);if(ch){document.getElementById('ce-date').value=ch.date;if(ch.lessons){for(let i=1;i<=5;i++){const l=ch.lessons[i];if(l&&l.name){const s=subjData.find(x=>x.name===l.name);if(s)buildCS(`cs-cp-${i}`,s.id,null)}}}}}
  openM('m-chg');
}

function editChg(id){openChgModal(id)}

function saveChg(){
  if(!isAdmin)return;
  const eid=document.getElementById('ce-id').value,date=document.getElementById('ce-date').value;
  if(!date){alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');return}
  const lessons={};let any=false;
  for(let i=1;i<=5;i++){const sid=gcsv(`cs-cp-${i}`),subj=subjData.find(s=>s.id===sid);if(subj){lessons[i]={name:subj.name,room:subj.room||'',teacher:subj.teacher||''};any=true}}
  if(eid)db.ref(`changes/${eid}`).set({date,lessons:any?lessons:null});else db.ref('changes').push({date,lessons:any?lessons:null});
  closeM('m-chg');
}

function delChg(){const id=document.getElementById('ce-id').value;if(id){rmChgById(id);closeM('m-chg')}}
function rmChgById(id){if(!isAdmin)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`changes/${id}`).remove()}

/* ===== Custom Select ===== */
function buildCS(cid,selId,onChange){
  const c=document.getElementById(cid);
  const sorted=[...subjData].sort((a,b)=>a.name.localeCompare(b.name));
  const sel=sorted.find(s=>s.id===selId);
  csState[cid]={selectedId:selId||'',onChange};
  let trig;
  if(sel)trig=`<span class="ct-icon">üìñ</span><div class="ct-text"><div class="ct-name">${esc(sel.name)}</div><div class="ct-meta">${sel.room?'üìç '+esc(sel.room):''}${sel.teacher?' ¬∑ üë§ '+esc(sel.teacher):''}</div></div>`;
  else trig=`<span class="ct-ph">‚Äî –ù–µ—Ç –ø–∞—Ä—ã ‚Äî</span>`;
  const opts=sorted.map(s=>`<div class="csel-opt${s.id===selId?' sel':''}" data-sid="${s.id}"><span class="co-icon">üìñ</span><div><div class="co-name">${esc(s.name)}</div><div class="co-meta">${s.room?'üìç '+esc(s.room):''}${s.teacher?' ¬∑ üë§ '+esc(s.teacher):''}</div></div></div>`).join('');
  c.innerHTML=`<div class="csel-wrap"><div class="csel-trigger" data-cid="${cid}">${trig}<span class="ct-arr">‚ñº</span></div><div class="csel-dd" id="${cid}-dd"><div class="csel-opt empty-opt" data-sid=""><span class="co-icon">‚úï</span><div><div class="co-name" style="color:var(--text-muted);">‚Äî –ù–µ—Ç –ø–∞—Ä—ã ‚Äî</div></div></div>${opts}</div></div>`;
  c.querySelector('.csel-trigger').addEventListener('click',e=>{e.stopPropagation();const dd=document.getElementById(cid+'-dd'),tr=c.querySelector('.csel-trigger'),wo=dd.classList.contains('open');closeAllCS();if(!wo){dd.classList.add('open');tr.classList.add('open')}});
  c.querySelectorAll('.csel-opt').forEach(o=>{o.addEventListener('click',e=>{e.stopPropagation();const id=o.dataset.sid,subj=id?subjData.find(s=>s.id===id):null;csState[cid].selectedId=id;const tr=c.querySelector('.csel-trigger');if(subj)tr.innerHTML=`<span class="ct-icon">üìñ</span><div class="ct-text"><div class="ct-name">${esc(subj.name)}</div><div class="ct-meta">${subj.room?'üìç '+esc(subj.room):''}${subj.teacher?' ¬∑ üë§ '+esc(subj.teacher):''}</div></div><span class="ct-arr">‚ñº</span>`;else tr.innerHTML=`<span class="ct-ph">‚Äî –ù–µ—Ç –ø–∞—Ä—ã ‚Äî</span><span class="ct-arr">‚ñº</span>`;c.querySelectorAll('.csel-opt').forEach(x=>x.classList.remove('sel'));o.classList.add('sel');closeAllCS();if(csState[cid].onChange)csState[cid].onChange(id,subj)})});
}

function closeAllCS(){document.querySelectorAll('.csel-dd.open').forEach(d=>d.classList.remove('open'));document.querySelectorAll('.csel-trigger.open').forEach(t=>t.classList.remove('open'))}
function gcsv(id){return csState[id]?.selectedId||''}
document.addEventListener('click',()=>closeAllCS());

/* ===== Lesson modal ===== */
function openLessonM(day,pair,week){
  if(!isAdmin)return;
  document.getElementById('el-day').value=day;document.getElementById('el-pair').value=pair;document.getElementById('el-week').value=week;
  const l=sched[week]?.[day]?.[pair]||{};let csid='';if(l.name){const s=subjData.find(x=>x.name===l.name);if(s)csid=s.id}
  buildCS('el-sel-c',csid,null);openM('m-lesson');
}

function saveLesson(){
  if(!isAdmin)return;
  const d=document.getElementById('el-day').value,p=document.getElementById('el-pair').value,w=document.getElementById('el-week').value,sid=gcsv('el-sel-c'),subj=subjData.find(s=>s.id===sid);
  if(subj)db.ref(`schedule/${w}/${d}/${p}`).set({name:subj.name,room:subj.room||'',teacher:subj.teacher||''});else db.ref(`schedule/${w}/${d}/${p}`).remove();
  closeM('m-lesson');
}

function delLesson(){
  if(!isAdmin)return;
  db.ref(`schedule/${document.getElementById('el-week').value}/${document.getElementById('el-day').value}/${document.getElementById('el-pair').value}`).remove();
  closeM('m-lesson');
}

/* ===== Inline HW ===== */
function openInlineHw(dk,pair,subj){
  if(!isAdmin)return;
  document.getElementById('hi-date').value=dk;document.getElementById('hi-pair').value=pair;document.getElementById('hi-subj').value=subj;document.getElementById('hi-task').value='';
  openM('m-hw-inline');
}

function saveInlineHw(){
  if(!isAdmin)return;
  const task=document.getElementById('hi-task').value.trim();if(!task){alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ');return}
  db.ref('homework').push({date:document.getElementById('hi-date').value,pair:parseInt(document.getElementById('hi-pair').value),subject:document.getElementById('hi-subj').value,task,done:false,created:new Date().toISOString()});
  closeM('m-hw-inline');
}

function togHw(id){const h=hwData.find(x=>x.id===id);if(h)db.ref(`homework/${id}/done`).set(!h.done)}
function rmHw(id){if(!isAdmin)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`homework/${id}`).remove()}

/* ===== New HW modal ===== */
function openNewHwModal(){
  if(!isAdmin)return;
  buildCS('nhw-sel','',(_,subj)=>{
    const info=document.getElementById('nhw-next');
    if(subj&&subj.name){const nx=findNext(subj.name);if(nx)info.innerHTML=`<span style="color:var(--accent);font-weight:700;">üìÖ ${fdFull(pdk(nx.date))}</span>, –ø–∞—Ä–∞ ${nx.pair}`;else info.innerHTML='<span style="color:var(--red)">–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏</span>'}
    else info.innerHTML='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...';
  });
  document.getElementById('nhw-task').value='';document.getElementById('nhw-next').innerHTML='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...';
  openM('m-new-hw');
}

function saveNewHw(){
  if(!isAdmin)return;
  const sid=gcsv('nhw-sel'),subj=subjData.find(s=>s.id===sid);
  if(!subj){alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç');return}
  const task=document.getElementById('nhw-task').value.trim();if(!task){alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ');return}
  const nx=findNext(subj.name);if(!nx){alert('–ü–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');return}
  db.ref('newHomework').push({subject:subj.name,task,targetDate:nx.date,targetPair:nx.pair,done:false,created:new Date().toISOString()});
  closeM('m-new-hw');
}

function togNH(id){const h=nhwData.find(x=>x.id===id);if(h)db.ref(`newHomework/${id}/done`).set(!h.done)}
function rmNH(id){if(!isAdmin)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`newHomework/${id}`).remove()}

/* ===== Times modal ===== */
function openTimesModal(){
  if(!isAdmin)return;
  document.getElementById('times-form').innerHTML=cfg.pairTimes.map((t,i)=>`<div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;"><span style="min-width:60px;font-weight:700;font-size:14px;">${i+1} –ø–∞—Ä–∞</span><input type="time" id="pt-s${i}" value="${t.start}" style="flex:1;padding:12px;background:var(--bg-input);border:2px solid var(--border);border-radius:var(--radius-xs);color:var(--text);font-family:inherit;"><span style="color:var(--text-muted);">‚Äî</span><input type="time" id="pt-e${i}" value="${t.end}" style="flex:1;padding:12px;background:var(--bg-input);border:2px solid var(--border);border-radius:var(--radius-xs);color:var(--text);font-family:inherit;"></div>`).join('');
  openM('m-times');
}

function saveTimes(){
  if(!isAdmin)return;
  const t=[];for(let i=0;i<5;i++)t.push({start:document.getElementById(`pt-s${i}`).value,end:document.getElementById(`pt-e${i}`).value});
  db.ref('settings/pairTimes').set(t);closeM('m-times');
}

function clearAll(){if(!isAdmin)return;if(confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?')){db.ref('schedule').remove();db.ref('homework').remove();db.ref('newHomework').remove();db.ref('changes').remove();db.ref('subjects').remove()}}

/* ===== Modals ===== */
function openM(id){document.getElementById(id).classList.add('show')}
function closeM(id){document.getElementById(id).classList.remove('show')}
document.querySelectorAll('.modal-bg').forEach(bg=>{bg.addEventListener('click',e=>{if(e.target===bg)bg.classList.remove('show')})});

/* ===== Keyboard ===== */
document.getElementById('l-pass').addEventListener('keypress',e=>{if(e.key==='Enter')doLogin()});
document.getElementById('l-email').addEventListener('keypress',e=>{if(e.key==='Enter')document.getElementById('l-pass').focus()});

/* ===== Touch swipe for days ===== */
let touchStartX=0;
document.getElementById('lessons-wrap')?.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX},{passive:true});
document.addEventListener('touchend',e=>{
  if(!document.getElementById('pg-schedule').classList.contains('active'))return;
  const dx=e.changedTouches[0].clientX-touchStartX;
  if(Math.abs(dx)>80){
    if(dx<0&&selDayIdx<5){selDayIdx++;renderDayTabs();renderDay()}
    else if(dx>0&&selDayIdx>0){selDayIdx--;renderDayTabs();renderDay()}
  }
});
</script>
</body>
</html>
