<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>–î–Ω–µ–≤–Ω–∏–∫</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0f">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#070709;--bg2:#0e0e14;--bg3:#16161f;
  --card:rgba(255,255,255,.03);--card-h:rgba(255,255,255,.06);
  --inp:rgba(255,255,255,.05);--glass:rgba(14,14,20,.92);
  --brd:rgba(255,255,255,.06);--brd2:rgba(255,255,255,.1);
  --t1:#f2f2f6;--t2:rgba(255,255,255,.55);--t3:rgba(255,255,255,.28);
  --ac:#7c3aed;--ac2:#a78bfa;--acR:124,58,237;
  --ok:#10b981;--okR:16,185,129;
  --err:#ef4444;--errR:239,68,68;
  --wrn:#f59e0b;--wrnR:245,158,11;
  --r:12px;--r2:16px;--r3:22px;
}
[data-theme="light"]{
  --bg:#f2f3f7;--bg2:#fff;--bg3:#f0f0f5;
  --card:rgba(0,0,0,.025);--card-h:rgba(0,0,0,.05);
  --inp:rgba(0,0,0,.04);--glass:rgba(255,255,255,.92);
  --brd:rgba(0,0,0,.06);--brd2:rgba(0,0,0,.1);
  --t1:#0f0f18;--t2:rgba(0,0,0,.5);--t3:rgba(0,0,0,.28);
}
[data-theme="midnight"]{
  --bg:#070b18;--bg2:#0e1428;--bg3:#151d38;
  --card:rgba(30,50,100,.2);--card-h:rgba(30,50,100,.35);
  --glass:rgba(14,20,40,.92);--brd:rgba(59,130,246,.08);--brd2:rgba(59,130,246,.15);
  --ac:#3b82f6;--ac2:#60a5fa;--acR:59,130,246;
}
[data-theme="emerald"]{
  --bg:#030f0a;--bg2:#071a12;--bg3:#0c2a1c;
  --card:rgba(16,185,129,.06);--card-h:rgba(16,185,129,.1);
  --glass:rgba(7,26,18,.92);--brd:rgba(16,185,129,.08);--brd2:rgba(16,185,129,.15);
  --ac:#10b981;--ac2:#34d399;--acR:16,185,129;
}
[data-theme="rose"]{
  --bg:#0f0508;--bg2:#1a0a10;--bg3:#2a101a;
  --card:rgba(244,63,94,.06);--card-h:rgba(244,63,94,.1);
  --glass:rgba(26,10,16,.92);--brd:rgba(244,63,94,.08);--brd2:rgba(244,63,94,.15);
  --ac:#f43f5e;--ac2:#fb7185;--acR:244,63,94;
}
[data-theme="sunset"]{
  --bg:#0f0802;--bg2:#1a0f05;--bg3:#2a1a0a;
  --card:rgba(249,115,22,.06);--card-h:rgba(249,115,22,.1);
  --glass:rgba(26,15,5,.92);--brd:rgba(249,115,22,.08);--brd2:rgba(249,115,22,.15);
  --ac:#f97316;--ac2:#fb923c;--acR:249,115,22;
}
[data-theme="nord"]{
  --bg:#242933;--bg2:#2e3440;--bg3:#3b4252;
  --card:rgba(76,86,106,.25);--card-h:rgba(76,86,106,.4);
  --glass:rgba(46,52,64,.92);--brd:rgba(136,192,208,.08);--brd2:rgba(136,192,208,.15);
  --t1:#eceff4;--t2:rgba(236,239,244,.55);--t3:rgba(236,239,244,.28);
  --ac:#88c0d0;--ac2:#8fbcbb;--acR:136,192,208;
}
[data-theme="cream"]{
  --bg:#f7f3ec;--bg2:#fffdf8;--bg3:#f0ebe2;
  --card:rgba(120,80,40,.04);--card-h:rgba(120,80,40,.07);
  --inp:rgba(120,80,40,.04);--glass:rgba(255,253,248,.92);
  --brd:rgba(120,80,40,.08);--brd2:rgba(120,80,40,.12);
  --t1:#2d1f0e;--t2:rgba(45,31,14,.5);--t3:rgba(45,31,14,.28);
  --ac:#b45309;--ac2:#d97706;--acR:180,83,9;
}

*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{height:-webkit-fill-available}
body{
  font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;
  background:var(--bg);color:var(--t1);
  min-height:100vh;min-height:-webkit-fill-available;
  -webkit-font-smoothing:antialiased;overflow-x:hidden;
  transition:background .4s,color .4s;
}

/* === HEADER === */
header{
  background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-bottom:1px solid var(--brd);
  padding:10px 16px;padding-top:calc(10px + env(safe-area-inset-top));
  position:sticky;top:0;z-index:100;
}
.hdr{max-width:600px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
.h-left{display:flex;align-items:center;gap:10px}
.logo{font-size:1.15em;font-weight:900;color:var(--ac);display:flex;align-items:center;gap:7px}
.logo-dot{width:28px;height:28px;background:linear-gradient(135deg,var(--ac),var(--ac2));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.8em;color:#fff}
.week-pill{font-size:.65em;font-weight:800;padding:3px 10px;border-radius:12px;text-transform:uppercase;letter-spacing:.3px}
.week-pill.upper{background:rgba(var(--okR),.15);color:var(--ok)}
.week-pill.lower{background:rgba(var(--errR),.15);color:var(--err)}
.h-right{display:flex;align-items:center;gap:6px}
.h-btn{
  width:34px;height:34px;border-radius:10px;background:var(--card);
  border:1px solid var(--brd);color:var(--t1);font-size:.95em;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .2s;
}
.h-btn:active{transform:scale(.92)}
.admin-dot{width:6px;height:6px;border-radius:50%;background:var(--wrn);position:absolute;top:4px;right:4px}

/* === CONTAINER === */
.cont{
  max-width:600px;margin:0 auto;
  padding:0 16px 16px;
  padding-bottom:calc(80px + env(safe-area-inset-bottom));
}

/* === DAY SELECTOR === */
.day-sel{
  display:flex;gap:4px;padding:14px 0;
  overflow-x:auto;-webkit-overflow-scrolling:touch;
  scrollbar-width:none;position:sticky;top:calc(49px + env(safe-area-inset-top));
  z-index:50;background:var(--bg);
}
.day-sel::-webkit-scrollbar{display:none}
.day-btn{
  flex:1;min-width:0;padding:10px 4px;border:none;
  background:var(--card);border-radius:var(--r);
  cursor:pointer;text-align:center;transition:all .2s;
  border:1px solid transparent;position:relative;
}
.day-btn:active{transform:scale(.96)}
.day-btn .db-name{font-size:.7em;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.3px}
.day-btn .db-num{font-size:1.2em;font-weight:900;color:var(--t2);margin-top:2px}
.day-btn.active{background:rgba(var(--acR),.12);border-color:rgba(var(--acR),.3)}
.day-btn.active .db-name{color:var(--ac)}
.day-btn.active .db-num{color:var(--ac)}
.day-btn.today-dot::after{
  content:'';position:absolute;bottom:5px;left:50%;transform:translateX(-50%);
  width:4px;height:4px;border-radius:50%;background:var(--ac);
}
.day-btn.has-chg .db-name{color:var(--wrn)}

/* === WEEK NAV === */
.week-nav{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 0;margin-bottom:4px;
}
.wn-btn{
  width:36px;height:36px;border-radius:10px;background:var(--card);
  border:1px solid var(--brd);color:var(--t2);font-size:1em;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .2s;
}
.wn-btn:active{transform:scale(.92)}
.wn-center{text-align:center}
.wn-range{font-size:.88em;font-weight:800;color:var(--t1)}
.wn-type{font-size:.68em;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.5px}

/* === TABS (bottom) === */
.btabs{
  position:fixed;bottom:0;left:0;right:0;
  background:var(--glass);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-top:1px solid var(--brd);
  padding:6px 8px;padding-bottom:calc(6px + env(safe-area-inset-bottom));
  z-index:100;display:flex;gap:2px;
}
.btab{
  flex:1;padding:6px 0 4px;border:none;background:transparent;
  color:var(--t3);cursor:pointer;text-align:center;
  border-radius:10px;transition:all .2s;font-family:inherit;
}
.btab:active{transform:scale(.93)}
.btab .bt-ico{font-size:1.2em;display:block;margin-bottom:1px}
.btab .bt-txt{font-size:.6em;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
.btab.active{color:var(--ac);background:rgba(var(--acR),.08)}
.btab .bt-badge{
  background:var(--err);color:#fff;border-radius:50%;
  min-width:15px;height:15px;display:inline-flex;align-items:center;
  justify-content:center;font-size:.55em;font-weight:900;padding:0 3px;
  position:absolute;top:2px;right:calc(50% - 18px);
}
.btab{position:relative}

/* === SECTION === */
.sec{display:none}
.sec.on{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* === LESSONS === */
.day-card{
  background:var(--bg2);border-radius:var(--r2);
  border:1px solid var(--brd);overflow:hidden;
}
.day-head{
  padding:14px 16px;display:flex;justify-content:space-between;align-items:center;
  border-bottom:1px solid var(--brd);
}
.dh-title{font-size:1.05em;font-weight:800}
.dh-date{font-size:.78em;color:var(--t3);font-weight:500}
.dh-badges{display:flex;gap:6px}
.badge-t{background:rgba(var(--acR),.15);color:var(--ac);padding:3px 10px;border-radius:10px;font-size:.65em;font-weight:800;text-transform:uppercase}
.badge-c{background:rgba(var(--wrnR),.15);color:var(--wrn);padding:3px 10px;border-radius:10px;font-size:.65em;font-weight:800;text-transform:uppercase}

.les-list{padding:6px}

.les{
  display:flex;gap:12px;padding:12px;border-radius:var(--r);
  transition:background .15s;position:relative;
}
.les:active{background:var(--card)}
.les.empty{opacity:.3}
.les.ch{background:rgba(var(--wrnR),.04);border-radius:var(--r)}

.les-n{
  width:42px;display:flex;flex-direction:column;align-items:center;
  justify-content:center;flex-shrink:0;
}
.les-n-num{font-size:1.3em;font-weight:900;color:var(--ac);line-height:1}
.les-n-time{font-size:.52em;color:var(--t3);margin-top:2px;font-weight:600}

.les-i{flex:1;min-width:0}
.les-name{font-weight:700;font-size:.92em;margin-bottom:3px}
.les-det{font-size:.74em;color:var(--t3);display:flex;gap:8px;flex-wrap:wrap}
.les-room{color:var(--ac);font-weight:700;background:rgba(var(--acR),.08);padding:1px 7px;border-radius:5px}
.les-empty-txt{color:var(--t3);font-size:.85em}

/* === HW INLINE === */
.les-hw{
  margin-top:8px;padding:10px 12px;
  background:rgba(var(--acR),.05);border-radius:8px;
  border-left:3px solid var(--ac);
}
.les-hw.done{opacity:.35;border-left-color:var(--ok)}
.les-hw.done .hw-txt{text-decoration:line-through}
.hw-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.hw-lbl{font-size:.6em;color:var(--ac);font-weight:800;text-transform:uppercase;letter-spacing:.5px}
.hw-txt{font-size:.82em;line-height:1.5;color:var(--t1)}

.hw-imgs{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.hw-img{
  width:80px;height:80px;border-radius:8px;object-fit:cover;
  border:1px solid var(--brd);cursor:pointer;transition:all .2s;
}
.hw-img:active{opacity:.7}

.hw-btn-add{
  padding:3px 8px;background:rgba(var(--acR),.1);
  border:1px solid rgba(var(--acR),.15);color:var(--ac);
  border-radius:5px;cursor:pointer;font-size:.65em;font-weight:800;
  transition:all .2s;
}
.hw-btn-add:active{transform:scale(.95)}

/* === CARDS === */
.card{
  background:var(--bg2);border-radius:var(--r2);
  padding:20px;border:1px solid var(--brd);margin-bottom:14px;
}
.sec-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px}
.sec-t{font-size:1.1em;font-weight:900;display:flex;align-items:center;gap:8px}

.empty-s{text-align:center;padding:40px 16px;color:var(--t3)}
.empty-s .es-ico{font-size:2.5em;margin-bottom:8px;opacity:.4}
.empty-s .es-txt{font-size:.92em;font-weight:600}

/* === BUTTONS === */
.btn{
  padding:10px 18px;border:none;border-radius:var(--r);
  cursor:pointer;font-weight:700;font-size:.84em;
  transition:all .2s;font-family:inherit;
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
}
.btn:active{transform:scale(.96)}
.btn-p{background:linear-gradient(135deg,var(--ac),var(--ac2));color:#fff;box-shadow:0 4px 15px rgba(var(--acR),.25)}
.btn-s{background:var(--card);color:var(--t1);border:1px solid var(--brd)}
.btn-d{background:rgba(var(--errR),.12);color:var(--err);border:1px solid rgba(var(--errR),.15)}
.btn-ok{background:rgba(var(--okR),.12);color:var(--ok);border:1px solid rgba(var(--okR),.15)}
.btn-w{background:rgba(var(--wrnR),.12);color:var(--wrn);border:1px solid rgba(var(--wrnR),.15)}
.btn-sm{padding:7px 14px;font-size:.76em}
.btn-xs{padding:4px 9px;font-size:.7em;border-radius:6px}

/* === SUBJ CARDS === */
.subj-c{
  display:flex;align-items:center;gap:12px;padding:14px;
  background:var(--card);border:1px solid var(--brd);border-radius:var(--r);
  margin-bottom:8px;transition:all .15s;
}
.subj-c:active{background:var(--card-h)}
.subj-ico{width:40px;height:40px;border-radius:10px;background:rgba(var(--acR),.1);display:flex;align-items:center;justify-content:center;font-size:1.2em;flex-shrink:0}
.subj-info{flex:1;min-width:0}
.subj-nm{font-weight:700;font-size:.9em;margin-bottom:2px}
.subj-mt{font-size:.74em;color:var(--t3);display:flex;gap:8px;flex-wrap:wrap}
.subj-acts{display:flex;gap:4px}

/* === HW CARDS === */
.hw-card{
  background:var(--card);border:1px solid var(--brd);
  border-radius:var(--r2);padding:16px;margin-bottom:12px;
  border-left:4px solid var(--ac);
}
.hwc-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:8px;flex-wrap:wrap}
.hwc-subj{font-weight:800;font-size:1em;color:var(--ac);display:flex;align-items:center;gap:8px}
.hwc-due{font-size:.7em;color:var(--t3);background:var(--card-h);padding:3px 10px;border-radius:10px;font-weight:600;white-space:nowrap}
.hwc-task{font-size:.88em;line-height:1.6;padding:12px;background:var(--bg3);border-radius:8px;margin-bottom:12px;border:1px solid var(--brd)}
.hwc-imgs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.hwc-img{width:100px;height:100px;border-radius:8px;object-fit:cover;border:1px solid var(--brd);cursor:pointer}
.hwc-acts{display:flex;gap:6px}

/* === CHG CARDS === */
.chg-card{
  background:rgba(var(--wrnR),.04);border:1px solid rgba(var(--wrnR),.12);
  border-radius:var(--r2);padding:16px;margin-bottom:12px;
  border-left:4px solid var(--wrn);
}
.chg-hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px}
.chg-dt{font-weight:800;color:var(--wrn)}
.chg-lr{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(var(--wrnR),.04);border-radius:8px;margin-bottom:4px}
.chg-pn{width:28px;height:28px;background:rgba(var(--wrnR),.12);border-radius:7px;display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--wrn);font-size:.85em;flex-shrink:0}
.chg-ln{font-weight:700;font-size:.88em}
.chg-ld{font-size:.72em;color:var(--t3)}

/* === SETTINGS === */
.set-r{
  padding:16px;background:var(--card);border:1px solid var(--brd);
  border-radius:var(--r);margin-bottom:8px;
  display:flex;justify-content:space-between;align-items:center;
  flex-wrap:wrap;gap:10px;
}
.set-r h4{font-size:.88em;font-weight:700;margin-bottom:2px}
.set-r p{font-size:.72em;color:var(--t3)}
.set-inp{
  padding:9px 14px;border:1px solid var(--brd2);background:var(--inp);
  border-radius:var(--r);color:var(--t1);font-family:inherit;transition:all .2s;
}
.set-inp:focus{outline:none;border-color:var(--ac);box-shadow:0 0 0 3px rgba(var(--acR),.1)}

/* === THEME PICKER === */
.tp-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1001;align-items:flex-end;justify-content:center;padding:0}
.tp-ov.on{display:flex}
.tp{
  background:var(--bg2);border-radius:var(--r3) var(--r3) 0 0;
  padding:24px;padding-bottom:calc(24px + env(safe-area-inset-bottom));
  width:100%;max-width:500px;
  animation:sheetUp .3s ease;border-top:1px solid var(--brd);
}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.tp h3{margin-bottom:16px;font-size:1em;font-weight:800;display:flex;align-items:center;gap:8px}
.tp-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.tp-opt{
  padding:12px 6px;border-radius:var(--r);border:2px solid var(--brd);
  cursor:pointer;text-align:center;font-size:.7em;font-weight:700;
  color:var(--t2);display:flex;flex-direction:column;align-items:center;gap:5px;
  transition:all .15s;
}
.tp-opt:active{transform:scale(.95)}
.tp-opt.cur{border-color:var(--ac);background:rgba(var(--acR),.08)}
.tp-sw{width:28px;height:28px;border-radius:50%;border:2px solid rgba(255,255,255,.1)}
.tp-handle{width:40px;height:4px;background:var(--brd2);border-radius:2px;margin:0 auto 16px}

/* === MODALS === */
.mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;align-items:flex-end;justify-content:center;padding:0}
.mo.on{display:flex}
.md{
  background:var(--bg2);border-radius:var(--r3) var(--r3) 0 0;
  padding:24px;padding-bottom:calc(24px + env(safe-area-inset-bottom));
  width:100%;max-width:500px;max-height:90vh;overflow-y:auto;
  animation:sheetUp .3s ease;border-top:1px solid var(--brd);
}
.md-handle{width:40px;height:4px;background:var(--brd2);border-radius:2px;margin:0 auto 16px}
.md h3{margin-bottom:20px;font-size:1em;font-weight:800;display:flex;align-items:center;gap:8px}
.fg{margin-bottom:14px}
.fg label{display:block;margin-bottom:5px;color:var(--t2);font-size:.72em;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.fg input,.fg textarea{
  width:100%;padding:12px 14px;border:1px solid var(--brd2);
  background:var(--inp);border-radius:var(--r);color:var(--t1);
  font-size:.95em;font-family:inherit;-webkit-appearance:none;transition:all .2s;
}
.fg textarea{resize:vertical;min-height:80px}
.fg input:focus,.fg textarea:focus{outline:none;border-color:var(--ac);box-shadow:0 0 0 3px rgba(var(--acR),.1)}
.fg input::placeholder,.fg textarea::placeholder{color:var(--t3)}
.md-btns{display:flex;gap:8px;margin-top:20px}
.md-btns .btn{flex:1}

/* === IMAGE VIEWER === */
.img-viewer{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.95);
  z-index:2000;align-items:center;justify-content:center;padding:20px;
  cursor:pointer;
}
.img-viewer.on{display:flex}
.img-viewer img{max-width:100%;max-height:90vh;border-radius:8px;object-fit:contain}

/* === IMAGE UPLOAD === */
.img-upload-area{
  display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px;
}
.img-preview{
  width:70px;height:70px;border-radius:8px;object-fit:cover;
  border:1px solid var(--brd);position:relative;
}
.img-preview-wrap{position:relative;display:inline-block}
.img-preview-del{
  position:absolute;top:-4px;right:-4px;width:20px;height:20px;
  background:var(--err);color:#fff;border:none;border-radius:50%;
  font-size:.65em;cursor:pointer;display:flex;align-items:center;justify-content:center;
}
.img-add-btn{
  width:70px;height:70px;border-radius:8px;border:2px dashed var(--brd2);
  background:var(--card);color:var(--t3);font-size:1.5em;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .2s;
}
.img-add-btn:active{background:var(--card-h)}
.upload-progress{font-size:.72em;color:var(--ac);margin-top:4px}

/* === CUSTOM SELECT === */
.cs{position:relative;width:100%}
.cs-trig{
  display:flex;align-items:center;gap:10px;
  padding:12px 14px;background:var(--inp);border:1px solid var(--brd2);
  border-radius:var(--r);cursor:pointer;min-height:48px;
}
.cs-trig .cst-name{font-weight:700;font-size:.86em;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cs-trig .cst-ph{color:var(--t3);font-size:.86em;flex:1}
.cs-trig .cst-arr{color:var(--t3);font-size:.55em;transition:transform .2s}
.cs-trig.op{border-color:var(--ac);border-radius:var(--r) var(--r) 0 0}
.cs-trig.op .cst-arr{transform:rotate(180deg)}
.cs-dd{
  position:absolute;top:100%;left:0;right:0;background:var(--bg2);
  border:1px solid var(--ac);border-top:1px solid var(--brd);
  border-radius:0 0 var(--r) var(--r);max-height:200px;overflow-y:auto;
  z-index:50;display:none;
}
.cs-dd.op{display:block}
.cs-dd::-webkit-scrollbar{width:3px}
.cs-dd::-webkit-scrollbar-thumb{background:var(--brd2);border-radius:2px}
.cs-opt{
  padding:11px 14px;cursor:pointer;transition:background .1s;
  border-bottom:1px solid var(--brd);font-size:.86em;font-weight:600;
}
.cs-opt:last-child{border:none}
.cs-opt:active{background:rgba(var(--acR),.1)}
.cs-opt.sel{background:rgba(var(--acR),.06);color:var(--ac)}
.cs-opt.emp{color:var(--t3)}

/* === SCROLLBAR === */
::-webkit-scrollbar{width:0;height:0}

@media(min-width:500px){
  .day-sel{gap:6px}
  .btabs{justify-content:center;gap:4px}
  .btab{max-width:100px}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="login" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px">
<div style="width:100%;max-width:380px;padding:32px;background:var(--bg2);border-radius:var(--r3);border:1px solid var(--brd)">
  <div style="text-align:center;font-size:2.8em;margin-bottom:4px">üìö</div>
  <h2 style="text-align:center;font-size:1.5em;font-weight:900;margin-bottom:2px;color:var(--ac)">–î–Ω–µ–≤–Ω–∏–∫</h2>
  <p style="text-align:center;color:var(--t3);margin-bottom:24px;font-size:.85em">–¢–µ—Ö–Ω–∏–∫—É–º</p>
  <div class="lb-err" id="login-error" style="display:none;background:rgba(var(--errR),.08);border:1px solid rgba(var(--errR),.15);color:var(--err);padding:10px;border-radius:var(--r);text-align:center;margin-bottom:16px;font-size:.85em;font-weight:600"></div>
  <div class="fg"><label>Email</label><input type="email" id="login-email" placeholder="email@example.com" autocomplete="email"></div>
  <div class="fg"><label>–ü–∞—Ä–æ–ª—å</label><input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
  <button class="btn btn-p" style="width:100%;padding:13px;font-size:.95em" onclick="doLogin()">–í–æ–π—Ç–∏</button>
  <div style="display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--t3);font-size:.78em"><div style="flex:1;height:1px;background:var(--brd)"></div>–∏–ª–∏<div style="flex:1;height:1px;background:var(--brd)"></div></div>
  <button class="btn btn-s" style="width:100%;padding:13px;font-size:.95em" onclick="enterAsGuest()">–í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å</button>
</div>
</div>

<!-- APP -->
<div id="app" style="display:none">
<header><div class="hdr">
  <div class="h-left">
    <div class="logo"><span class="logo-dot">üìö</span>–î–Ω–µ–≤–Ω–∏–∫</div>
    <span class="week-pill" id="h-week"></span>
  </div>
  <div class="h-right">
    <button class="h-btn" onclick="openTP()">üé®</button>
    <button class="h-btn" onclick="doLogout()" style="font-size:.75em;width:auto;padding:0 10px">–í—ã–π—Ç–∏</button>
  </div>
</div></header>

<div class="cont">
  <!-- Week nav -->
  <div class="week-nav">
    <button class="wn-btn" onclick="prevWeek()">‚Äπ</button>
    <div class="wn-center">
      <div class="wn-range" id="wn-range"></div>
      <div class="wn-type" id="wn-type"></div>
    </div>
    <button class="wn-btn" onclick="nextWeek()">‚Ä∫</button>
  </div>

  <!-- Day selector -->
  <div class="day-sel" id="day-sel"></div>

  <!-- Sections -->
  <div class="sec on" id="home"><div id="day-view"></div></div>

  <div class="sec" id="hw-tab"><div class="card">
    <div class="sec-hd">
      <h2 class="sec-t">üìã –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
      <button class="btn btn-p btn-sm adm" onclick="openNewHwModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="hw-tab-list"></div>
  </div></div>

  <div class="sec" id="changes"><div class="card">
    <div class="sec-hd">
      <h2 class="sec-t">‚ö° –ó–∞–º–µ–Ω—ã</h2>
      <button class="btn btn-w btn-sm" onclick="openChgModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="chg-list"></div>
  </div></div>

  <div class="sec" id="subjects"><div class="card">
    <div class="sec-hd">
      <h2 class="sec-t">üìñ –ü—Ä–µ–¥–º–µ—Ç—ã</h2>
      <button class="btn btn-p btn-sm" onclick="openSubjModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <div id="subj-list"></div>
  </div></div>

  <div class="sec" id="settings"><div class="card">
    <h2 class="sec-t" style="margin-bottom:20px">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
    <div class="set-r"><div><h4>üìÖ –ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª—å</h4><p>–ü–Ω –≤–µ—Ä—Ö–Ω–µ–π –Ω–µ–¥–µ–ª–∏</p></div><input type="date" class="set-inp" id="ws-date"></div>
    <div class="set-r"><div><h4>üïê –í—Ä–µ–º—è –ø–∞—Ä</h4><p>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–æ–≤</p></div><button class="btn btn-s btn-sm" onclick="openTimesModal()">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button></div>
    <div class="set-r"><div><h4>üóë –°–±—Ä–æ—Å</h4><p>–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</p></div><button class="btn btn-d btn-sm" onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button></div>
  </div></div>
</div>

<!-- Bottom tabs -->
<div class="btabs">
  <button class="btab active" data-s="home"><span class="bt-ico">üè†</span><span class="bt-txt">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span></button>
  <button class="btab" data-s="hw-tab" id="hw-nav"><span class="bt-ico">üìã</span><span class="bt-txt">–î–ó</span></button>
  <button class="btab adm" data-s="changes"><span class="bt-ico">‚ö°</span><span class="bt-txt">–ó–∞–º–µ–Ω—ã</span></button>
  <button class="btab adm" data-s="subjects"><span class="bt-ico">üìñ</span><span class="bt-txt">–ü—Ä–µ–¥–º–µ—Ç—ã</span></button>
  <button class="btab adm" data-s="settings"><span class="bt-ico">‚öôÔ∏è</span><span class="bt-txt">–ï—â—ë</span></button>
</div>
</div>

<!-- Theme picker -->
<div class="tp-ov" id="tp-ov" onclick="if(event.target===this)closeTP()">
<div class="tp">
  <div class="tp-handle"></div>
  <h3>üé® –¢–µ–º–∞</h3>
  <div class="tp-grid" id="tp-grid"></div>
</div>
</div>

<!-- Image viewer -->
<div class="img-viewer" id="img-viewer" onclick="this.classList.remove('on')"><img id="img-viewer-img" src=""></div>

<!-- Modals -->
<div class="mo" id="les-mo" onclick="if(event.target===this)closeMo('les-mo')"><div class="md">
  <div class="md-handle"></div>
  <h3>‚úèÔ∏è –ü–∞—Ä–∞</h3>
  <input type="hidden" id="ed-day"><input type="hidden" id="ed-pair"><input type="hidden" id="ed-week">
  <div class="fg"><label>–ü—Ä–µ–¥–º–µ—Ç</label><div id="les-sel-c"></div></div>
  <div class="md-btns">
    <button class="btn btn-s" onclick="closeMo('les-mo')">–û—Ç–º–µ–Ω–∞</button>
    <button class="btn btn-d" onclick="delLes()">–û—á–∏—Å—Ç–∏—Ç—å</button>
    <button class="btn btn-p" onclick="saveLes()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div></div>

<div class="mo" id="hw-mo" onclick="if(event.target===this)closeMo('hw-mo')"><div class="md">
  <div class="md-handle"></div>
  <h3>üìù –î–æ–º–∞—à–∫–∞</h3>
  <input type="hidden" id="hw-date"><input type="hidden" id="hw-pair">
  <div class="fg"><label>–ü—Ä–µ–¥–º–µ—Ç</label><input type="text" id="hw-subject" readonly style="opacity:.6"></div>
  <div class="fg"><label>–ó–∞–¥–∞–Ω–∏–µ</label><textarea id="hw-task" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å..."></textarea></div>
  <div class="fg"><label>üì∑ –§–æ—Ç–æ</label>
    <div class="img-upload-area" id="hw-imgs-area">
      <label class="img-add-btn"><input type="file" accept="image/*" multiple hidden onchange="handleImgUpload(event,'hw-imgs-area','hw-img-urls')">+</label>
    </div>
    <div class="upload-progress" id="hw-upload-prog"></div>
  </div>
  <div class="md-btns">
    <button class="btn btn-s" onclick="closeMo('hw-mo')">–û—Ç–º–µ–Ω–∞</button>
    <button class="btn btn-p" onclick="saveOldHw()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div></div>

<div class="mo" id="nhw-mo" onclick="if(event.target===this)closeMo('nhw-mo')"><div class="md">
  <div class="md-handle"></div>
  <h3>üìã –ù–æ–≤–æ–µ –î–ó</h3>
  <div class="fg"><label>–ü—Ä–µ–¥–º–µ—Ç</label><div id="nhw-sel-c"></div></div>
  <div class="fg"><label>–ó–∞–¥–∞–Ω–∏–µ</label><textarea id="nhw-task" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ..." style="min-height:100px"></textarea></div>
  <div class="fg"><label>üì∑ –§–æ—Ç–æ</label>
    <div class="img-upload-area" id="nhw-imgs-area">
      <label class="img-add-btn"><input type="file" accept="image/*" multiple hidden onchange="handleImgUpload(event,'nhw-imgs-area','nhw-img-urls')">+</label>
    </div>
    <div class="upload-progress" id="nhw-upload-prog"></div>
  </div>
  <div class="fg"><label>–°–ª–µ–¥—É—é—â–∞—è –ø–∞—Ä–∞</label><div id="nhw-next" style="padding:12px;background:var(--card);border:1px solid var(--brd);border-radius:var(--r);font-size:.85em;color:var(--t3);min-height:42px;display:flex;align-items:center;gap:6px">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...</div></div>
  <div class="md-btns">
    <button class="btn btn-s" onclick="closeMo('nhw-mo')">–û—Ç–º–µ–Ω–∞</button>
    <button class="btn btn-p" onclick="saveNewHw()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div></div>

<div class="mo" id="subj-mo" onclick="if(event.target===this)closeMo('subj-mo')"><div class="md">
  <div class="md-handle"></div>
  <h3 id="subj-mo-title">üìñ –ü—Ä–µ–¥–º–µ—Ç</h3>
  <input type="hidden" id="subj-eid">
  <div class="fg"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="subj-name" placeholder="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"></div>
  <div class="fg"><label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label><input type="text" id="subj-room" placeholder="–ö–∞–±. 301"></div>
  <div class="fg"><label>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</label><input type="text" id="subj-teacher" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò."></div>
  <div class="md-btns">
    <button class="btn btn-s" onclick="closeMo('subj-mo')">–û—Ç–º–µ–Ω–∞</button>
    <button class="btn btn-p" onclick="saveSubj()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div></div>

<div class="mo" id="chg-mo" onclick="if(event.target===this)closeMo('chg-mo')"><div class="md">
  <div class="md-handle"></div>
  <h3>‚ö° –ó–∞–º–µ–Ω–∞</h3>
  <input type="hidden" id="chg-eid">
  <div class="fg"><label>–î–∞—Ç–∞</label><input type="date" id="chg-date"></div>
  <p style="color:var(--t3);font-size:.74em;margin-bottom:12px">–î–µ–π—Å—Ç–≤—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É. –ü—É—Å—Ç–æ–µ = –Ω–µ—Ç –ø–∞—Ä—ã.</p>
  <div id="chg-pairs-c"></div>
  <div class="md-btns">
    <button class="btn btn-s" onclick="closeMo('chg-mo')">–û—Ç–º–µ–Ω–∞</button>
    <button class="btn btn-d" id="chg-del-btn" onclick="delChg()" style="display:none">–£–¥–∞–ª–∏—Ç—å</button>
    <button class="btn btn-p" onclick="saveChg()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div></div>

<div class="mo" id="times-mo" onclick="if(event.target===this)closeMo('times-mo')"><div class="md">
  <div class="md-handle"></div>
  <h3>üïê –í—Ä–µ–º—è –ø–∞—Ä</h3>
  <div id="times-form"></div>
  <div class="md-btns">
    <button class="btn btn-s" onclick="closeMo('times-mo')">–û—Ç–º–µ–Ω–∞</button>
    <button class="btn btn-p" onclick="saveTimes()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<script>
// ============ THEMES ============
const TH=[
  {id:'dark',nm:'–¢—ë–º–Ω–∞—è',ico:'üåô',c:'#070709'},
  {id:'light',nm:'–°–≤–µ—Ç–ª–∞—è',ico:'‚òÄÔ∏è',c:'#f2f3f7'},
  {id:'midnight',nm:'–ü–æ–ª–Ω–æ—á—å',ico:'üåä',c:'#070b18'},
  {id:'emerald',nm:'–ò–∑—É–º—Ä—É–¥',ico:'üíé',c:'#030f0a'},
  {id:'rose',nm:'–†–æ–∑–∞',ico:'üåπ',c:'#0f0508'},
  {id:'sunset',nm:'–ó–∞–∫–∞—Ç',ico:'üåÖ',c:'#0f0802'},
  {id:'nord',nm:'–ù–æ—Ä–¥',ico:'‚ùÑÔ∏è',c:'#242933'},
  {id:'cream',nm:'–ö—Ä–µ–º',ico:'üç¶',c:'#f7f3ec'},
];
function setTheme(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t);document.querySelector('meta[name="theme-color"]')?.setAttribute('content',TH.find(x=>x.id===t)?.c||'#0a0a0f');renderTPGrid()}
function openTP(){renderTPGrid();document.getElementById('tp-ov').classList.add('on')}
function closeTP(){document.getElementById('tp-ov').classList.remove('on')}
function renderTPGrid(){const c=document.getElementById('tp-grid');if(!c)return;const cur=document.documentElement.getAttribute('data-theme')||'dark';c.innerHTML=TH.map(t=>`<div class="tp-opt ${t.id===cur?'cur':''}" onclick="setTheme('${t.id}');closeTP()"><div class="tp-sw" style="background:${t.c}"></div><span>${t.ico} ${t.nm}</span></div>`).join('')}
(function(){const s=localStorage.getItem('theme');setTheme(s||(matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'))})();

// ============ FIREBASE ============
const fbApp=firebase.initializeApp({
  apiKey:"AIzaSyBCy0hz_PHMGUX2M52Wnwb0C9nEnBBfeq8",
  authDomain:"my-diary-e223c.firebaseapp.com",
  databaseURL:"https://my-diary-e223c-default-rtdb.firebaseio.com",
  projectId:"my-diary-e223c",
  storageBucket:"my-diary-e223c.firebasestorage.app",
  messagingSenderId:"903986378920",
  appId:"1:903986378920:web:b6ebc6691f6d767f78aa9d"
});
const auth=firebase.auth(),db=firebase.database(),storage=firebase.storage();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

const ADMINS=["zFKU6TAgIuhZetCOuWpHvDDw6Oj2"];
const DS=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
const DF=['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
const DFS=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
let curUser=null,isAdmin=false,isGuest=false;
let sched={upper:{},lower:{}},hwList=[],chgList=[],nhwList=[],subjList=[];
let cfg={weekStartDate:null,pairTimes:[{start:'08:30',end:'10:00'},{start:'10:10',end:'11:40'},{start:'12:10',end:'13:40'},{start:'13:50',end:'15:20'},{start:'15:30',end:'17:00'}]};
let vws=getMonday(new Date()),selDayIdx=todayIdx(),css={};
let pendingImgs={};

function todayIdx(){const d=new Date().getDay();return d===0?5:d-1}
function getMonday(d){const r=new Date(d);r.setHours(12,0,0,0);const w=r.getDay();r.setDate(r.getDate()-w+(w===0?-6:1));return r}
function fdk(d){const r=new Date(d);return`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,'0')}-${String(r.getDate()).padStart(2,'0')}`}
function pdk(s){const[y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d,12,0,0)}
function fds(d){return String(new Date(d).getDate()).padStart(2,'0')+'.'+String(new Date(d).getMonth()+1).padStart(2,'0')}
function fdf(d){return new Date(d).toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'})}
function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML}
function gwt(mon){if(!cfg.weekStartDate){const s=new Date(mon.getFullYear(),0,1);return Math.ceil(((mon-s)/86400000+s.getDay()+1)/7)%2===1?'upper':'lower'}const sd=getMonday(pdk(cfg.weekStartDate));return Math.floor(Math.round((mon-sd)/864e5)/7)%2===0?'upper':'lower'}

function lessonsFor(dk){
  const d=pdk(dk),dow=d.getDay();if(dow===0)return{};
  const di=dow-1;if(di>5)return{};
  const ch=chgList.find(c=>c.date===dk);
  if(ch)return ch.lessons||{};
  return(sched[gwt(getMonday(d))]||{})[DS[di]]||{};
}

function findNext(subj){
  const today=new Date();today.setHours(0,0,0,0);
  for(let off=1;off<=60;off++){
    const cd=new Date(today);cd.setDate(cd.getDate()+off);
    const dow=cd.getDay();if(dow===0||dow>6)continue;
    const dk=fdk(cd),lessons=lessonsFor(dk);
    for(let p=1;p<=5;p++){const l=lessons[p];if(l?.name?.toLowerCase().trim()===subj.toLowerCase().trim())return{date:dk,pair:p}}
  }
  return null;
}

function recalcHw(){
  if(!isAdmin)return;const tk=fdk(new Date());
  nhwList.forEach(hw=>{
    if(hw.done||!hw.subject)return;
    if(hw.targetDate&&hw.targetDate<tk)return;
    const nx=findNext(hw.subject);
    if(nx&&(nx.date!==hw.targetDate||nx.pair!==hw.targetPair))
      db.ref(`newHomework/${hw.id}`).update({targetDate:nx.date,targetPair:nx.pair});
  });
}

// ============ IMAGE UPLOAD ============
function handleImgUpload(event,areaId,storeKey){
  const files=event.target.files;if(!files.length)return;
  if(!pendingImgs[storeKey])pendingImgs[storeKey]=[];
  const area=document.getElementById(areaId);
  Array.from(files).forEach(file=>{
    if(file.size>10*1024*1024){alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 10–ú–ë)');return}
    const reader=new FileReader();
    reader.onload=e=>{
      pendingImgs[storeKey].push(file);
      const wrap=document.createElement('div');wrap.className='img-preview-wrap';
      const idx=pendingImgs[storeKey].length-1;
      wrap.innerHTML=`<img class="img-preview" src="${e.target.result}"><button class="img-preview-del" onclick="removePendingImg('${storeKey}',${idx},this)">‚úï</button>`;
      area.insertBefore(wrap,area.lastElementChild);
    };
    reader.readAsDataURL(file);
  });
  event.target.value='';
}

function removePendingImg(storeKey,idx,btn){
  pendingImgs[storeKey][idx]=null;
  btn.parentElement.remove();
}

async function uploadImages(storeKey,progId){
  const files=(pendingImgs[storeKey]||[]).filter(f=>f!==null);
  if(!files.length)return[];
  const prog=document.getElementById(progId);
  const urls=[];
  for(let i=0;i<files.length;i++){
    if(prog)prog.textContent=`–ó–∞–≥—Ä—É–∑–∫–∞ ${i+1}/${files.length}...`;
    const ref=storage.ref(`homework/${Date.now()}_${Math.random().toString(36).substr(2,9)}_${files[i].name}`);
    await ref.put(files[i]);
    const url=await ref.getDownloadURL();
    urls.push(url);
  }
  if(prog)prog.textContent='';
  pendingImgs[storeKey]=[];
  return urls;
}

function viewImg(url){
  const v=document.getElementById('img-viewer');
  document.getElementById('img-viewer-img').src=url;
  v.classList.add('on');
}

// ============ CUSTOM SELECT ============
function buildCS(cid,selId,onChange){
  const c=document.getElementById(cid);
  const sorted=[...subjList].sort((a,b)=>a.name.localeCompare(b.name));
  const sel=sorted.find(s=>s.id===selId);
  css[cid]={selectedId:selId||'',onChange};
  const opts=sorted.map(s=>`<div class="cs-opt${s.id===selId?' sel':''}" data-sid="${s.id}">${esc(s.name)}${s.room?' ¬∑ '+esc(s.room):''}</div>`).join('');
  c.innerHTML=`<div class="cs"><div class="cs-trig" data-cid="${cid}">${sel?`<span class="cst-name">${esc(sel.name)}</span>`:'<span class="cst-ph">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</span>'}<span class="cst-arr">‚ñº</span></div><div class="cs-dd" id="${cid}-dd"><div class="cs-opt emp" data-sid="">‚Äî –ù–µ—Ç –ø–∞—Ä—ã ‚Äî</div>${opts}</div></div>`;
  c.querySelector('.cs-trig').addEventListener('click',e=>{e.stopPropagation();const dd=document.getElementById(cid+'-dd'),tr=c.querySelector('.cs-trig'),wo=dd.classList.contains('op');closeAllCS();if(!wo){dd.classList.add('op');tr.classList.add('op')}});
  c.querySelectorAll('.cs-opt').forEach(o=>{o.addEventListener('click',e=>{e.stopPropagation();const id=o.dataset.sid,subj=id?subjList.find(s=>s.id===id):null;css[cid].selectedId=id;const tr=c.querySelector('.cs-trig');tr.innerHTML=subj?`<span class="cst-name">${esc(subj.name)}</span><span class="cst-arr">‚ñº</span>`:`<span class="cst-ph">‚Äî –Ω–µ—Ç –ø–∞—Ä—ã ‚Äî</span><span class="cst-arr">‚ñº</span>`;c.querySelectorAll('.cs-opt').forEach(x=>x.classList.remove('sel'));o.classList.add('sel');closeAllCS();css[cid].onChange?.(id,subj)})});
}
function closeAllCS(){document.querySelectorAll('.cs-dd.op').forEach(d=>d.classList.remove('op'));document.querySelectorAll('.cs-trig.op').forEach(t=>t.classList.remove('op'))}
function gcsv(id){return css[id]?.selectedId||''}
document.addEventListener('click',()=>closeAllCS());

// ============ AUTH ============
auth.onAuthStateChanged(u=>{if(u){curUser=u;isAdmin=ADMINS.includes(u.uid);isGuest=false;showApp()}else if(localStorage.getItem('gs')){isGuest=true;showApp()}});
function doLogin(){const e=document.getElementById('login-email').value.trim(),p=document.getElementById('login-password').value;if(!e||!p){showLE('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');return}auth.signInWithEmailAndPassword(e,p).catch(()=>showLE('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'))}
function showLE(m){const e=document.getElementById('login-error');e.textContent=m;e.style.display='block'}
function enterAsGuest(){isGuest=true;isAdmin=false;curUser=null;localStorage.setItem('gs','1');showApp()}
function doLogout(){localStorage.removeItem('gs');auth.signOut().then(()=>{isGuest=false;isAdmin=false;curUser=null;document.getElementById('app').style.display='none';document.getElementById('login-screen').style.display='flex'})}

function showApp(){
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='block';
  document.querySelectorAll('.adm').forEach(el=>el.style.display=isAdmin?'':'none');
  init();
}

function init(){
  setupTabs();loadData();
  vws=getMonday(new Date());
  selDayIdx=todayIdx();
  updateAll();
}

function setupTabs(){document.querySelectorAll('.btab').forEach(b=>{b.addEventListener('click',()=>{document.querySelectorAll('.btab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.sec').forEach(x=>x.classList.remove('on'));b.classList.add('active');document.getElementById(b.dataset.s).classList.add('on')})})}

function loadData(){
  db.ref('settings').on('value',s=>{if(s.val()){cfg={...cfg,...s.val()};if(cfg.weekStartDate)document.getElementById('ws-date').value=cfg.weekStartDate}updateAll()});
  db.ref('schedule').on('value',s=>{sched=s.val()||{upper:{},lower:{}};renderDay();recalcHw()});
  db.ref('homework').on('value',s=>{const d=s.val();hwList=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];renderDay()});
  db.ref('subjects').on('value',s=>{const d=s.val();subjList=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];renderSubjs();renderDay()});
  db.ref('newHomework').on('value',s=>{const d=s.val();nhwList=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];renderHwTab();renderDay();updateHwBadge()});
  db.ref('changes').on('value',s=>{const d=s.val();chgList=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];cleanPast();renderDay();renderChgs();renderDaySel();recalcHw()});
  document.getElementById('ws-date').addEventListener('change',e=>{if(isAdmin)db.ref('settings/weekStartDate').set(e.target.value)});
}

function cleanPast(){if(!isAdmin)return;const tk=fdk(new Date());chgList.forEach(c=>{if(c.date<tk)db.ref(`changes/${c.id}`).remove()})}
function prevWeek(){vws.setDate(vws.getDate()-7);selDayIdx=0;updateAll()}
function nextWeek(){vws.setDate(vws.getDate()+7);selDayIdx=0;updateAll()}

function updateAll(){
  updateWeekNav();renderDaySel();renderDay();
}

function updateWeekNav(){
  const e=new Date(vws);e.setDate(e.getDate()+5);const wt=gwt(vws);
  document.getElementById('wn-range').textContent=`${fds(vws)} ‚Äî ${fds(e)}`;
  document.getElementById('wn-type').textContent=wt==='upper'?'–≤–µ—Ä—Ö–Ω—è—è –Ω–µ–¥–µ–ª—è':'–Ω–∏–∂–Ω—è—è –Ω–µ–¥–µ–ª—è';
  const wp=document.getElementById('h-week');
  wp.textContent=wt==='upper'?'–í–µ—Ä—Ö–Ω—è—è':'–ù–∏–∂–Ω—è—è';
  wp.className='week-pill '+wt;
}

function renderDaySel(){
  const c=document.getElementById('day-sel'),tk=fdk(new Date());
  let h='';
  for(let i=0;i<6;i++){
    const dd=new Date(vws);dd.setDate(dd.getDate()+i);
    const dk=fdk(dd),isT=dk===tk;
    const hasCh=chgList.some(c=>c.date===dk);
    h+=`<button class="day-btn ${i===selDayIdx?'active':''} ${isT?'today-dot':''} ${hasCh?'has-chg':''}" onclick="selectDay(${i})"><div class="db-name">${DFS[i]}</div><div class="db-num">${new Date(dd).getDate()}</div></button>`;
  }
  c.innerHTML=h;
}

function selectDay(idx){selDayIdx=idx;renderDaySel();renderDay()}

function renderDay(){
  const c=document.getElementById('day-view');
  const dd=new Date(vws);dd.setDate(dd.getDate()+selDayIdx);
  const dk=DS[selDayIdx],dateKey=fdk(dd),tk=fdk(new Date()),isT=dateKey===tk;
  const wt=gwt(vws),wd=sched[wt]||{};
  const ch=chgList.find(c=>c.date===dateKey),hasCh=!!ch;
  const lessons=hasCh?(ch.lessons||{}):(wd[dk]||{});

  let h=`<div class="day-card">
    <div class="day-head">
      <div><div class="dh-title">${DF[selDayIdx]}</div><div class="dh-date">${fds(dd)}</div></div>
      <div class="dh-badges">${hasCh?'<span class="badge-c">‚ö° –ó–∞–º–µ–Ω–∞</span>':''}${isT?'<span class="badge-t">–°–µ–≥–æ–¥–Ω—è</span>':''}</div>
    </div>
    <div class="les-list">`;

  for(let p=1;p<=5;p++){
    const l=lessons[p],has=l&&l.name,time=cfg.pairTimes[p-1];
    const ho=hwList.filter(x=>x.date===dateKey&&x.pair===p);
    const hn=nhwList.filter(x=>x.targetDate===dateKey&&x.targetPair===p);

    h+=`<div class="les ${has?'':'empty'} ${hasCh&&has?'ch':''}" ${isAdmin&&!hasCh?`onclick="openLesMo('${dk}',${p},'${wt}')"`:''}>
      <div class="les-n"><div class="les-n-num">${p}</div><div class="les-n-time">${time?.start||''}</div></div>
      <div class="les-i">${has?`
        <div class="les-name">${esc(l.name)}</div>
        <div class="les-det">${l.room?`<span class="les-room">${esc(l.room)}</span>`:''}${l.teacher?`<span>üë§ ${esc(l.teacher)}</span>`:''}</div>
        ${isAdmin?`<button class="hw-btn-add" style="margin-top:6px" onclick="event.stopPropagation();openHwMo('${dateKey}',${p},'${esc(l.name)}')">+ –î–ó</button>`:''}
        ${renderHwInline(ho,'üìù –î–æ–º–∞—à–∫–∞','hw')}
        ${renderHwInline(hn,'üìã –î–ó','nh')}`
        :`<span class="les-empty-txt">${isAdmin&&!hasCh?'+ –ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å':'‚Äî'}</span>`}
      </div>
    </div>`;
  }
  h+=`</div></div>`;
  c.innerHTML=h;
}

function renderHwInline(list,title,type){
  if(!list?.length)return'';
  return list.map(h=>{
    const imgs=(h.images||[]).map(url=>`<img class="hw-img" src="${url}" onclick="event.stopPropagation();viewImg('${url}')">`).join('');
    return`<div class="les-hw ${h.done?'done':''}" onclick="event.stopPropagation()">
      <div class="hw-hd"><span class="hw-lbl">${title}</span><div style="display:flex;gap:4px">
        <button class="btn btn-xs ${h.done?'btn-s':'btn-ok'}" onclick="${type==='hw'?`toggleOldHw('${h.id}')`:`toggleNH('${h.id}')`}">${h.done?'‚Ü©':'‚úì'}</button>
        ${isAdmin?`<button class="btn btn-xs btn-d" onclick="${type==='hw'?`delOldHw('${h.id}')`:`delNH('${h.id}')`}">‚úï</button>`:''}
      </div></div>
      <div class="hw-txt">${esc(h.task)}</div>
      ${imgs?`<div class="hw-imgs">${imgs}</div>`:''}
    </div>`;
  }).join('');
}

// ============ SUBJECTS ============
function renderSubjs(){
  const c=document.getElementById('subj-list');
  if(!subjList.length){c.innerHTML='<div class="empty-s"><div class="es-ico">üìñ</div><div class="es-txt">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div></div>';return}
  c.innerHTML=subjList.sort((a,b)=>a.name.localeCompare(b.name)).map(s=>`<div class="subj-c"><div class="subj-ico">üìñ</div><div class="subj-info"><div class="subj-nm">${esc(s.name)}</div><div class="subj-mt">${s.room?`<span>üìç ${esc(s.room)}</span>`:''}${s.teacher?`<span>üë§ ${esc(s.teacher)}</span>`:''}</div></div><div class="subj-acts"><button class="btn btn-xs btn-s" onclick="editSubj('${s.id}')">‚úèÔ∏è</button><button class="btn btn-xs btn-d" onclick="delSubj('${s.id}')">‚úï</button></div></div>`).join('');
}
function openSubjModal(eid){
  document.getElementById('subj-eid').value=eid||'';
  document.getElementById('subj-name').value='';document.getElementById('subj-room').value='';document.getElementById('subj-teacher').value='';
  if(eid){const s=subjList.find(x=>x.id===eid);if(s){document.getElementById('subj-name').value=s.name||'';document.getElementById('subj-room').value=s.room||'';document.getElementById('subj-teacher').value=s.teacher||''}}
  openMo('subj-mo');
}
function editSubj(id){openSubjModal(id)}
function saveSubj(){const id=document.getElementById('subj-eid').value,n=document.getElementById('subj-name').value.trim(),r=document.getElementById('subj-room').value.trim(),t=document.getElementById('subj-teacher').value.trim();if(!n){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');return}if(id)db.ref(`subjects/${id}`).set({name:n,room:r,teacher:t});else db.ref('subjects').push({name:n,room:r,teacher:t});closeMo('subj-mo')}
function delSubj(id){if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`subjects/${id}`).remove()}

// ============ HW TAB ============
function renderHwTab(){
  const c=document.getElementById('hw-tab-list'),tk=fdk(new Date());
  const p=nhwList.filter(h=>h.targetDate&&h.targetDate>=tk&&!h.done).sort((a,b)=>a.targetDate.localeCompare(b.targetDate));
  if(!p.length){c.innerHTML='<div class="empty-s"><div class="es-ico">‚úÖ</div><div class="es-txt">–í—Å—ë —Å–¥–µ–ª–∞–Ω–æ!</div></div>';return}
  c.innerHTML=p.map(h=>{
    const imgs=(h.images||[]).map(url=>`<img class="hwc-img" src="${url}" onclick="viewImg('${url}')">`).join('');
    return`<div class="hw-card"><div class="hwc-top"><div class="hwc-subj">üìñ ${esc(h.subject)}</div><div class="hwc-due">üìÖ ${fdf(pdk(h.targetDate))}</div></div><div class="hwc-task">${esc(h.task)}</div>${imgs?`<div class="hwc-imgs">${imgs}</div>`:''}<div class="hwc-acts"><button class="btn btn-xs btn-ok" onclick="toggleNH('${h.id}')">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>${isAdmin?`<button class="btn btn-xs btn-d" onclick="delNH('${h.id}')">‚úï</button>`:''}</div></div>`;
  }).join('');
}
function updateHwBadge(){const tk=fdk(new Date()),n=nhwList.filter(h=>h.targetDate&&h.targetDate>=tk&&!h.done).length;const nav=document.getElementById('hw-nav');nav.innerHTML=n>0?`<span class="bt-ico">üìã</span><span class="bt-txt">–î–ó</span><span class="bt-badge">${n}</span>`:`<span class="bt-ico">üìã</span><span class="bt-txt">–î–ó</span>`}

function openNewHwModal(){
  if(!isAdmin)return;
  pendingImgs['nhw-img-urls']=[];
  buildCS('nhw-sel-c','',(_,subj)=>{
    const info=document.getElementById('nhw-next');
    if(subj?.name){const nx=findNext(subj.name);if(nx)info.innerHTML=`üìÖ ${fdf(pdk(nx.date))} <span style="color:var(--t3)">(–ø–∞—Ä–∞ ${nx.pair})</span>`;else info.innerHTML='‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ'}
    else info.innerHTML='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...';
  });
  document.getElementById('nhw-task').value='';
  document.getElementById('nhw-next').innerHTML='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...';
  resetImgArea('nhw-imgs-area');
  openMo('nhw-mo');
}

async function saveNewHw(){
  if(!isAdmin)return;
  const sid=gcsv('nhw-sel-c'),subj=subjList.find(s=>s.id===sid);
  if(!subj){alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç');return}
  const task=document.getElementById('nhw-task').value.trim();
  if(!task){alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ');return}
  const nx=findNext(subj.name);if(!nx){alert('–ü–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');return}
  const images=await uploadImages('nhw-img-urls','nhw-upload-prog');
  db.ref('newHomework').push({subject:subj.name,task,targetDate:nx.date,targetPair:nx.pair,done:false,images:images.length?images:null,created:new Date().toISOString()});
  closeMo('nhw-mo');
}

function toggleNH(id){const h=nhwList.find(x=>x.id===id);if(h)db.ref(`newHomework/${id}/done`).set(!h.done)}
function delNH(id){if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`newHomework/${id}`).remove()}

// ============ OLD HW ============
function openHwMo(dk,pair,subj){
  if(!isAdmin)return;
  pendingImgs['hw-img-urls']=[];
  document.getElementById('hw-date').value=dk;document.getElementById('hw-pair').value=pair;
  document.getElementById('hw-subject').value=subj;document.getElementById('hw-task').value='';
  resetImgArea('hw-imgs-area');
  openMo('hw-mo');
}

async function saveOldHw(){
  if(!isAdmin)return;
  const task=document.getElementById('hw-task').value.trim();if(!task){alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ');return}
  const images=await uploadImages('hw-img-urls','hw-upload-prog');
  db.ref('homework').push({date:document.getElementById('hw-date').value,pair:parseInt(document.getElementById('hw-pair').value),subject:document.getElementById('hw-subject').value,task,done:false,images:images.length?images:null,created:new Date().toISOString()});
  closeMo('hw-mo');
}
function toggleOldHw(id){const h=hwList.find(x=>x.id===id);if(h)db.ref(`homework/${id}/done`).set(!h.done)}
function delOldHw(id){if(!isAdmin)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`homework/${id}`).remove()}

function resetImgArea(areaId){
  const area=document.getElementById(areaId);
  const wraps=area.querySelectorAll('.img-preview-wrap');
  wraps.forEach(w=>w.remove());
}

// ============ CHANGES ============
function renderChgs(){
  const c=document.getElementById('chg-list'),tk=fdk(new Date());
  const f=chgList.filter(x=>x.date>=tk).sort((a,b)=>a.date.localeCompare(b.date));
  if(!f.length){c.innerHTML='<div class="empty-s"><div class="es-ico">‚ö°</div><div class="es-txt">–ù–µ—Ç –∑–∞–º–µ–Ω</div></div>';return}
  c.innerHTML=f.map(ch=>{
    let lh='';const ls=ch.lessons||{};
    for(let p=1;p<=5;p++){const l=ls[p];if(l?.name)lh+=`<div class="chg-lr"><div class="chg-pn">${p}</div><div><div class="chg-ln">${esc(l.name)}</div><div class="chg-ld">${l.room?'üìç '+esc(l.room):''}${l.teacher?' ¬∑ üë§ '+esc(l.teacher):''}</div></div></div>`}
    if(!lh)lh='<div style="color:var(--t3);padding:8px;font-size:.85em">–ü–∞—Ä –Ω–µ—Ç</div>';
    return`<div class="chg-card"><div class="chg-hd"><span class="chg-dt">üìÖ ${fdf(pdk(ch.date))}</span><div style="display:flex;gap:4px"><button class="btn btn-xs btn-s" onclick="editChg('${ch.id}')">‚úèÔ∏è</button><button class="btn btn-xs btn-d" onclick="delChgById('${ch.id}')">‚úï</button></div></div>${lh}</div>`;
  }).join('');
}

function openChgModal(eid){
  if(!isAdmin)return;
  document.getElementById('chg-eid').value=eid||'';
  document.getElementById('chg-del-btn').style.display=eid?'block':'none';
  document.getElementById('chg-date').value='';
  let ph='';for(let i=1;i<=5;i++)ph+=`<div style="margin-bottom:10px"><div style="font-weight:700;font-size:.82em;color:var(--t2);margin-bottom:6px">${i} –ø–∞—Ä–∞</div><div id="cs-chg-${i}"></div></div>`;
  document.getElementById('chg-pairs-c').innerHTML=ph;
  for(let i=1;i<=5;i++)buildCS(`cs-chg-${i}`,'',null);
  if(eid){const ch=chgList.find(c=>c.id===eid);if(ch){document.getElementById('chg-date').value=ch.date;if(ch.lessons)for(let i=1;i<=5;i++){const l=ch.lessons[i];if(l?.name){const s=subjList.find(x=>x.name===l.name);if(s)buildCS(`cs-chg-${i}`,s.id,null)}}}}
  openMo('chg-mo');
}
function editChg(id){openChgModal(id)}
function saveChg(){
  if(!isAdmin)return;
  const eid=document.getElementById('chg-eid').value,date=document.getElementById('chg-date').value;
  if(!date){alert('–î–∞—Ç–∞');return}
  const lessons={};let any=false;
  for(let i=1;i<=5;i++){const sid=gcsv(`cs-chg-${i}`),subj=subjList.find(s=>s.id===sid);if(subj){lessons[i]={name:subj.name,room:subj.room||'',teacher:subj.teacher||''};any=true}}
  const data={date,lessons:any?lessons:null};
  if(eid)db.ref(`changes/${eid}`).set(data);else db.ref('changes').push(data);
  closeMo('chg-mo');
}
function delChg(){const id=document.getElementById('chg-eid').value;if(id){delChgById(id);closeMo('chg-mo')}}
function delChgById(id){if(!isAdmin)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`changes/${id}`).remove()}

// ============ LESSON MODAL ============
function openMo(id){document.getElementById(id).classList.add('on')}
function closeMo(id){document.getElementById(id).classList.remove('on')}

function openLesMo(day,pair,week){
  if(!isAdmin)return;
  document.getElementById('ed-day').value=day;document.getElementById('ed-pair').value=pair;document.getElementById('ed-week').value=week;
  const l=sched[week]?.[day]?.[pair]||{};let csid='';
  if(l.name){const s=subjList.find(x=>x.name===l.name);if(s)csid=s.id}
  buildCS('les-sel-c',csid,null);openMo('les-mo');
}
function saveLes(){
  if(!isAdmin)return;
  const d=document.getElementById('ed-day').value,p=document.getElementById('ed-pair').value,w=document.getElementById('ed-week').value;
  const sid=gcsv('les-sel-c'),subj=subjList.find(s=>s.id===sid);
  if(subj)db.ref(`schedule/${w}/${d}/${p}`).set({name:subj.name,room:subj.room||'',teacher:subj.teacher||''});
  else db.ref(`schedule/${w}/${d}/${p}`).remove();
  closeMo('les-mo');
}
function delLes(){if(!isAdmin)return;db.ref(`schedule/${document.getElementById('ed-week').value}/${document.getElementById('ed-day').value}/${document.getElementById('ed-pair').value}`).remove();closeMo('les-mo')}

// ============ TIMES ============
function openTimesModal(){
  if(!isAdmin)return;
  document.getElementById('times-form').innerHTML=cfg.pairTimes.map((t,i)=>`<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px"><span style="min-width:45px;font-weight:700;color:var(--ac);font-size:.85em">${i+1}</span><input type="time" id="ts${i}" value="${t.start}" class="set-inp" style="flex:1"><span style="color:var(--t3)">‚Äî</span><input type="time" id="te${i}" value="${t.end}" class="set-inp" style="flex:1"></div>`).join('');
  openMo('times-mo');
}
function saveTimes(){if(!isAdmin)return;const t=[];for(let i=0;i<5;i++)t.push({start:document.getElementById(`ts${i}`).value,end:document.getElementById(`te${i}`).value});db.ref('settings/pairTimes').set(t);closeMo('times-mo')}
function clearAll(){if(!isAdmin)return;if(confirm('–£–¥–∞–ª–∏—Ç—å –í–°–Å?')){db.ref('schedule').remove();db.ref('homework').remove();db.ref('newHomework').remove();db.ref('changes').remove();db.ref('subjects').remove()}}

document.getElementById('login-password').addEventListener('keypress',e=>{if(e.key==='Enter')doLogin()});
document.getElementById('login-email').addEventListener('keypress',e=>{if(e.key==='Enter')document.getElementById('login-password').focus()});
</script>
</body>
</html>
