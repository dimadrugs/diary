<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–î–Ω–µ–≤–Ω–∏–∫</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–î–Ω–µ–≤–Ω–∏–∫">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#6366f1">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0a0f;--bg2:#12121a;--card:rgba(255,255,255,0.02);--card2:rgba(255,255,255,0.05);--inp:rgba(255,255,255,0.05);--brd:rgba(255,255,255,0.05);--brd2:rgba(255,255,255,0.1);--t1:#fff;--t2:rgba(255,255,255,0.7);--t3:rgba(255,255,255,0.4);--ac:#6366f1}
    [data-theme="light"]{--bg:#f5f5f7;--bg2:#fff;--card:rgba(0,0,0,0.03);--card2:rgba(0,0,0,0.06);--inp:rgba(0,0,0,0.05);--brd:rgba(0,0,0,0.08);--brd2:rgba(0,0,0,0.12);--t1:#1a1a1a;--t2:rgba(0,0,0,0.7);--t3:rgba(0,0,0,0.4)}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html{height:-webkit-fill-available}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);min-height:100vh;min-height:-webkit-fill-available;color:var(--t1);-webkit-font-smoothing:antialiased;transition:background .3s,color .3s}
    .safe-top{position:fixed;top:0;left:0;right:0;height:env(safe-area-inset-top);background:var(--bg2);z-index:101}
    .container{max-width:1000px;margin:0 auto;padding:20px;padding-left:calc(20px + env(safe-area-inset-left));padding-right:calc(20px + env(safe-area-inset-right));padding-bottom:calc(20px + env(safe-area-inset-bottom))}
    header{background:var(--bg2);border-bottom:1px solid var(--brd);padding:15px 20px;padding-top:calc(15px + env(safe-area-inset-top));padding-left:calc(20px + env(safe-area-inset-left));padding-right:calc(20px + env(safe-area-inset-right));position:sticky;top:0;z-index:100}
    .hdr{max-width:1000px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    .hdr-l{display:flex;align-items:center;gap:12px}
    .logo{font-size:1.4em;font-weight:700;background:linear-gradient(135deg,#6366f1,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .hdr-date{font-size:.85em;color:var(--t2);font-weight:500}
    .hdr-r{display:flex;align-items:center;gap:8px}
    .hdr-week{padding:5px 12px;border-radius:20px;font-size:.75em;font-weight:600}
    .hdr-week.upper{background:linear-gradient(135deg,#10b981,#34d399);color:#000}
    .hdr-week.lower{background:linear-gradient(135deg,#f43f5e,#fb7185);color:#fff}
    .theme-btn{width:36px;height:36px;border-radius:8px;background:var(--card);border:1px solid var(--brd);color:var(--t1);font-size:1.1em;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .theme-btn:hover{background:var(--card2)}
    .user-info{display:flex;align-items:center;gap:6px;font-size:.8em;color:var(--t2)}
    .admin-badge{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000;padding:3px 8px;border-radius:12px;font-size:.7em;font-weight:600}
    .btn{padding:10px 20px;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:.9em;transition:all .2s;font-family:inherit}
    .btn-p{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff}
    .btn-s{background:var(--card);color:var(--t1);border:1px solid var(--brd)}
    .btn-d{background:linear-gradient(135deg,#ef4444,#f87171);color:#fff}
    .btn-w{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000}
    .btn:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(0,0,0,.2)}
    .btn:active{transform:scale(.98)}
    .btn-sm{padding:6px 12px;font-size:.8em}
    .btn-xs{padding:4px 8px;font-size:.75em}
    .btn-icon{width:44px;height:44px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:12px;font-size:1.2em;background:var(--card);color:var(--t1);border:1px solid var(--brd);cursor:pointer;transition:all .2s}
    .btn-icon:hover{background:var(--card2)}
    .btn-icon:active{transform:scale(.95)}
    .week-nav{display:flex;align-items:center;justify-content:center;gap:20px;padding:14px 20px;background:var(--card);border-radius:16px;margin-bottom:20px;border:1px solid var(--brd)}
    .week-info{text-align:center;min-width:180px}
    .week-range{font-size:1.1em;font-weight:700;color:var(--t1);margin-bottom:3px}
    .week-type{font-size:.8em;font-weight:600}
    .week-type.upper{color:#34d399}
    .week-type.lower{color:#fb7185}
    .nav{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
    .nav.hidden{display:none}
    .nav-btn{padding:10px 16px;border:none;background:var(--card);color:var(--t2);border-radius:10px;cursor:pointer;font-size:.85em;font-weight:500;transition:all .2s;font-family:inherit;border:1px solid var(--brd)}
    .nav-btn:hover{background:var(--card2);color:var(--t1)}
    .nav-btn.active{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;border-color:transparent}
    .sec{display:none}.sec.active{display:block;animation:fi .3s ease}
    @keyframes fi{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
    .days{display:flex;flex-direction:column;gap:16px}
    .day{background:var(--card);border-radius:16px;overflow:hidden;border:1px solid var(--brd)}
    .day.today{border-color:rgba(99,102,241,.4);box-shadow:0 0 30px rgba(99,102,241,.1)}
    .day.changed{border-color:rgba(245,158,11,.4)}
    .day.archived{border-color:rgba(16,185,129,.3)}
    .day-h{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:var(--card2);border-bottom:1px solid var(--brd)}
    .day-t{font-size:.95em;font-weight:600;display:flex;align-items:center;gap:8px;color:var(--t1)}
    .day-t .dt{font-weight:400;color:var(--t3);font-size:.85em}
    .day-b{display:flex;gap:5px;flex-wrap:wrap}
    .badge{padding:3px 8px;border-radius:10px;font-size:.65em;font-weight:600}
    .badge-today{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff}
    .badge-change{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000}
    .badge-arch{background:linear-gradient(135deg,#10b981,#34d399);color:#000}
    .day-c{padding:8px}
    .llist{display:flex;flex-direction:column;gap:5px}
    .lrow{display:flex;align-items:flex-start;gap:10px;padding:9px;background:var(--card);border-radius:9px;transition:all .2s;cursor:pointer}
    .lrow:hover{background:var(--card2)}
    .lrow.empty{opacity:.5}
    .lrow.chg{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3)}
    .lnum{width:42px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:5px;background:rgba(99,102,241,.15);border-radius:7px;flex-shrink:0}
    .ln{font-size:1.1em;font-weight:700;color:var(--ac)}
    .lt{font-size:.55em;color:var(--t3);margin-top:1px}
    .linfo{flex:1;min-width:0}
    .lnr{display:flex;align-items:center;gap:8px;margin-bottom:3px;flex-wrap:wrap}
    .lname{font-weight:600;font-size:.9em;color:var(--t1)}
    .ldet{display:flex;gap:10px;font-size:.75em;color:var(--t3);margin-bottom:5px;flex-wrap:wrap}
    .lroom{color:var(--ac)}
    .lempty{color:var(--t3);font-style:italic;font-size:.85em}
    .lhw{margin-top:7px;padding:8px;background:rgba(99,102,241,.1);border-radius:7px;border-left:3px solid var(--ac)}
    .lhw-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .lhw-t{font-size:.65em;color:var(--ac);font-weight:600;text-transform:uppercase}
    .lhw-txt{font-size:.8em;line-height:1.4;color:var(--t1)}
    .hw-btn{padding:3px 7px;background:rgba(99,102,241,.2);border:none;color:var(--ac);border-radius:5px;cursor:pointer;font-size:.7em;font-weight:600}
    .hw-btn:active{background:var(--ac);color:#fff}
    .wrap{background:var(--card);border-radius:16px;padding:20px;border:1px solid var(--brd)}
    .sh{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}
    .st{font-size:1.05em;font-weight:600;color:var(--t1)}
    .chlist{display:flex;flex-direction:column;gap:12px}
    .chcard{background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.2);border-radius:12px;padding:12px}
    .chh{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px}
    .chd{font-weight:600;font-size:.95em;color:#fbbf24}
    .chls{display:flex;flex-direction:column;gap:6px}
    .chlr{display:flex;align-items:center;gap:10px;padding:8px;background:rgba(0,0,0,.15);border-radius:7px}
    [data-theme="light"] .chlr{background:rgba(0,0,0,.05)}
    .chpn{width:26px;height:26px;background:rgba(245,158,11,.3);border-radius:5px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fbbf24;font-size:.85em}
    .chli{flex:1}.chln{font-weight:600;font-size:.9em;color:var(--t1)}
    .chld{font-size:.75em;color:var(--t3);display:flex;gap:8px;flex-wrap:wrap}
    .srow{display:flex;justify-content:space-between;align-items:center;padding:14px;background:var(--card2);border-radius:10px;margin-bottom:8px;flex-wrap:wrap;gap:10px}
    .srow h4{margin-bottom:3px;font-size:.9em;color:var(--t1)}
    .srow p{font-size:.75em;color:var(--t3)}
    .sinp{padding:9px 12px;border:1px solid var(--brd2);background:var(--inp);border-radius:9px;color:var(--t1);font-family:inherit;font-size:.9em}
    .modal-bg{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:1000;align-items:flex-start;justify-content:center;padding:20px;padding-top:calc(40px + env(safe-area-inset-top));overflow-y:auto}
    [data-theme="light"] .modal-bg{background:rgba(0,0,0,.5)}
    .modal-bg.active{display:flex}
    .modal{background:var(--bg2);border-radius:18px;padding:22px;width:100%;max-width:480px;border:1px solid var(--brd);animation:mi .3s ease;margin:auto}
    @keyframes mi{from{opacity:0;transform:scale(.95) translateY(-20px)}to{opacity:1;transform:scale(1) translateY(0)}}
    .modal h3{margin-bottom:18px;font-size:1.1em;color:var(--t1)}
    .fg{margin-bottom:14px}
    .fg label{display:block;margin-bottom:5px;color:var(--t2);font-size:.8em}
    .fg input,.fg textarea{width:100%;padding:11px 13px;border:1px solid var(--brd2);background:var(--inp);border-radius:9px;color:var(--t1);font-size:.95em;font-family:inherit;-webkit-appearance:none}
    .fg textarea{resize:vertical;min-height:70px}
    .fg input:focus,.fg textarea:focus{outline:none;border-color:var(--ac)}
    .mbtn{display:flex;gap:8px;margin-top:18px}
    .mbtn .btn{flex:1}
    .cpf{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .cpr{background:var(--card);border-radius:9px;padding:10px}
    .cprh{display:flex;align-items:center;gap:7px;margin-bottom:8px}
    .cpnb{width:24px;height:24px;background:rgba(245,158,11,.3);border-radius:5px;display:flex;align-items:center;justify-content:center;font-weight:700;color:#fbbf24;font-size:.8em}
    .cpi{display:flex;gap:6px;flex-wrap:wrap}
    .cpi input{flex:1;min-width:70px;padding:9px;border:1px solid var(--brd2);background:var(--inp);border-radius:7px;color:var(--t1);font-size:.85em;font-family:inherit;-webkit-appearance:none}
    .cpi input:focus{outline:none;border-color:#f59e0b}
    .cpi input::placeholder{color:var(--t3)}
    .auth{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;padding-top:calc(20px + env(safe-area-inset-top));background:var(--bg)}
    .auth-box{width:100%;max-width:360px;padding:28px;background:var(--card);border-radius:20px;border:1px solid var(--brd)}
    .auth-logo{text-align:center;font-size:3.5em;margin-bottom:8px}
    .auth-box h2{text-align:center;margin-bottom:6px;font-size:1.5em;color:var(--t1)}
    .auth-sub{text-align:center;color:var(--t3);margin-bottom:22px;font-size:.85em}
    .auth-box .btn{width:100%;padding:13px;margin-top:8px}
    .msg-e{background:rgba(244,63,94,.1);border:1px solid rgba(244,63,94,.3);color:#fb7185;padding:10px 14px;border-radius:9px;text-align:center;margin-bottom:14px;font-size:.83em;display:none}
    .divider{display:flex;align-items:center;gap:15px;margin:18px 0;color:var(--t3);font-size:.85em}
    .divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--brd)}
    .no{text-align:center;padding:40px 20px;color:var(--t3)}
    .install-prompt{position:fixed;bottom:calc(20px + env(safe-area-inset-bottom));left:20px;right:20px;background:var(--bg2);border:1px solid rgba(99,102,241,.3);border-radius:16px;padding:14px;display:none;align-items:center;gap:10px;z-index:999;box-shadow:0 10px 40px rgba(0,0,0,.3)}
    .install-prompt.show{display:flex;animation:su .3s ease}
    @keyframes su{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    @media(max-width:500px){
      .hdr{gap:8px}.hdr-l{gap:8px}.logo{font-size:1.1em}.hdr-date{font-size:.75em}
      .user-info span:not(.admin-badge){display:none}.week-nav{padding:12px;gap:12px}
      .week-range{font-size:.95em}.btn-icon{width:38px;height:38px}
      .cpi{flex-direction:column}.cpi input{width:100%}
      .srow{flex-direction:column;align-items:flex-start}
    }
  </style>
</head>
<body>
  <div class="safe-top"></div>

  <!-- AUTH -->
  <div id="auth-screen" class="auth">
    <div class="auth-box">
      <div class="auth-logo">üìö</div>
      <h2>–î–Ω–µ–≤–Ω–∏–∫</h2>
      <p class="auth-sub">–¢–µ—Ö–Ω–∏–∫—É–º</p>
      <div class="msg-e" id="msg-e"></div>
      <div class="fg"><label>üìß Email</label><input type="email" id="l-email" placeholder="admin@example.com" autocomplete="email"></div>
      <div class="fg"><label>üîí –ü–∞—Ä–æ–ª—å</label><input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
      <button class="btn btn-p" id="l-btn" onclick="doLogin()">–í–æ–π—Ç–∏</button>
      <div class="divider">–∏–ª–∏</div>
      <button class="btn btn-s" onclick="enterGuest()">üëÄ –í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å</button>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <header>
      <div class="hdr">
        <div class="hdr-l">
          <div class="logo">üìö –î–Ω–µ–≤–Ω–∏–∫</div>
          <div class="hdr-date" id="hdr-date"></div>
        </div>
        <div class="hdr-r">
          <div class="hdr-week" id="hdr-week"></div>
          <button class="theme-btn" onclick="toggleTheme()"><span id="t-icon">üåô</span></button>
          <div class="user-info">
            <span id="u-name"></span>
            <span class="admin-badge" id="a-badge" style="display:none">–ê–¥–º–∏–Ω</span>
          </div>
          <button class="btn btn-s btn-sm" onclick="doLogout()">–í—ã–π—Ç–∏</button>
        </div>
      </div>
    </header>
    <div class="container">
      <div class="week-nav">
        <button class="btn-icon" onclick="prevW()">‚Üê</button>
        <div class="week-info">
          <div class="week-range" id="w-range"></div>
          <div class="week-type" id="w-type"></div>
        </div>
        <button class="btn-icon" onclick="nextW()">‚Üí</button>
      </div>
      <div class="nav" id="main-nav">
        <button class="nav-btn active" data-s="home">üè† –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
        <button class="nav-btn" data-s="changes" id="ch-nav">üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <button class="nav-btn" data-s="settings" id="set-nav">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>
      <div class="sec active" id="home"><div class="days" id="days-grid"></div></div>
      <div class="sec" id="changes">
        <div class="wrap">
          <div class="sh"><h2 class="st">üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è</h2><button class="btn btn-w" onclick="openChModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
          <div class="chlist" id="ch-list"></div>
        </div>
      </div>
      <div class="sec" id="settings">
        <div class="wrap">
          <h2 class="st" style="margin-bottom:18px">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
          <div class="srow"><div><h4>–¢–µ–º–∞</h4><p>–°–≤–µ—Ç–ª–∞—è / —Ç—ë–º–Ω–∞—è</p></div><button class="btn btn-s" onclick="toggleTheme()">–°–º–µ–Ω–∏—Ç—å</button></div>
          <div class="srow"><div><h4>–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª—å</h4><p>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤–µ—Ä—Ö–Ω–µ–π</p></div><input type="date" class="sinp" id="ws-date"></div>
          <div class="srow"><div><h4>–í—Ä–µ–º—è –ø–∞—Ä</h4></div><button class="btn btn-s" onclick="openTimesM()">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button></div>
          <div class="srow"><div><h4>üóë –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</h4></div><button class="btn btn-d" onclick="clearAll()">–û—á–∏—Å—Ç–∏—Ç—å</button></div>
        </div>
      </div>
    </div>
  </div>

  <div class="install-prompt" id="inst-prompt">
    <span style="font-size:2em">üì≤</span>
    <div style="flex:1"><h4 style="font-size:.9em;color:var(--t1)">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω</h4><p style="font-size:.75em;color:var(--t3)">–ö–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p></div>
    <button class="btn btn-p btn-sm" onclick="doInstall()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <button style="background:none;border:none;color:var(--t3);font-size:1.5em;cursor:pointer" onclick="hideInst()">√ó</button>
  </div>

  <!-- MODALS -->
  <div class="modal-bg" id="m-lesson"><div class="modal"><h3>‚úèÔ∏è –ü–∞—Ä–∞</h3><input type="hidden" id="e-day"><input type="hidden" id="e-pair"><input type="hidden" id="e-week"><div class="fg"><label>–ü—Ä–µ–¥–º–µ—Ç</label><input type="text" id="le-name" placeholder="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞"></div><div class="fg"><label>–ö–∞–±–∏–Ω–µ—Ç</label><input type="text" id="le-room" placeholder="301"></div><div class="fg"><label>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</label><input type="text" id="le-teacher" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò."></div><div class="mbtn"><button class="btn btn-s" onclick="closeM('m-lesson')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-d" onclick="delLesson()">üóë</button><button class="btn btn-p" onclick="saveLesson()">üíæ</button></div></div></div>

  <div class="modal-bg" id="m-hw"><div class="modal"><h3>üìù –î–æ–º–∞—à–∫–∞</h3><input type="hidden" id="hw-dt"><input type="hidden" id="hw-pr"><div class="fg"><label>–ü—Ä–µ–¥–º–µ—Ç</label><input type="text" id="hw-subj" readonly style="opacity:.7"></div><div class="fg"><label>–ó–∞–¥–∞–Ω–∏–µ</label><textarea id="hw-task" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å..."></textarea></div><div class="mbtn"><button class="btn btn-s" onclick="closeM('m-hw')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-p" onclick="saveHW()">üíæ</button></div></div></div>

  <div class="modal-bg" id="m-change"><div class="modal"><h3>üìù –ò–∑–º–µ–Ω–µ–Ω–∏–µ</h3><input type="hidden" id="ch-eid"><div class="fg"><label>–î–∞—Ç–∞</label><input type="date" id="ch-date"></div><p style="color:var(--t3);font-size:.75em;margin-bottom:10px">–¢–æ–ª—å–∫–æ –ø–∞—Ä—ã –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç</p><div class="cpf" id="ch-pairs"></div><div class="mbtn"><button class="btn btn-s" onclick="closeM('m-change')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-d" id="ch-del" style="display:none" onclick="delCh2()">üóë</button><button class="btn btn-p" onclick="saveCh()">üíæ</button></div></div></div>

  <div class="modal-bg" id="m-times"><div class="modal"><h3>üïê –í—Ä–µ–º—è –ø–∞—Ä</h3><div id="times-f"></div><div class="mbtn"><button class="btn btn-s" onclick="closeM('m-times')">–û—Ç–º–µ–Ω–∞</button><button class="btn btn-p" onclick="saveTimes()">üíæ</button></div></div></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    // THEME
    function initT(){setT(localStorage.getItem('theme')||(matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'));}
    function setT(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('theme',t);const i=document.getElementById('t-icon');if(i)i.textContent=t==='dark'?'‚òÄÔ∏è':'üåô';document.querySelector('.safe-top').style.background=t==='dark'?'#12121a':'#fff';}
    function toggleTheme(){setT(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark');}
    initT();

    // FIREBASE
    firebase.initializeApp({apiKey:"AIzaSyBCy0hz_PHMGUX2M52Wnwb0C9nEnBBfeq8",authDomain:"my-diary-e223c.firebaseapp.com",databaseURL:"https://my-diary-e223c-default-rtdb.firebaseio.com",projectId:"my-diary-e223c",storageBucket:"my-diary-e223c.firebasestorage.app",messagingSenderId:"903986378920",appId:"1:903986378920:web:b6ebc6691f6d767f78aa9d"});
    const auth=firebase.auth(),D=firebase.database();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    const ADMINS=["zFKU6TAgIuhZetCOuWpHvDDw6Oj2"];
    const DS=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
    const DF=['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
    let cu=null,isA=false,isG=false;
    let sched={upper:{},lower:{}},hwL=[],chL=[],arch={};
    let cfg={weekStartDate:null,pairTimes:[{start:'08:30',end:'10:00'},{start:'10:10',end:'11:40'},{start:'12:10',end:'13:40'},{start:'13:50',end:'15:20'},{start:'15:30',end:'17:00'}]};
    let vw=getM(new Date()),dp=null;

    // AUTH
    function showE(m){const e=document.getElementById('msg-e');e.textContent=m;e.style.display='block';}
    function hideE(){document.getElementById('msg-e').style.display='none';}

    function doLogin(){
      hideE();
      const email=document.getElementById('l-email').value.trim(),pass=document.getElementById('l-pass').value;
      if(!email||!pass){showE('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è');return;}
      const btn=document.getElementById('l-btn');btn.textContent='–í—Ö–æ–¥–∏–º...';btn.disabled=true;
      auth.signInWithEmailAndPassword(email,pass).then(()=>{btn.textContent='–í–æ–π—Ç–∏';btn.disabled=false;}).catch(err=>{
        btn.textContent='–í–æ–π—Ç–∏';btn.disabled=false;
        if(err.code==='auth/user-not-found'||err.code==='auth/invalid-credential')showE('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
        else if(err.code==='auth/wrong-password')showE('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        else showE(err.message);
      });
    }

    function enterGuest(){isG=true;isA=false;cu=null;localStorage.setItem('gs','1');showApp();}

    function doLogout(){
      localStorage.removeItem('gs');
      auth.signOut().then(()=>{isG=false;isA=false;cu=null;
        document.getElementById('app').style.display='none';
        document.getElementById('auth-screen').style.display='flex';
      });
    }

    auth.onAuthStateChanged(u=>{
      if(u){cu=u;isA=ADMINS.includes(u.uid);isG=false;showApp();}
      else if(localStorage.getItem('gs')){isG=true;showApp();}
    });

    function showApp(){
      document.getElementById('auth-screen').style.display='none';
      document.getElementById('app').style.display='block';
      document.getElementById('a-badge').style.display=isA?'inline':'none';
      document.getElementById('set-nav').style.display=isA?'inline-block':'none';
      document.getElementById('ch-nav').style.display=isA?'inline-block':'none';
      document.getElementById('u-name').textContent=isG?'–ì–æ—Å—Ç—å':(cu?.displayName||cu?.email?.split('@')[0]||'');
      document.getElementById('main-nav').classList.toggle('hidden',!isA);
      initApp();
    }

    // UTILS
    function getM(d){const x=new Date(d);x.setHours(12,0,0,0);const w=x.getDay();x.setDate(x.getDate()-w+(w===0?-6:1));return x;}
    function fk(d){const x=new Date(d);return`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`;}
    function pk(s){const[y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d,12,0,0);}
    function fs(d){const x=new Date(d);return String(x.getDate()).padStart(2,'0')+'.'+String(x.getMonth()+1).padStart(2,'0');}
    function ff(d){return new Date(d).toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'});}
    function fh(d){return new Date(d).toLocaleDateString('ru-RU',{day:'numeric',month:'long',weekday:'long'});}
    function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
    function gwt(mon){
      if(!cfg.weekStartDate){const s=new Date(mon.getFullYear(),0,1);const w=Math.ceil(((mon-s)/864e5+s.getDay()+1)/7);return w%2===1?'upper':'lower';}
      const sd=getM(pk(cfg.weekStartDate));return Math.floor(Math.round((mon-sd)/864e5)/7)%2===0?'upper':'lower';
    }

    // INIT
    function initApp(){
      document.querySelectorAll('.nav-btn').forEach(b=>{b.onclick=()=>{
        document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.sec').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');document.getElementById(b.dataset.s).classList.add('active');
      };});
      loadData();vw=getM(new Date());updateHdr();
    }

    function loadData(){
      D.ref('settings').on('value',s=>{if(s.val()){cfg={...cfg,...s.val()};if(cfg.weekStartDate)document.getElementById('ws-date').value=cfg.weekStartDate;}updateAll();updateHdr();});
      D.ref('schedule').on('value',s=>{sched=s.val()||{upper:{},lower:{}};render();});
      D.ref('homework').on('value',s=>{const d=s.val();hwL=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];render();});
      D.ref('changes').on('value',s=>{const d=s.val();chL=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];autoArch();render();renderCh();});
      D.ref('archivedDays').on('value',s=>{arch=s.val()||{};render();});
      document.getElementById('ws-date').addEventListener('change',e=>{if(isA)D.ref('settings/weekStartDate').set(e.target.value);});
    }

    // ARCHIVE
    function autoArch(){
      if(!isA)return;const tk=fk(new Date());
      chL.forEach(c=>{if(c.date&&c.date<=tk&&!arch[c.date])archDay(c);});
    }
    function archDay(c){
      const dk=c.date,dd=pk(dk),mon=getM(dd),ww=gwt(mon);
      const dow=dd.getDay(),di=dow===0?5:dow-1,dayK=DS[di];
      const base=sched[ww]?.[dayK]||{};
      const fin=c.lessons?JSON.parse(JSON.stringify(c.lessons)):JSON.parse(JSON.stringify(base));
      const hw={};hwL.filter(h=>h.date===dk).forEach(h=>{hw[h.id]={pair:h.pair,subject:h.subject,task:h.task,done:h.done||false};});
      D.ref('archivedDays/'+dk).set({date:dk,dayName:DF[di]||'',weekType:ww,lessons:fin,homework:hw,archivedAt:new Date().toISOString()});
      if(c.id)D.ref('changes/'+c.id).remove();
    }

    // HEADER
    function updateHdr(){
      const t=new Date(),w=gwt(getM(t));
      document.getElementById('hdr-date').textContent=fh(t);
      const el=document.getElementById('hdr-week');
      el.textContent=w==='upper'?'‚òÄÔ∏è –í–µ—Ä—Ö–Ω—è—è':'üåô –ù–∏–∂–Ω—è—è';el.className='hdr-week '+w;
    }
    function updateNav(){
      const we=new Date(vw);we.setDate(we.getDate()+5);const w=gwt(vw);
      document.getElementById('w-range').textContent=`${fs(vw)} ‚Äî ${fs(we)}`;
      const te=document.getElementById('w-type');te.textContent=w==='upper'?'‚òÄÔ∏è –í–µ—Ä—Ö–Ω—è—è':'üåô –ù–∏–∂–Ω—è—è';te.className='week-type '+w;
    }
    function prevW(){vw.setDate(vw.getDate()-7);updateAll();}
    function nextW(){vw.setDate(vw.getDate()+7);updateAll();}
    function updateAll(){updateNav();render();}

    // RENDER
    function render(){
      const g=document.getElementById('days-grid');if(!g)return;
      const w=gwt(vw),wd=sched[w]||{},tk=fk(new Date());
      let h='';
      for(let i=0;i<6;i++){
        const dd=new Date(vw);dd.setDate(dd.getDate()+i);
        const dk=DS[i],dateK=fk(dd),isT=dateK===tk;
        const ar=arch[dateK],ch=chL.find(c=>c.date===dateK),hasCh=!!ch&&!ar;
        let les,hw=[],isAr=false;
        if(ar){les=ar.lessons||{};isAr=true;if(ar.homework)hw=Object.keys(ar.homework).map(k=>({id:k,...ar.homework[k],date:dateK}));}
        else if(hasCh){les=ch.lessons||{};hw=hwL.filter(x=>x.date===dateK);}
        else{les=wd[dk]||{};hw=hwL.filter(x=>x.date===dateK);}
        h+=`<div class="day ${isT?'today':''} ${hasCh?'changed':''} ${isAr?'archived':''}">
          <div class="day-h"><div class="day-t">${DF[i]} <span class="dt">${fs(dd)}</span></div>
          <div class="day-b">${isAr?'<span class="badge badge-arch">üîí</span>':''}${hasCh?'<span class="badge badge-change">‚ö°</span>':''}${isT?'<span class="badge badge-today">–°–µ–≥–æ–¥–Ω—è</span>':''}</div></div>
          <div class="day-c"><div class="llist">${rL(dk,les,w,dateK,hasCh,isAr,hw)}</div></div></div>`;
      }
      g.innerHTML=h;
    }

    function rL(dk,les,w,dateK,hasCh,isAr,hw){
      let h='';
      for(let p=1;p<=5;p++){
        const l=les[p],has=l&&l.name,t=cfg.pairTimes[p-1],hf=hw.filter(x=>x.pair===p);
        const ce=isA&&!hasCh&&!isAr,canHW=isA&&!isAr;
        h+=`<div class="lrow ${has?'':'empty'} ${hasCh&&has?'chg':''}" onclick="${ce?`openLM('${dk}',${p},'${w}')`:''}" style="${ce?'':'cursor:default'}">
          <div class="lnum"><div class="ln">${p}</div><div class="lt">${t?.start||''}</div></div>
          <div class="linfo">${has?`<div class="lnr"><span class="lname">${esc(l.name)}</span>${canHW?`<button class="hw-btn" onclick="event.stopPropagation();openHM('${dateK}',${p},'${esc(l.name)}')">+ –î–ó</button>`:''}</div>
          <div class="ldet">${l.room?`<span class="lroom">üìç ${esc(l.room)}</span>`:''}${l.teacher?`<span>üë§ ${esc(l.teacher)}</span>`:''}</div>${rHW(hf,isAr)}`
          :`<span class="lempty">${ce?'–î–æ–±–∞–≤–∏—Ç—å':'‚Äî'}</span>`}</div></div>`;
      }
      return h;
    }

    function rHW(list,isAr){
      if(!list||!list.length)return'';
      return list.map(hw=>`<div class="lhw" onclick="event.stopPropagation()">
        <div class="lhw-h"><span class="lhw-t">üìù –î–ó</span>
        ${!isAr&&isA?`<button class="btn btn-xs btn-d" onclick="dHW('${hw.id}')">‚úï</button>`:''}</div>
        <div class="lhw-txt">${esc(hw.task)}</div></div>`).join('');
    }

    // CHANGES
    function renderCh(){
      const list=document.getElementById('ch-list'),f=chL.filter(c=>!arch[c.date]);
      if(!f.length){list.innerHTML='<div class="no">–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>';return;}
      list.innerHTML=[...f].sort((a,b)=>a.date.localeCompare(b.date)).map(c=>`<div class="chcard">
        <div class="chh"><span class="chd">${ff(pk(c.date))}</span>
        <div><button class="btn btn-sm btn-s" onclick="editCh('${c.id}')">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-d" onclick="delCh('${c.id}')">‚úï</button></div></div>
        <div class="chls">${rCL(c.lessons)}</div></div>`).join('');
    }
    function rCL(les){
      if(!les)return'<div style="color:var(--t3);padding:8px">–ü–∞—Ä –Ω–µ—Ç</div>';
      let h='';for(let p=1;p<=5;p++){const l=les[p];if(l&&l.name)h+=`<div class="chlr"><div class="chpn">${p}</div><div class="chli"><div class="chln">${esc(l.name)}</div><div class="chld">${l.room?`<span>üìç ${esc(l.room)}</span>`:''}${l.teacher?`<span>üë§ ${esc(l.teacher)}</span>`:''}</div></div></div>`;}
      return h||'<div style="color:var(--t3);padding:8px">–ü–∞—Ä –Ω–µ—Ç</div>';
    }

    // MODALS
    function openM(id){document.getElementById(id).classList.add('active');}
    function closeM(id){document.getElementById(id).classList.remove('active');}

    function openLM(d,p,w){if(!isA)return;document.getElementById('e-day').value=d;document.getElementById('e-pair').value=p;document.getElementById('e-week').value=w;const l=sched[w]?.[d]?.[p]||{};document.getElementById('le-name').value=l.name||'';document.getElementById('le-room').value=l.room||'';document.getElementById('le-teacher').value=l.teacher||'';openM('m-lesson');}

    function saveLesson(){if(!isA)return;const d=document.getElementById('e-day').value,p=document.getElementById('e-pair').value,w=document.getElementById('e-week').value,n=document.getElementById('le-name').value.trim(),r=document.getElementById('le-room').value.trim(),t=document.getElementById('le-teacher').value.trim();if(n)D.ref(`schedule/${w}/${d}/${p}`).set({name:n,room:r,teacher:t});else D.ref(`schedule/${w}/${d}/${p}`).remove();closeM('m-lesson');}

    function delLesson(){if(!isA)return;D.ref(`schedule/${document.getElementById('e-week').value}/${document.getElementById('e-day').value}/${document.getElementById('e-pair').value}`).remove();closeM('m-lesson');}

    function openHM(dk,p,subj){if(!isA)return;document.getElementById('hw-dt').value=dk;document.getElementById('hw-pr').value=p;document.getElementById('hw-subj').value=subj;document.getElementById('hw-task').value='';openM('m-hw');}

    function saveHW(){if(!isA)return;const t=document.getElementById('hw-task').value.trim();if(!t){alert('–í–≤–µ–¥–∏ –∑–∞–¥–∞–Ω–∏–µ');return;}D.ref('homework').push({date:document.getElementById('hw-dt').value,pair:parseInt(document.getElementById('hw-pr').value),subject:document.getElementById('hw-subj').value,task:t,done:false,created:new Date().toISOString()});closeM('m-hw');}

    function dHW(id){if(!isA)return;if(confirm('–£–¥–∞–ª–∏—Ç—å –î–ó?'))D.ref(`homework/${id}`).remove();}

    function buildCP(){let h='';for(let i=1;i<=5;i++)h+=`<div class="cpr"><div class="cprh"><span class="cpnb">${i}</span><span style="font-weight:500;font-size:.85em;color:var(--t2)">–ø–∞—Ä–∞</span></div><div class="cpi"><input type="text" id="cp${i}n" placeholder="–ü—Ä–µ–¥–º–µ—Ç"><input type="text" id="cp${i}r" placeholder="–ö–∞–±." style="max-width:65px"><input type="text" id="cp${i}t" placeholder="–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å"></div></div>`;return h;}

    function openChModal(eid=null){
      if(!isA)return;document.getElementById('ch-pairs').innerHTML=buildCP();
      document.getElementById('ch-eid').value=eid||'';document.getElementById('ch-del').style.display=eid?'block':'none';
      document.getElementById('ch-date').value='';
      if(eid){const c=chL.find(x=>x.id===eid);if(c){document.getElementById('ch-date').value=c.date;if(c.lessons)for(let i=1;i<=5;i++){const l=c.lessons[i];if(l){document.getElementById(`cp${i}n`).value=l.name||'';document.getElementById(`cp${i}r`).value=l.room||'';document.getElementById(`cp${i}t`).value=l.teacher||'';}}}}
      openM('m-change');
    }
    function editCh(id){openChModal(id);}
    function saveCh(){
      if(!isA)return;const eid=document.getElementById('ch-eid').value,date=document.getElementById('ch-date').value;
      if(!date){alert('–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É');return;}if(arch[date]){alert('–î–µ–Ω—å —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');return;}
      const les={};let any=false;
      for(let i=1;i<=5;i++){const n=document.getElementById(`cp${i}n`).value.trim(),r=document.getElementById(`cp${i}r`).value.trim(),t=document.getElementById(`cp${i}t`).value.trim();if(n){les[i]={name:n,room:r,teacher:t};any=true;}}
      const data={date,lessons:any?les:null};
      if(eid)D.ref(`changes/${eid}`).set(data);else D.ref('changes').push(data);
      closeM('m-change');
    }
    function delCh2(){const id=document.getElementById('ch-eid').value;if(id){delCh(id);closeM('m-change');}}
    function delCh(id){if(!isA)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))D.ref(`changes/${id}`).remove();}

    // SETTINGS
    function openTimesM(){if(!isA)return;document.getElementById('times-f').innerHTML=cfg.pairTimes.map((t,i)=>`<div class="fg" style="display:flex;gap:8px;align-items:center;margin-bottom:10px"><span style="min-width:45px;font-weight:500;font-size:.9em">${i+1}</span><input type="time" id="ts${i}" value="${t.start}" class="sinp" style="flex:1"><span style="color:var(--t3)">‚Äî</span><input type="time" id="te${i}" value="${t.end}" class="sinp" style="flex:1"></div>`).join('');openM('m-times');}
    function saveTimes(){if(!isA)return;const t=[];for(let i=0;i<5;i++)t.push({start:document.getElementById(`ts${i}`).value,end:document.getElementById(`te${i}`).value});D.ref('settings/pairTimes').set(t);closeM('m-times');}
    function clearAll(){if(!isA)return;if(confirm('–£–¥–∞–ª–∏—Ç—å –í–°–Å?')){D.ref('schedule').remove();D.ref('homework').remove();D.ref('changes').remove();D.ref('archivedDays').remove();}}

    // PWA
    window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();dp=e;setTimeout(()=>{if(!localStorage.getItem('ipd'))document.getElementById('inst-prompt').classList.add('show');},3000);});
    function doInstall(){if(dp){dp.prompt();dp.userChoice.then(()=>{dp=null;hideInst();});}}
    function hideInst(){document.getElementById('inst-prompt').classList.remove('show');localStorage.setItem('ipd','1');}

    // LISTENERS
    document.querySelectorAll('.modal-bg').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active');});});
    document.getElementById('l-pass').addEventListener('keypress',e=>{if(e.key==='Enter')doLogin();});
    document.getElementById('l-email').addEventListener('keypress',e=>{if(e.key==='Enter')document.getElementById('l-pass').focus();});
  </script>
</body>
</html>
