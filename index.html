<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–î–Ω–µ–≤–Ω–∏–∫</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìì</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23007aff' width='100' height='100' rx='22'/><text x='50' y='68' text-anchor='middle' font-size='55'>üìì</text></svg>">
  <style>
    :root{--bg:#000;--bg2:#1c1c1e;--bg3:#2c2c2e;--bg4:#3a3a3c;--card:#1c1c1e;--text:#fff;--t2:rgba(255,255,255,.7);--t3:rgba(255,255,255,.4);--t4:rgba(255,255,255,.12);--blue:#0a84ff;--green:#30d158;--orange:#ff9f0a;--red:#ff453a;--purple:#bf5af2;--r:14px;--rs:10px;--navH:82px}
    [data-theme="light"]{--bg:#f2f2f7;--bg2:#fff;--bg3:#e5e5ea;--bg4:#d1d1d6;--card:#fff;--text:#000;--t2:rgba(0,0,0,.6);--t3:rgba(0,0,0,.35);--t4:rgba(0,0,0,.08);--blue:#007aff;--green:#34c759;--orange:#ff9500;--red:#ff3b30;--purple:#af52de}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html{height:-webkit-fill-available}
    body{font-family:-apple-system,'SF Pro Display','Inter',BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:-webkit-fill-available;-webkit-font-smoothing:antialiased;overflow-x:hidden;transition:background .3s,color .3s}
    ::-webkit-scrollbar{width:0;height:0}

    /* LOGIN */
    #loginPage{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;background:var(--bg)}
    .loginCard{width:100%;max-width:360px;text-align:center}
    .loginCard .logo{font-size:64px;margin-bottom:16px}
    .loginCard h1{font-size:28px;font-weight:700;margin-bottom:4px}
    .loginCard .sub{color:var(--t3);font-size:15px;margin-bottom:32px}
    .errMsg{background:rgba(255,69,58,.15);color:var(--red);padding:12px;border-radius:var(--rs);margin-bottom:16px;font-size:14px;font-weight:600;display:none}
    .inp{width:100%;padding:16px;font-size:16px;background:var(--bg2);color:var(--text);border:1px solid var(--t4);border-radius:var(--r);font-family:inherit;outline:none;margin-bottom:12px;-webkit-appearance:none;transition:border-color .2s}
    .inp:focus{border-color:var(--blue)}
    textarea.inp{resize:vertical;min-height:80px}
    .btnP{width:100%;padding:16px;border:none;border-radius:var(--r);background:var(--blue);color:#fff;font-size:17px;font-weight:600;font-family:inherit;cursor:pointer;transition:opacity .15s}
    .btnP:active{opacity:.7}
    .btnS{width:100%;padding:16px;border:none;border-radius:var(--r);background:var(--bg2);color:var(--text);font-size:17px;font-weight:600;font-family:inherit;cursor:pointer;border:1px solid var(--t4);transition:opacity .15s}
    .btnS:active{opacity:.7}
    .btnD{width:100%;padding:16px;border:none;border-radius:var(--r);background:var(--red);color:#fff;font-size:17px;font-weight:600;font-family:inherit;cursor:pointer;transition:opacity .15s}
    .btnD:active{opacity:.7}
    .divLine{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--t3);font-size:13px}
    .divLine::before,.divLine::after{content:'';flex:1;height:1px;background:var(--t4)}

    /* APP */
    #appPage{display:none}

    /* TOP */
    .top{padding:8px 20px 10px;padding-top:calc(8px + env(safe-area-inset-top));position:sticky;top:0;z-index:50;background:var(--bg);transition:background .3s}
    .topRow{display:flex;justify-content:space-between;align-items:center;max-width:600px;margin:0 auto}
    .topLeft{display:flex;align-items:center;gap:10px}
    .topTitle{font-size:28px;font-weight:700;letter-spacing:-.5px}
    .topRight{display:flex;gap:8px;align-items:center}
    .pillBadge{padding:4px 10px;border-radius:20px;font-size:12px;font-weight:700}
    .pillBadge.up{background:rgba(48,209,88,.15);color:var(--green)}
    .pillBadge.lo{background:rgba(255,69,58,.15);color:var(--red)}
    .circBtn{width:36px;height:36px;border-radius:50%;background:var(--bg2);border:none;color:var(--text);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .1s}
    .circBtn:active{transform:scale(.9)}
    .topDate{font-size:13px;color:var(--t3);margin-top:2px;font-weight:500}

    /* WEEK STRIP ‚Äî fixed, no scroll */
    .weekBar{padding:8px 20px 14px;max-width:600px;margin:0 auto}
    .weekRow{display:flex;align-items:center;gap:4px}
    .wArrow{width:32px;height:52px;flex-shrink:0;background:var(--bg2);border:none;border-radius:var(--rs);color:var(--t2);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .1s}
    .wArrow:active{transform:scale(.9)}
    .dayChip{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 0 10px;border-radius:var(--r);cursor:pointer;transition:all .2s;position:relative;background:transparent;border:none;color:var(--text);font-family:inherit;min-width:0}
    .dayChip .dcD{font-size:11px;font-weight:600;color:var(--t3);text-transform:uppercase}
    .dayChip .dcN{font-size:18px;font-weight:700}
    .dayChip:active{transform:scale(.94)}
    .dayChip.sel{background:var(--blue);color:#fff}
    .dayChip.sel .dcD{color:rgba(255,255,255,.7)}
    .dayChip.sel .dcN{color:#fff}
    .dayChip.today:not(.sel)::after{content:'';position:absolute;bottom:4px;width:5px;height:5px;border-radius:50%;background:var(--blue)}
    .dayChip .dcDot{position:absolute;top:3px;right:3px;width:6px;height:6px;border-radius:50%;background:var(--orange)}
    .weekLabel{text-align:center;padding:4px 0 0;font-size:12px;color:var(--t3);font-weight:600}
    .weekLabel span.up{color:var(--green)}
    .weekLabel span.lo{color:var(--red)}

    /* CONTENT */
    .content{padding:0 20px calc(var(--navH) + env(safe-area-inset-bottom) + 16px);max-width:600px;margin:0 auto}
    .pg{display:none}
    .pg.on{display:block;animation:fadeUp .25s ease}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* LESSONS */
    .lList{display:flex;flex-direction:column;gap:8px}
    .lCard{background:var(--card);border-radius:var(--r);padding:14px 16px;display:flex;gap:12px;border:1px solid var(--t4);cursor:pointer;transition:transform .12s;position:relative}
    .lCard:active{transform:scale(.98)}
    .lCard.empty{opacity:.35;cursor:default}
    .lCard.empty:active{transform:none}
    .lCard.changed{border-left:3px solid var(--orange)}
    .pairN{width:44px;height:52px;background:rgba(10,132,255,.1);border-radius:var(--rs);display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0}
    [data-theme="light"] .pairN{background:rgba(0,122,255,.08)}
    .pairN .pn{font-size:20px;font-weight:800;color:var(--blue)}
    .pairN .pt{font-size:9px;color:var(--t3);font-weight:600;margin-top:1px}
    .lBody{flex:1;min-width:0}
    .lName{font-size:16px;font-weight:700;margin-bottom:3px}
    .lMeta{display:flex;gap:10px;font-size:13px;color:var(--t2);flex-wrap:wrap}
    .lEmpty{color:var(--t3);font-size:14px}
    .lActions{position:absolute;top:10px;right:10px;display:flex;gap:4px}
    .miniBtn{padding:4px 8px;border-radius:6px;border:none;font-size:11px;font-weight:700;font-family:inherit;cursor:pointer;transition:opacity .15s}
    .miniBtn:active{opacity:.6}
    .miniBtn.bl{background:rgba(10,132,255,.15);color:var(--blue)}
    .miniBtn.gr{background:rgba(48,209,88,.15);color:var(--green)}
    .miniBtn.rd{background:rgba(255,69,58,.15);color:var(--red)}
    .miniBtn.og{background:rgba(255,159,10,.15);color:var(--orange)}

    /* HW INLINE */
    .hwInline{margin-top:8px;padding:10px 12px;background:rgba(10,132,255,.06);border-radius:var(--rs);border-left:3px solid var(--blue)}
    [data-theme="light"] .hwInline{background:rgba(0,122,255,.04)}
    .hwInline.done{opacity:.4}
    .hwInline .hwHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
    .hwInline .hwTag{font-size:10px;font-weight:700;text-transform:uppercase;color:var(--blue);letter-spacing:.3px}
    .hwInline .hwTxt{font-size:14px;line-height:1.5}
    .hwInline.done .hwTxt{text-decoration:line-through}
    .hwInline .hwBtns{display:flex;gap:3px}
    .hwInline .hwPhotos{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
    .hwInline .hwPhotos img{width:60px;height:60px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid var(--t4)}

    /* PAGE HEADS */
    .pgHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:8px;flex-wrap:wrap}
    .pgHead h2{font-size:22px;font-weight:700}
    .emptyBox{text-align:center;padding:60px 20px;color:var(--t3)}
    .emptyBox .eIcon{font-size:48px;margin-bottom:8px;opacity:.5}
    .emptyBox .eTxt{font-size:15px}

    /* HW CARDS */
    .hwCard{background:var(--card);border-radius:var(--r);padding:16px;border:1px solid var(--t4);border-left:3px solid var(--blue);margin-bottom:10px}
    .hwCard .hwSubj{font-size:15px;font-weight:700;color:var(--blue);margin-bottom:4px}
    .hwCard .hwDue{font-size:12px;color:var(--t3);margin-bottom:10px}
    .hwCard .hwTask{font-size:14px;line-height:1.6;padding:10px;background:var(--bg2);border-radius:var(--rs);margin-bottom:10px}
    .hwCard .hwActs{display:flex;gap:6px}
    .hwCard .hwPhotos{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
    .hwCard .hwPhotos img{width:80px;height:80px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid var(--t4)}

    /* EVENTS CARDS */
    .evCard{background:var(--card);border-radius:var(--r);padding:16px;border:1px solid var(--t4);border-left:3px solid var(--purple);margin-bottom:10px}
    .evCard .evTitle{font-size:15px;font-weight:700;color:var(--purple);margin-bottom:4px}
    .evCard .evDate{font-size:12px;color:var(--t3);margin-bottom:6px}
    .evCard .evDesc{font-size:14px;line-height:1.5;color:var(--t2)}

    /* GRADES */
    .gradeTabs{display:flex;gap:4px;margin-bottom:16px;background:var(--bg2);border-radius:var(--rs);padding:3px}
    .gradeTab{flex:1;padding:10px;border:none;border-radius:8px;background:transparent;color:var(--t3);font-size:13px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .2s;text-align:center}
    .gradeTab.on{background:var(--blue);color:#fff}
    .gradeTab:active{opacity:.7}
    .gradeContent{display:none}
    .gradeContent.on{display:block;animation:fadeUp .2s ease}

    /* SUBJECTS/CHANGES/SETTINGS */
    .sjRow{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--card);border-radius:var(--r);border:1px solid var(--t4);margin-bottom:8px}
    .sjRow .sjIcon{width:40px;height:40px;border-radius:var(--rs);background:rgba(10,132,255,.1);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
    .sjRow .sjInfo{flex:1;min-width:0}
    .sjRow .sjN{font-weight:700;font-size:15px}
    .sjRow .sjM{font-size:13px;color:var(--t2)}
    .chgCard{background:var(--card);border-radius:var(--r);padding:16px;border:1px solid var(--t4);border-left:3px solid var(--orange);margin-bottom:10px}
    .chgCard .chHead{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:6px}
    .chgCard .chDate{font-weight:700;color:var(--orange)}
    .chgLesson{display:flex;gap:8px;align-items:center;padding:8px;background:var(--bg2);border-radius:var(--rs);margin-bottom:4px}
    .chgLesson .clN{width:24px;height:24px;border-radius:6px;background:rgba(255,159,10,.15);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:var(--orange);flex-shrink:0}
    .setRow{display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--card);border-radius:var(--r);border:1px solid var(--t4);margin-bottom:8px;gap:12px;flex-wrap:wrap}
    .setRow h4{font-size:15px;font-weight:700}
    .setRow p{font-size:13px;color:var(--t3)}

    /* BOTTOM NAV */
    .bnav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--navH) + env(safe-area-inset-bottom));padding-bottom:env(safe-area-inset-bottom);background:var(--bg2);border-top:1px solid var(--t4);display:flex;z-index:100}
    [data-theme="light"] .bnav{background:rgba(255,255,255,.92);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
    .bnavBtn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;border:none;background:none;color:var(--t3);font-size:10px;font-weight:600;font-family:inherit;cursor:pointer;transition:color .15s;padding:0;position:relative}
    .bnavBtn .bi{font-size:24px;transition:transform .12s}
    .bnavBtn:active .bi{transform:scale(.85)}
    .bnavBtn.on{color:var(--blue)}
    .bnavBtn .badge{position:absolute;top:6px;left:calc(50% + 6px);min-width:16px;height:16px;border-radius:8px;background:var(--red);color:#fff;font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;padding:0 4px}

    /* SIDEBAR (slide-in menu) */
    .sideOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:none;opacity:0;transition:opacity .3s}
    .sideOverlay.open{display:block;opacity:1}
    [data-theme="light"] .sideOverlay{background:rgba(0,0,0,.3)}
    .sidebar{position:fixed;top:0;right:-300px;bottom:0;width:280px;max-width:85vw;background:var(--bg2);z-index:201;transition:right .35s cubic-bezier(.32,.72,0,1);padding:0;display:flex;flex-direction:column;box-shadow:-4px 0 30px rgba(0,0,0,.3)}
    .sidebar.open{right:0}
    .sideHead{padding:20px;padding-top:calc(20px + env(safe-area-inset-top));border-bottom:1px solid var(--t4)}
    .sideHead .shName{font-size:18px;font-weight:700;margin-bottom:2px}
    .sideHead .shEmail{font-size:13px;color:var(--t3)}
    .sideHead .shBadge{display:inline-block;background:var(--blue);color:#fff;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:800;margin-top:4px}
    .sideItems{flex:1;overflow-y:auto;padding:8px 0}
    .sideItem{display:flex;align-items:center;gap:12px;padding:14px 20px;font-size:16px;font-weight:600;color:var(--text);cursor:pointer;transition:background .15s;border:none;background:none;width:100%;text-align:left;font-family:inherit}
    .sideItem:active{background:var(--bg3)}
    .sideItem .siIcon{font-size:20px;width:28px;text-align:center}
    .sideItem.red{color:var(--red)}
    .sideFoot{padding:16px 20px;padding-bottom:calc(16px + env(safe-area-inset-bottom));border-top:1px solid var(--t4);font-size:12px;color:var(--t3);text-align:center}

    /* SHEETS */
    .sheet{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:none;align-items:flex-end;justify-content:center}
    [data-theme="light"] .sheet{background:rgba(0,0,0,.3)}
    .sheet.open{display:flex}
    .sheetBox{background:var(--bg2);width:100%;max-width:500px;border-radius:20px 20px 0 0;padding:0 20px calc(20px + env(safe-area-inset-bottom));max-height:90vh;overflow-y:auto;animation:shUp .3s cubic-bezier(.32,.72,0,1)}
    @keyframes shUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .shHandle{width:36px;height:4px;background:var(--t4);border-radius:2px;margin:10px auto 16px}
    .sheetBox h3{font-size:20px;font-weight:700;margin-bottom:16px}
    .shBtns{display:flex;gap:8px;margin-top:20px;padding-bottom:8px}
    .shBtns .btnP,.shBtns .btnS,.shBtns .btnD{flex:1;padding:14px;font-size:15px}

    /* Custom select */
    .csTrig{display:flex;align-items:center;gap:10px;padding:14px 16px;background:var(--bg3);border:1px solid var(--t4);border-radius:var(--r);cursor:pointer;min-height:52px;transition:border-color .2s}
    .csTrig:active{opacity:.8}
    .csTrig.open{border-color:var(--blue);border-radius:var(--r) var(--r) 0 0}
    .csTrig .csI{width:32px;height:32px;border-radius:8px;background:rgba(10,132,255,.1);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
    .csTrig .csTxt{flex:1}
    .csTrig .csN{font-weight:700;font-size:14px}
    .csTrig .csM{font-size:12px;color:var(--t3)}
    .csTrig .csPh{color:var(--t3);font-size:14px}
    .csTrig .csArr{color:var(--t3);font-size:10px;transition:transform .2s}
    .csTrig.open .csArr{transform:rotate(180deg)}
    .csDd{position:absolute;top:100%;left:0;right:0;background:var(--bg2);border:1px solid var(--blue);border-top:1px solid var(--t4);border-radius:0 0 var(--r) var(--r);max-height:200px;overflow-y:auto;z-index:50;display:none;box-shadow:0 12px 40px rgba(0,0,0,.3)}
    .csDd.open{display:block}
    .csOpt{display:flex;align-items:center;gap:10px;padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--t4);transition:background .1s}
    .csOpt:last-child{border:none}
    .csOpt:active{background:var(--bg3)}
    .csOpt.on{background:rgba(10,132,255,.08)}
    .csOpt .coI{width:28px;height:28px;border-radius:7px;background:rgba(10,132,255,.1);display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0}
    .csOpt .coN{font-weight:700;font-size:14px}
    .csOpt .coM{font-size:11px;color:var(--t3)}
    .csOpt.emp .coI{background:rgba(255,69,58,.1)}
    .csWrap{position:relative;width:100%}
    .cpBlk{background:var(--bg3);border-radius:var(--rs);padding:12px;margin-bottom:8px}
    .cpBlk .cpHead{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .cpBlk .cpN{width:24px;height:24px;border-radius:6px;background:rgba(10,132,255,.1);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;color:var(--blue)}

    /* Photo upload */
    .photoUploadArea{margin-top:8px}
    .photoUploadBtn{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;background:var(--bg3);border:1px dashed var(--t4);border-radius:var(--rs);color:var(--t2);font-size:14px;font-weight:600;cursor:pointer;transition:border-color .2s}
    .photoUploadBtn:active{opacity:.7}
    .photoPreview{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
    .photoPreview .ppItem{position:relative;width:72px;height:72px}
    .photoPreview .ppItem img{width:100%;height:100%;object-fit:cover;border-radius:8px;border:1px solid var(--t4)}
    .photoPreview .ppRm{position:absolute;top:-4px;right:-4px;width:20px;height:20px;border-radius:50%;background:var(--red);color:#fff;border:none;font-size:12px;font-weight:800;display:flex;align-items:center;justify-content:center;cursor:pointer}

    /* Image viewer */
    .imgViewer{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:600;display:none;align-items:center;justify-content:center;cursor:pointer}
    .imgViewer.open{display:flex}
    .imgViewer img{max-width:95%;max-height:90vh;border-radius:8px;object-fit:contain}

    /* FUTURE placeholder */
    .futurePlaceholder{text-align:center;padding:60px 20px}
    .futurePlaceholder .fpIcon{font-size:56px;margin-bottom:12px}
    .futurePlaceholder h3{font-size:20px;font-weight:700;margin-bottom:8px}
    .futurePlaceholder p{font-size:14px;color:var(--t3);line-height:1.6;max-width:280px;margin:0 auto}

    .admH{display:none !important}
    @media(max-width:380px){.topTitle{font-size:24px}.dayChip .dcN{font-size:16px}}
  </style>
</head>
<body>

<div id="loginPage">
  <div class="loginCard">
    <div class="logo">üìì</div>
    <h1>–î–Ω–µ–≤–Ω–∏–∫</h1>
    <p class="sub">–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</p>
    <div class="errMsg" id="errMsg"></div>
    <input class="inp" type="email" id="iEmail" placeholder="Email" autocomplete="email">
    <input class="inp" type="password" id="iPass" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
    <button class="btnP" onclick="doLogin()">–í–æ–π—Ç–∏</button>
    <div class="divLine">–∏–ª–∏</div>
    <button class="btnS" onclick="guestIn()">–ì–æ—Å—Ç–µ–≤–æ–π –≤—Ö–æ–¥</button>
  </div>
</div>

<div id="appPage">
  <div class="top">
    <div class="topRow">
      <div class="topLeft">
        <div class="topTitle">üìì –î–Ω–µ–≤–Ω–∏–∫</div>
      </div>
      <div class="topRight">
        <span class="pillBadge" id="topBadge"></span>
        <button class="circBtn" onclick="openSidebar()">‚ò∞</button>
      </div>
    </div>
    <div class="topDate" id="topDate"></div>
  </div>

  <div class="weekBar" id="weekBar">
    <div class="weekRow" id="weekRow"></div>
    <div class="weekLabel" id="weekLabel"></div>
  </div>

  <div class="content">
    <div class="pg on" id="pgSched"><div class="lList" id="lList"></div></div>

    <div class="pg" id="pgEvents">
      <div class="pgHead"><h2>–°–æ–±—ã—Ç–∏—è</h2></div>
      <div id="eventsList"></div>
    </div>

    <div class="pg" id="pgGrades">
      <div class="pgHead"><h2>–û—Ü–µ–Ω–∫–∏</h2></div>
      <div class="gradeTabs">
        <button class="gradeTab on" onclick="switchGradeTab(0)">–ñ—É—Ä–Ω–∞–ª</button>
        <button class="gradeTab" onclick="switchGradeTab(1)">–ó–∞—á—ë—Ç–∫–∞</button>
      </div>
      <div class="gradeContent on" id="gradeJournal">
        <div class="futurePlaceholder">
          <div class="fpIcon">üìä</div>
          <h3>–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫</h3>
          <p>–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–∞—à–∏ –æ—Ü–µ–Ω–∫–∏ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º. –§—É–Ω–∫—Ü–∏—è –ø–æ—è–≤–∏—Ç—Å—è –≤ –±–ª–∏–∂–∞–π—à–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏.</p>
        </div>
      </div>
      <div class="gradeContent" id="gradeRecord">
        <div class="futurePlaceholder">
          <div class="fpIcon">üìã</div>
          <h3>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –∑–∞—á—ë—Ç–∫–∞</h3>
          <p>–ó–∞—á—ë—Ç—ã, —ç–∫–∑–∞–º–µ–Ω—ã, –∫—É—Ä—Å–æ–≤—ã–µ ‚Äî –≤—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–π —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ –±—É–¥–µ—Ç –∑–¥–µ—Å—å. –°–∫–æ—Ä–æ!</p>
        </div>
      </div>
    </div>

    <div class="pg" id="pgHw">
      <div class="pgHead">
        <h2>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
        <button class="btnP admH" id="addHwBtn" onclick="openNewHw()" style="padding:10px 16px;font-size:14px;width:auto">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div id="hwList"></div>
    </div>

    <div class="pg" id="pgChat">
      <div class="futurePlaceholder">
        <div class="fpIcon">üí¨</div>
        <h3>–ß–∞—Ç –≥—Ä—É–ø–ø—ã</h3>
        <p>–û–±—â–∞–π—Ç–µ—Å—å —Å –æ–¥–Ω–æ–≥—Ä—É–ø–ø–Ω–∏–∫–∞–º–∏ –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º–∏ –ø—Ä—è–º–æ –≤ –¥–Ω–µ–≤–Ω–∏–∫–µ. –§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
      </div>
    </div>

    <div class="pg admH" id="pgChg">
      <div class="pgHead"><h2>–ó–∞–º–µ–Ω—ã</h2><button class="btnP" onclick="openChgM()" style="padding:10px 16px;font-size:14px;width:auto">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
      <div id="chgList"></div>
    </div>

    <div class="pg admH" id="pgSubj">
      <div class="pgHead"><h2>–ü—Ä–µ–¥–º–µ—Ç—ã</h2><button class="btnP" onclick="openSjM()" style="padding:10px 16px;font-size:14px;width:auto">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
      <div id="sjList"></div>
    </div>

    <div class="pg" id="pgSet">
      <h2 style="margin-bottom:16px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <div class="setRow"><div><h4>–¢–µ–º–∞</h4><p>–°–≤–µ—Ç–ª–∞—è / —Ç—ë–º–Ω–∞—è</p></div><button class="btnS" onclick="togTheme()" style="width:auto;padding:10px 16px;font-size:14px">–°–º–µ–Ω–∏—Ç—å</button></div>
      <div class="setRow admH"><div><h4>–ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª—å</h4><p>–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤–µ—Ä—Ö–Ω–µ–π</p></div><input type="date" class="inp" id="cfgWS" style="width:auto;margin:0;padding:10px"></div>
      <div class="setRow admH"><div><h4>–í—Ä–µ–º—è –ø–∞—Ä</h4></div><button class="btnS" onclick="openTimesM()" style="width:auto;padding:10px 16px;font-size:14px">–ò–∑–º–µ–Ω–∏—Ç—å</button></div>
      <div class="setRow admH"><div><h4>–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</h4></div><button class="btnD" onclick="clearAll()" style="width:auto;padding:10px 16px;font-size:14px">–û—á–∏—Å—Ç–∏—Ç—å</button></div>
    </div>
  </div>

  <!-- Bottom nav: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –°–æ–±—ã—Ç–∏—è, –û—Ü–µ–Ω–∫–∏ -->
  <nav class="bnav">
    <button class="bnavBtn on" data-pg="pgSched"><span class="bi">üìÖ</span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
    <button class="bnavBtn" data-pg="pgEvents"><span class="bi">üìå</span>–°–æ–±—ã—Ç–∏—è</button>
    <button class="bnavBtn" data-pg="pgGrades"><span class="bi">üìä</span>–û—Ü–µ–Ω–∫–∏</button>
  </nav>
</div>

<!-- SIDEBAR -->
<div class="sideOverlay" id="sideOverlay" onclick="closeSidebar()"></div>
<div class="sidebar" id="sidebar">
  <div class="sideHead">
    <div class="shName" id="shName">–ì–æ—Å—Ç—å</div>
    <div class="shEmail" id="shEmail"></div>
    <div class="shBadge admH" id="shBadge">–ê–¥–º–∏–Ω</div>
  </div>
  <div class="sideItems">
    <button class="sideItem" onclick="goPage('pgHw');closeSidebar()"><span class="siIcon">üìù</span>–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</button>
    <button class="sideItem" onclick="goPage('pgGrades');closeSidebar()"><span class="siIcon">üìä</span>–û—Ü–µ–Ω–∫–∏</button>
    <button class="sideItem" onclick="goPage('pgChat');closeSidebar()"><span class="siIcon">üí¨</span>–ß–∞—Ç</button>
    <button class="sideItem admH" onclick="goPage('pgChg');closeSidebar()"><span class="siIcon">üîÑ</span>–ó–∞–º–µ–Ω—ã</button>
    <button class="sideItem admH" onclick="goPage('pgSubj');closeSidebar()"><span class="siIcon">üìñ</span>–ü—Ä–µ–¥–º–µ—Ç—ã</button>
    <button class="sideItem" onclick="goPage('pgSet');closeSidebar()"><span class="siIcon">‚öôÔ∏è</span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button class="sideItem red" onclick="doLogout()"><span class="siIcon">üö™</span>–í—ã–π—Ç–∏</button>
  </div>
  <div class="sideFoot">–í–µ—Ä—Å–∏—è 2.0</div>
</div>

<!-- IMAGE VIEWER -->
<div class="imgViewer" id="imgViewer" onclick="this.classList.remove('open')"><img id="imgViewerSrc"></div>

<!-- SHEETS -->
<div class="sheet" id="shLesson"><div class="sheetBox"><div class="shHandle"></div><h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—É</h3><input type="hidden" id="elD"><input type="hidden" id="elP"><input type="hidden" id="elW"><div style="margin-bottom:12px"><label style="display:block;font-size:13px;font-weight:600;color:var(--t2);margin-bottom:6px">–ü—Ä–µ–¥–º–µ—Ç</label><div id="elSel"></div></div><div class="shBtns"><button class="btnS" onclick="closeS('shLesson')">–û—Ç–º–µ–Ω–∞</button><button class="btnD" onclick="rmLesson()">–£–±—Ä–∞—Ç—å</button><button class="btnP" onclick="svLesson()">–û–∫</button></div></div></div>

<div class="sheet" id="shHwI"><div class="sheetBox"><div class="shHandle"></div><h3>–î–æ–º–∞—à–∫–∞</h3><input type="hidden" id="hiD"><input type="hidden" id="hiP"><div style="margin-bottom:12px"><label style="display:block;font-size:13px;font-weight:600;color:var(--t2);margin-bottom:6px">–ü—Ä–µ–¥–º–µ—Ç</label><input class="inp" id="hiS" readonly style="opacity:.5;margin:0"></div><div style="margin-bottom:12px"><label style="display:block;font-size:13px;font-weight:600;color:var(--t2);margin-bottom:6px">–ó–∞–¥–∞–Ω–∏–µ</label><textarea class="inp" id="hiT" placeholder="–ß—Ç–æ –∑–∞–¥–∞–ª–∏..." style="margin:0"></textarea></div><div style="margin-bottom:0"><label style="display:block;font-size:13px;font-weight:600;color:var(--t2);margin-bottom:6px">–§–æ—Ç–æ</label><div class="photoUploadArea"><label class="photoUploadBtn"><input type="file" accept="image/*" multiple hidden onchange="addPhotos(this,'hiPhotos')">üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</label><div class="photoPreview" id="hiPhotos"></div></div></div><div class="shBtns"><button class="btnS" onclick="closeS('shHwI')">–û—Ç–º–µ–Ω–∞</button><button class="btnP" onclick="svHwI()">–û–∫</button></div></div></div>

<div class="sheet" id="shNewHw"><div class="sheetBox"><div class="shHandle"></div><h3>–ù–æ–≤–æ–µ –î–ó</h3><div style="margin-bottom:12px"><label style="display:block;font-size:13px;font-weight:600;color:var(--t2);margin-bottom:6px">–ü—Ä–µ–¥–º–µ—Ç</label><div id="nhSel"></div></div><div style="margin-bottom:12px"><label style="display:block;font-size:13px;font-weight:600;color:var(--t2);margin-bottom:6px">–ó–∞–¥–∞–Ω–∏–µ</label><textarea class="inp" id="nhT" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." style="margin:0"></textarea></div><div style="margin-bottom:12px"><label style="display:block;font-size:13px;font-weight:600;color:var(--t2);margin-bottom:6px">–§–æ—Ç–æ</label><div class="photoUploadArea"><label class="photoUploadBtn"><input type="file" accept="image/*" multiple hidden onchange="addPhotos(this,'nhPhotos')">üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</label><div class="photoPreview" id="nhPhotos"></div></div></div><div style="margin-bottom:0"><label style="display:block;font-size:13px;font-weight:600;color:var(--t2);margin-bottom:6px">–ë–ª–∏–∂–∞–π—à–∞—è –ø–∞—Ä–∞</label><div id="nhNext" style="padding:14px;background:var(--bg3);border-radius:var(--rs);font-size:14px;color:var(--t3)">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</div></div><div class="shBtns"><button class="btnS" onclick="closeS('shNewHw')">–û—Ç–º–µ–Ω–∞</button><button class="btnP" onclick="svNewHw()">–û–∫</button></div></div></div>

<div class="sheet" id="shSubj"><div class="sheetBox"><div class="shHandle"></div><h3 id="sjTitle">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</h3><input type="hidden" id="sjId"><input class="inp" id="sjN" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><input class="inp" id="sjR" placeholder="–ê—É–¥–∏—Ç–æ—Ä–∏—è"><input class="inp" id="sjTch" placeholder="–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å"><div class="shBtns"><button class="btnS" onclick="closeS('shSubj')">–û—Ç–º–µ–Ω–∞</button><button class="btnP" onclick="svSubj()">–û–∫</button></div></div></div>

<div class="sheet" id="shChg"><div class="sheetBox"><div class="shHandle"></div><h3>–ó–∞–º–µ–Ω–∞</h3><input type="hidden" id="ceId"><input class="inp" type="date" id="ceDate" style="margin-bottom:8px"><p style="font-size:13px;color:var(--t3);margin-bottom:12px">–ó–∞–º–µ–Ω–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É</p><div id="cePairs"></div><div class="shBtns"><button class="btnS" onclick="closeS('shChg')">–û—Ç–º–µ–Ω–∞</button><button class="btnD" id="ceDel" onclick="rmChg()" style="display:none">–£–¥–∞–ª–∏—Ç—å</button><button class="btnP" onclick="svChg()">–û–∫</button></div></div></div>

<div class="sheet" id="shTimes"><div class="sheetBox"><div class="shHandle"></div><h3>–í—Ä–µ–º—è –ø–∞—Ä</h3><div id="timesF"></div><div class="shBtns"><button class="btnS" onclick="closeS('shTimes')">–û—Ç–º–µ–Ω–∞</button><button class="btnP" onclick="svTimes()">–û–∫</button></div></div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
function initTh(){setTh(localStorage.getItem('th')||(matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light'))}
function setTh(t){document.documentElement.setAttribute('data-theme',t);localStorage.setItem('th',t);document.querySelector('meta[name="theme-color"]').content=t==='dark'?'#000':'#f2f2f7'}
function togTheme(){setTh(document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark')}
initTh();

firebase.initializeApp({apiKey:"AIzaSyBCy0hz_PHMGUX2M52Wnwb0C9nEnBBfeq8",authDomain:"my-diary-e223c.firebaseapp.com",databaseURL:"https://my-diary-e223c-default-rtdb.firebaseio.com",projectId:"my-diary-e223c",storageBucket:"my-diary-e223c.firebasestorage.app",messagingSenderId:"903986378920",appId:"1:903986378920:web:b6ebc6691f6d767f78aa9d"});
const au=firebase.auth(),db=firebase.database();
au.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

const ADM=["zFKU6TAgIuhZetCOuWpHvDDw6Oj2"];
const DK=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'],DL=['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
let cU=null,isA=false,isG=false;
let sc={upper:{},lower:{}},hw=[],ch=[],nh=[],sj=[];
let cf={weekStartDate:null,pairTimes:[{start:'08:30',end:'10:00'},{start:'10:10',end:'11:40'},{start:'12:10',end:'13:40'},{start:'13:50',end:'15:20'},{start:'15:30',end:'17:00'}]};
let vM=gMon(new Date()),sD=tIdx(),csS={},uploadedPhotos={hiPhotos:[],nhPhotos:[]};

function gMon(d){const r=new Date(d);r.setHours(12,0,0,0);const w=r.getDay();r.setDate(r.getDate()-w+(w===0?-6:1));return r}
function fk(d){const r=new Date(d);return`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,'0')}-${String(r.getDate()).padStart(2,'0')}`}
function pk(s){const[y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d,12)}
function fShort(d){return new Date(d).toLocaleDateString('ru-RU',{day:'numeric',month:'short'})}
function fFull(d){return new Date(d).toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'})}
function tIdx(){const w=new Date().getDay();return w===0?5:(w-1)}
function esc(t){if(!t)return'';const d=document.createElement('div');d.textContent=t;return d.innerHTML}

function gwt(m){
  if(!cf.weekStartDate){const s=new Date(m.getFullYear(),0,1);return Math.ceil(((m-s)/864e5+s.getDay()+1)/7)%2===1?'upper':'lower'}
  const sd=gMon(pk(cf.weekStartDate));return Math.floor(Math.round((m-sd)/864e5)/7)%2===0?'upper':'lower';
}

function lesFor(dk){
  const d=pk(dk),dow=d.getDay();if(dow===0)return{};
  const di=dow-1;if(di>5)return{};
  const c=ch.find(x=>x.date===dk);if(c)return c.lessons||{};
  return(sc[gwt(gMon(d))]||{})[DK[di]]||{};
}

function findNx(subj){
  const td=new Date();td.setHours(0,0,0,0);
  for(let o=1;o<=60;o++){const d=new Date(td);d.setDate(d.getDate()+o);const dow=d.getDay();if(dow===0||dow>6)continue;const dk=fk(d),ls=lesFor(dk);for(let p=1;p<=5;p++){const l=ls[p];if(l&&l.name&&l.name.toLowerCase().trim()===subj.toLowerCase().trim())return{date:dk,pair:p}}}
  return null;
}

function recalc(){if(!isA)return;nh.forEach(h=>{if(h.done||!h.subject)return;const n=findNx(h.subject);if(n&&(n.date!==h.targetDate||n.pair!==h.targetPair))db.ref(`newHomework/${h.id}`).update({targetDate:n.date,targetPair:n.pair})})}

/* AUTH */
au.onAuthStateChanged(u=>{if(u){cU=u;isA=ADM.includes(u.uid);isG=false;boot()}else if(localStorage.getItem('gs')){isG=true;boot()}});
function doLogin(){const e=document.getElementById('iEmail').value.trim(),p=document.getElementById('iPass').value;if(!e||!p){shErr('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');return}au.signInWithEmailAndPassword(e,p).catch(()=>shErr('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'))}
function shErr(m){const e=document.getElementById('errMsg');e.textContent=m;e.style.display='block'}
function guestIn(){isG=true;isA=false;cU=null;localStorage.setItem('gs','1');boot()}
function doLogout(){localStorage.removeItem('gs');closeSidebar();au.signOut().then(()=>{isG=false;isA=false;cU=null;document.getElementById('appPage').style.display='none';document.getElementById('loginPage').style.display='flex'})}

function boot(){
  document.getElementById('loginPage').style.display='none';
  document.getElementById('appPage').style.display='block';
  document.getElementById('shName').textContent=isG?'–ì–æ—Å—Ç—å':(cU?.email?.split('@')[0]||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
  document.getElementById('shEmail').textContent=isG?'–ì–æ—Å—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø':(cU?.email||'');
  if(isA)document.querySelectorAll('.admH').forEach(e=>e.classList.remove('admH'));
  setupNav();loadData();sD=tIdx();vM=gMon(new Date());updAll();
}

/* SIDEBAR */
function openSidebar(){document.getElementById('sideOverlay').classList.add('open');document.getElementById('sidebar').classList.add('open')}
function closeSidebar(){document.getElementById('sideOverlay').classList.remove('open');document.getElementById('sidebar').classList.remove('open')}

/* NAV */
function setupNav(){
  document.querySelectorAll('.bnavBtn').forEach(b=>{b.addEventListener('click',()=>{goPage(b.dataset.pg);document.querySelectorAll('.bnavBtn').forEach(x=>x.classList.remove('on'));b.classList.add('on')})});
}

function goPage(id){
  document.querySelectorAll('.pg').forEach(x=>x.classList.remove('on'));
  document.getElementById(id).classList.add('on');
  const isSch=id==='pgSched';
  document.getElementById('weekBar').style.display=isSch?'':'none';
  // update bottom nav highlight
  document.querySelectorAll('.bnavBtn').forEach(b=>{b.classList.toggle('on',b.dataset.pg===id)});
}

/* GRADES TABS */
function switchGradeTab(i){
  document.querySelectorAll('.gradeTab').forEach((t,idx)=>t.classList.toggle('on',idx===i));
  document.querySelectorAll('.gradeContent').forEach((c,idx)=>c.classList.toggle('on',idx===i));
}

/* DATA */
function loadData(){
  db.ref('settings').on('value',s=>{if(s.val()){cf={...cf,...s.val()};const wsi=document.getElementById('cfgWS');if(cf.weekStartDate&&wsi)wsi.value=cf.weekStartDate}updAll()});
  db.ref('schedule').on('value',s=>{sc=s.val()||{upper:{},lower:{}};render();recalc()});
  db.ref('homework').on('value',s=>{const d=s.val();hw=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];render()});
  db.ref('subjects').on('value',s=>{const d=s.val();sj=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];rSubj();render()});
  db.ref('newHomework').on('value',s=>{const d=s.val();nh=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];rHwPg();render();rEvents()});
  db.ref('changes').on('value',s=>{const d=s.val();ch=d?Object.keys(d).map(k=>({id:k,...d[k]})):[];cleanOld();render();rStrip();rChg();rEvents();recalc()});
  const wsi=document.getElementById('cfgWS');if(wsi)wsi.addEventListener('change',e=>{if(isA)db.ref('settings/weekStartDate').set(e.target.value)});
}

function cleanOld(){if(!isA)return;const tk=fk(new Date());ch.forEach(c=>{if(c.date<tk)db.ref(`changes/${c.id}`).remove()})}
function updAll(){updTop();rStrip();render();rEvents()}

function updTop(){
  const t=new Date(),wt=gwt(gMon(t));
  document.getElementById('topDate').textContent=fFull(t);
  const b=document.getElementById('topBadge');
  b.textContent=wt==='upper'?'‚ñ≤ –í–µ—Ä—Ö–Ω—è—è':'‚ñº –ù–∏–∂–Ω—è—è';
  b.className='pillBadge '+(wt==='upper'?'up':'lo');
}

function prevW(){vM.setDate(vM.getDate()-7);sD=0;updAll()}
function nextW(){vM.setDate(vM.getDate()+7);sD=0;updAll()}

function rStrip(){
  const wr=document.getElementById('weekRow'),wl=document.getElementById('weekLabel'),tk=fk(new Date());
  const e=new Date(vM);e.setDate(e.getDate()+5);
  const wt=gwt(vM);
  let h=`<button class="wArrow" onclick="prevW()">‚Äπ</button>`;
  for(let i=0;i<6;i++){
    const d=new Date(vM);d.setDate(d.getDate()+i);
    const dk=fk(d),isT=dk===tk,hasCh=ch.some(x=>x.date===dk);
    h+=`<button class="dayChip${i===sD?' sel':''}${isT?' today':''}" onclick="pickD(${i})">
      ${hasCh?'<span class="dcDot"></span>':''}
      <span class="dcD">${DK[i]}</span>
      <span class="dcN">${d.getDate()}</span>
    </button>`;
  }
  h+=`<button class="wArrow" onclick="nextW()">‚Ä∫</button>`;
  wr.innerHTML=h;
  wl.innerHTML=`${fShort(vM)} ‚Äî ${fShort(e)} ¬∑ <span class="${wt==='upper'?'up':'lo'}">${wt==='upper'?'‚ñ≤ –í–µ—Ä—Ö–Ω—è—è':'‚ñº –ù–∏–∂–Ω—è—è'}</span>`;
}

function pickD(i){sD=i;rStrip();render()}

/* EVENTS */
function rEvents(){
  const c=document.getElementById('eventsList'),tk=fk(new Date());
  let items=[];
  // upcoming HW
  nh.filter(h=>h.targetDate&&h.targetDate>=tk&&!h.done).forEach(h=>{
    items.push({date:h.targetDate,type:'hw',icon:'üìù',title:h.subject,desc:h.task,color:'var(--blue)'});
  });
  // changes
  ch.filter(x=>x.date>=tk).forEach(x=>{
    items.push({date:x.date,type:'chg',icon:'üîÑ',title:'–ó–∞–º–µ–Ω–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è',desc:fFull(pk(x.date)),color:'var(--orange)'});
  });
  items.sort((a,b)=>a.date.localeCompare(b.date));
  if(!items.length){c.innerHTML='<div class="emptyBox"><div class="eIcon">üìå</div><div class="eTxt">–ù–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö —Å–æ–±—ã—Ç–∏–π</div></div>';return}
  c.innerHTML=items.slice(0,20).map(ev=>`<div class="evCard" style="border-left-color:${ev.color}">
    <div class="evTitle">${ev.icon} ${esc(ev.title)}</div>
    <div class="evDate">üìÖ ${fFull(pk(ev.date))}</div>
    <div class="evDesc">${esc(ev.desc)}</div>
  </div>`).join('');
}

/* RENDER LESSONS */
function render(){
  const w=document.getElementById('lList');
  const d=new Date(vM);d.setDate(d.getDate()+sD);
  const dk=fk(d),wt=gwt(vM),dayK=DK[sD];
  const cx=ch.find(x=>x.date===dk),hasCh=!!cx;
  const les=hasCh?(cx.lessons||{}):(sc[wt]?.[dayK]||{});
  let h='';
  for(let p=1;p<=5;p++){
    const l=les[p],has=l&&l.name,tm=cf.pairTimes[p-1];
    const iho=hw.filter(x=>x.date===dk&&x.pair===p);
    const ihn=nh.filter(x=>x.targetDate===dk&&x.targetPair===p);
    h+=`<div class="lCard${has?'':' empty'}${hasCh&&has?' changed':''}" ${isA?`onclick="openLM('${dayK}',${p},'${wt}')"`:''}>
      <div class="pairN"><span class="pn">${p}</span><span class="pt">${tm?.start||''}</span></div>
      <div class="lBody">
        ${has?`<div class="lName">${esc(l.name)}</div><div class="lMeta">${l.room?`<span>üìç ${esc(l.room)}</span>`:''}${l.teacher?`<span>üë§ ${esc(l.teacher)}</span>`:''}</div>${rIHw(iho,'–î–æ–º–∞—à–∫–∞','hw')}${rIHw(ihn,'–î–ó','nh')}`:`<div class="lEmpty">${isA?'–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å':'‚Äî'}</div>`}
      </div>
      ${has&&isA?`<div class="lActions"><button class="miniBtn bl" onclick="event.stopPropagation();openHwI('${dk}',${p},'${esc(l.name)}')">+–î–ó</button></div>`:''}
    </div>`;
  }
  w.innerHTML=h;
}

function rIHw(list,lbl,tp){
  if(!list.length)return'';
  return list.map(h=>{
    let photos='';
    if(h.photos&&h.photos.length){
      photos='<div class="hwPhotos">'+h.photos.map(p=>`<img src="${p}" onclick="event.stopPropagation();viewImg('${p}')">`).join('')+'</div>';
    }
    return`<div class="hwInline${h.done?' done':''}">
      <div class="hwHead"><span class="hwTag">${lbl}</span><div class="hwBtns"><button class="miniBtn ${h.done?'og':'gr'}" onclick="event.stopPropagation();${tp==='hw'?`tHw('${h.id}')`:`tNH('${h.id}')`}">${h.done?'‚Ü©':'‚úì'}</button>${isA?`<button class="miniBtn rd" onclick="event.stopPropagation();${tp==='hw'?`dHw('${h.id}')`:`dNH('${h.id}')`}">‚úï</button>`:''}</div></div>
      <div class="hwTxt">${esc(h.task)}</div>
      ${photos}
    </div>`;
  }).join('');
}

/* VIEW IMAGE */
function viewImg(src){document.getElementById('imgViewerSrc').src=src;document.getElementById('imgViewer').classList.add('open')}

/* HW PAGE */
function rHwPg(){
  const c=document.getElementById('hwList'),tk=fk(new Date());
  const p=nh.filter(h=>h.targetDate&&h.targetDate>=tk&&!h.done).sort((a,b)=>a.targetDate.localeCompare(b.targetDate));
  if(!p.length){c.innerHTML='<div class="emptyBox"><div class="eIcon">üìö</div><div class="eTxt">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π</div></div>';return}
  c.innerHTML=p.map(h=>{
    let photos='';
    if(h.photos&&h.photos.length){
      photos='<div class="hwPhotos">'+h.photos.map(p=>`<img src="${p}" onclick="viewImg('${p}')">`).join('')+'</div>';
    }
    return`<div class="hwCard"><div class="hwSubj">üìñ ${esc(h.subject)}</div><div class="hwDue">üìÖ ${fFull(pk(h.targetDate))}, –ø–∞—Ä–∞ ${h.targetPair||'?'}</div><div class="hwTask">${esc(h.task)}</div>${photos}<div class="hwActs"><button class="btnP" style="padding:8px 14px;font-size:13px;width:auto" onclick="tNH('${h.id}')">‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>${isA?`<button class="btnD" style="padding:8px 14px;font-size:13px;width:auto" onclick="dNH('${h.id}')">–£–¥–∞–ª–∏—Ç—å</button>`:''}</div></div>`;
  }).join('');
}

/* SUBJECTS */
function rSubj(){
  const c=document.getElementById('sjList');
  if(!sj.length){c.innerHTML='<div class="emptyBox"><div class="eIcon">üìñ</div><div class="eTxt">–î–æ–±–∞–≤—å—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã</div></div>';return}
  c.innerHTML=sj.sort((a,b)=>a.name.localeCompare(b.name)).map(s=>`<div class="sjRow"><div class="sjIcon">üìñ</div><div class="sjInfo"><div class="sjN">${esc(s.name)}</div><div class="sjM">${s.room?'üìç '+esc(s.room):''}${s.teacher?' ¬∑ üë§ '+esc(s.teacher):''}</div></div><div style="display:flex;gap:4px"><button class="miniBtn bl" onclick="editSj('${s.id}')">‚úèÔ∏è</button><button class="miniBtn rd" onclick="rmSj('${s.id}')">‚úï</button></div></div>`).join('');
}

function rChg(){
  const c=document.getElementById('chgList'),tk=fk(new Date());
  const f=ch.filter(x=>x.date>=tk).sort((a,b)=>a.date.localeCompare(b.date));
  if(!f.length){c.innerHTML='<div class="emptyBox"><div class="eIcon">üîÑ</div><div class="eTxt">–ù–µ—Ç –∑–∞–º–µ–Ω</div></div>';return}
  c.innerHTML=f.map(x=>{
    let ls='';if(x.lessons){for(let p=1;p<=5;p++){const l=x.lessons[p];if(l&&l.name)ls+=`<div class="chgLesson"><span class="clN">${p}</span><div><div style="font-weight:700;font-size:14px">${esc(l.name)}</div><div style="font-size:12px;color:var(--t3)">${l.room?'üìç '+esc(l.room):''}${l.teacher?' ¬∑ üë§ '+esc(l.teacher):''}</div></div></div>`}}
    if(!ls)ls='<div style="padding:8px;color:var(--t3);font-size:13px">–í—Å–µ –ø–∞—Ä—ã —Å–Ω—è—Ç—ã</div>';
    return`<div class="chgCard"><div class="chHead"><span class="chDate">üìÖ ${fFull(pk(x.date))}</span><div style="display:flex;gap:4px"><button class="miniBtn bl" onclick="editChg('${x.id}')">‚úèÔ∏è</button><button class="miniBtn rd" onclick="rmChgId('${x.id}')">‚úï</button></div></div>${ls}</div>`;
  }).join('');
}

/* PHOTO UPLOAD */
function addPhotos(input,containerId){
  const files=Array.from(input.files);
  files.forEach(f=>{
    if(f.size>5*1024*1024){alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5MB)');return}
    const reader=new FileReader();
    reader.onload=e=>{
      const data=e.target.result;
      if(!uploadedPhotos[containerId])uploadedPhotos[containerId]=[];
      uploadedPhotos[containerId].push(data);
      renderPhotoPreview(containerId);
    };
    reader.readAsDataURL(f);
  });
  input.value='';
}

function renderPhotoPreview(containerId){
  const c=document.getElementById(containerId);
  if(!uploadedPhotos[containerId])uploadedPhotos[containerId]=[];
  c.innerHTML=uploadedPhotos[containerId].map((p,i)=>`<div class="ppItem"><img src="${p}"><button class="ppRm" onclick="rmPhoto('${containerId}',${i})">‚úï</button></div>`).join('');
}

function rmPhoto(containerId,idx){
  uploadedPhotos[containerId].splice(idx,1);
  renderPhotoPreview(containerId);
}

/* CUSTOM SELECT */
function bCS(cid,sid,cb){
  const c=document.getElementById(cid),sr=[...sj].sort((a,b)=>a.name.localeCompare(b.name)),sel=sr.find(s=>s.id===sid);
  csS[cid]={selectedId:sid||'',onChange:cb};
  let trig;if(sel)trig=`<span class="csI">üìñ</span><div class="csTxt"><div class="csN">${esc(sel.name)}</div><div class="csM">${sel.room?'üìç '+esc(sel.room):''}${sel.teacher?' ¬∑ üë§ '+esc(sel.teacher):''}</div></div>`;else trig=`<span class="csPh">‚Äî –ù–µ—Ç –ø–∞—Ä—ã ‚Äî</span>`;
  const opts=sr.map(s=>`<div class="csOpt${s.id===sid?' on':''}" data-sid="${s.id}"><span class="coI">üìñ</span><div><div class="coN">${esc(s.name)}</div><div class="coM">${s.room?'üìç '+esc(s.room):''}${s.teacher?' ¬∑ üë§ '+esc(s.teacher):''}</div></div></div>`).join('');
  c.innerHTML=`<div class="csWrap"><div class="csTrig" data-cid="${cid}">${trig}<span class="csArr">‚ñº</span></div><div class="csDd" id="${cid}-dd"><div class="csOpt emp" data-sid=""><span class="coI">‚úï</span><div><div class="coN" style="color:var(--t3)">‚Äî –ù–µ—Ç ‚Äî</div></div></div>${opts}</div></div>`;
  c.querySelector('.csTrig').addEventListener('click',e=>{e.stopPropagation();const dd=document.getElementById(cid+'-dd'),tr=c.querySelector('.csTrig'),wo=dd.classList.contains('open');closeCS();if(!wo){dd.classList.add('open');tr.classList.add('open')}});
  c.querySelectorAll('.csOpt').forEach(o=>{o.addEventListener('click',e=>{e.stopPropagation();const id=o.dataset.sid,sub=id?sj.find(s=>s.id===id):null;csS[cid].selectedId=id;const tr=c.querySelector('.csTrig');if(sub)tr.innerHTML=`<span class="csI">üìñ</span><div class="csTxt"><div class="csN">${esc(sub.name)}</div><div class="csM">${sub.room?'üìç '+esc(sub.room):''}${sub.teacher?' ¬∑ üë§ '+esc(sub.teacher):''}</div></div><span class="csArr">‚ñº</span>`;else tr.innerHTML=`<span class="csPh">‚Äî –ù–µ—Ç –ø–∞—Ä—ã ‚Äî</span><span class="csArr">‚ñº</span>`;c.querySelectorAll('.csOpt').forEach(x=>x.classList.remove('on'));o.classList.add('on');closeCS();if(csS[cid].onChange)csS[cid].onChange(id,sub)})});
}
function closeCS(){document.querySelectorAll('.csDd.open').forEach(d=>d.classList.remove('open'));document.querySelectorAll('.csTrig.open').forEach(t=>t.classList.remove('open'))}
function gcs(id){return csS[id]?.selectedId||''}
document.addEventListener('click',()=>closeCS());

/* LESSON SHEET */
function openLM(day,pair,week){if(!isA)return;document.getElementById('elD').value=day;document.getElementById('elP').value=pair;document.getElementById('elW').value=week;const l=sc[week]?.[day]?.[pair]||{};let sid='';if(l.name){const s=sj.find(x=>x.name===l.name);if(s)sid=s.id}bCS('elSel',sid,null);openS('shLesson')}
function svLesson(){if(!isA)return;const d=document.getElementById('elD').value,p=document.getElementById('elP').value,w=document.getElementById('elW').value,sid=gcs('elSel'),sub=sj.find(s=>s.id===sid);if(sub)db.ref(`schedule/${w}/${d}/${p}`).set({name:sub.name,room:sub.room||'',teacher:sub.teacher||''});else db.ref(`schedule/${w}/${d}/${p}`).remove();closeS('shLesson')}
function rmLesson(){if(!isA)return;db.ref(`schedule/${document.getElementById('elW').value}/${document.getElementById('elD').value}/${document.getElementById('elP').value}`).remove();closeS('shLesson')}

/* HW INLINE */
function openHwI(dk,p,s){if(!isA)return;document.getElementById('hiD').value=dk;document.getElementById('hiP').value=p;document.getElementById('hiS').value=s;document.getElementById('hiT').value='';uploadedPhotos.hiPhotos=[];renderPhotoPreview('hiPhotos');openS('shHwI')}
function svHwI(){if(!isA)return;const t=document.getElementById('hiT').value.trim();if(!t){alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ');return}const data={date:document.getElementById('hiD').value,pair:parseInt(document.getElementById('hiP').value),subject:document.getElementById('hiS').value,task:t,done:false,created:new Date().toISOString()};if(uploadedPhotos.hiPhotos.length)data.photos=uploadedPhotos.hiPhotos;db.ref('homework').push(data);closeS('shHwI')}
function tHw(id){const h=hw.find(x=>x.id===id);if(h)db.ref(`homework/${id}/done`).set(!h.done)}
function dHw(id){if(!isA)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`homework/${id}`).remove()}

/* NEW HW */
function openNewHw(){if(!isA)return;bCS('nhSel','',(_,sub)=>{const info=document.getElementById('nhNext');if(sub&&sub.name){const n=findNx(sub.name);if(n)info.innerHTML=`<span style="color:var(--blue);font-weight:700">üìÖ ${fFull(pk(n.date))}</span>, –ø–∞—Ä–∞ ${n.pair}`;else info.innerHTML='<span style="color:var(--red)">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</span>'}else info.textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç'});document.getElementById('nhT').value='';document.getElementById('nhNext').textContent='–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç';uploadedPhotos.nhPhotos=[];renderPhotoPreview('nhPhotos');openS('shNewHw')}
function svNewHw(){if(!isA)return;const sid=gcs('nhSel'),sub=sj.find(s=>s.id===sid);if(!sub){alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç');return}const t=document.getElementById('nhT').value.trim();if(!t){alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ');return}const n=findNx(sub.name);if(!n){alert('–ü–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');return}const data={subject:sub.name,task:t,targetDate:n.date,targetPair:n.pair,done:false,created:new Date().toISOString()};if(uploadedPhotos.nhPhotos.length)data.photos=uploadedPhotos.nhPhotos;db.ref('newHomework').push(data);closeS('shNewHw')}
function tNH(id){const h=nh.find(x=>x.id===id);if(h)db.ref(`newHomework/${id}/done`).set(!h.done)}
function dNH(id){if(!isA)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`newHomework/${id}`).remove()}

/* SUBJECTS */
function openSjM(eid){document.getElementById('sjId').value=eid||'';document.getElementById('sjN').value='';document.getElementById('sjR').value='';document.getElementById('sjTch').value='';document.getElementById('sjTitle').textContent=eid?'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å':'–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç';if(eid){const s=sj.find(x=>x.id===eid);if(s){document.getElementById('sjN').value=s.name||'';document.getElementById('sjR').value=s.room||'';document.getElementById('sjTch').value=s.teacher||''}}openS('shSubj')}
function editSj(id){openSjM(id)}
function svSubj(){const id=document.getElementById('sjId').value,n=document.getElementById('sjN').value.trim(),r=document.getElementById('sjR').value.trim(),t=document.getElementById('sjTch').value.trim();if(!n){alert('–ù–∞–∑–≤–∞–Ω–∏–µ');return}if(id)db.ref(`subjects/${id}`).set({name:n,room:r,teacher:t});else db.ref('subjects').push({name:n,room:r,teacher:t});closeS('shSubj')}
function rmSj(id){if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`subjects/${id}`).remove()}

/* CHANGES */
function openChgM(eid){if(!isA)return;document.getElementById('ceId').value=eid||'';document.getElementById('ceDel').style.display=eid?'':'none';document.getElementById('ceDate').value='';let h='';for(let i=1;i<=5;i++)h+=`<div class="cpBlk"><div class="cpHead"><span class="cpN">${i}</span><span style="font-size:14px;font-weight:600;color:var(--t2)">–ø–∞—Ä–∞</span></div><div id="cs-c${i}"></div></div>`;document.getElementById('cePairs').innerHTML=h;for(let i=1;i<=5;i++)bCS(`cs-c${i}`,'',null);if(eid){const c=ch.find(x=>x.id===eid);if(c){document.getElementById('ceDate').value=c.date;if(c.lessons){for(let i=1;i<=5;i++){const l=c.lessons[i];if(l&&l.name){const s=sj.find(x=>x.name===l.name);if(s)bCS(`cs-c${i}`,s.id,null)}}}}}openS('shChg')}
function editChg(id){openChgM(id)}
function svChg(){if(!isA)return;const eid=document.getElementById('ceId').value,date=document.getElementById('ceDate').value;if(!date){alert('–î–∞—Ç–∞');return}const les={};let any=false;for(let i=1;i<=5;i++){const sid=gcs(`cs-c${i}`),sub=sj.find(s=>s.id===sid);if(sub){les[i]={name:sub.name,room:sub.room||'',teacher:sub.teacher||''};any=true}}if(eid)db.ref(`changes/${eid}`).set({date,lessons:any?les:null});else db.ref('changes').push({date,lessons:any?les:null});closeS('shChg')}
function rmChg(){const id=document.getElementById('ceId').value;if(id){rmChgId(id);closeS('shChg')}}
function rmChgId(id){if(!isA)return;if(confirm('–£–¥–∞–ª–∏—Ç—å?'))db.ref(`changes/${id}`).remove()}

/* TIMES */
function openTimesM(){if(!isA)return;document.getElementById('timesF').innerHTML=cf.pairTimes.map((t,i)=>`<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px"><span style="min-width:50px;font-weight:700;font-size:14px">${i+1} –ø–∞—Ä–∞</span><input type="time" class="inp" id="ts${i}" value="${t.start}" style="flex:1;margin:0;padding:12px"><span style="color:var(--t3)">‚Äî</span><input type="time" class="inp" id="te${i}" value="${t.end}" style="flex:1;margin:0;padding:12px"></div>`).join('');openS('shTimes')}
function svTimes(){if(!isA)return;const t=[];for(let i=0;i<5;i++)t.push({start:document.getElementById(`ts${i}`).value,end:document.getElementById(`te${i}`).value});db.ref('settings/pairTimes').set(t);closeS('shTimes')}

function clearAll(){if(!isA)return;if(confirm('–£–¥–∞–ª–∏—Ç—å –í–°–Å?')){db.ref('schedule').remove();db.ref('homework').remove();db.ref('newHomework').remove();db.ref('changes').remove();db.ref('subjects').remove()}}

/* SHEETS */
function openS(id){document.getElementById(id).classList.add('open')}
function closeS(id){document.getElementById(id).classList.remove('open')}
document.querySelectorAll('.sheet').forEach(s=>{s.addEventListener('click',e=>{if(e.target===s)s.classList.remove('open')})});

/* KEYS */
document.getElementById('iPass').addEventListener('keypress',e=>{if(e.key==='Enter')doLogin()});
document.getElementById('iEmail').addEventListener('keypress',e=>{if(e.key==='Enter')document.getElementById('iPass').focus()});

/* SWIPE */
let tx=0;
document.addEventListener('touchstart',e=>{tx=e.touches[0].clientX},{passive:true});
document.addEventListener('touchend',e=>{if(!document.getElementById('pgSched').classList.contains('on'))return;const dx=e.changedTouches[0].clientX-tx;if(Math.abs(dx)>70){if(dx<0&&sD<5){sD++;rStrip();render()}else if(dx>0&&sD>0){sD--;rStrip();render()}}});
</script>
</body>
</html>
